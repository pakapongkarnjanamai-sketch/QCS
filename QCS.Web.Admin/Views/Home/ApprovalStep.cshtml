@{
    ViewData["Title"] = "Approval Steps";
}

<div class="card m-3">
    <div class="card-header">
        <h5 class="mb-0">ลำดับการอนุมัติ (Approval Steps)</h5>
    </div>
    <div class="card-body">
        <div id="gridApproval"></div>
    </div>
</div>

@section Scripts {
    <script>
        const API_BASE_URL = "https://localhost:7127/api/";
        const CONTROLLER_NAME = "CRUDApprovalSteps";

        // Lookup สำหรับสถานะ (Int -> String)
        const statusLookup = [
            { id: 1, name: "Pending" },
            { id: 2, name: "Approved" },
            { id: 3, name: "Rejected" }
        ];

        $(function () {
            // Store สำหรับดึงข้อมูล PR (เลขที่เอกสาร) มาแสดงใน Dropdown
            const prLookupStore = DevExpress.data.AspNet.createStore({
                key: "id", // Key ของ PR เป็นตัวพิมพ์เล็ก
                loadUrl: API_BASE_URL + "CRUDPurchaseRequests",
                onBeforeSend: function(method, ajaxOptions) {
                    ajaxOptions.xhrFields = { withCredentials: true };
                }
            });

            $("#gridApproval").dxDataGrid({
                // Store หลักของหน้า Approval Steps
                   dataSource: createDataStore(API_BASE_URL, CONTROLLER_NAME),
                remoteOperations: true,
                showBorders: true,
                rowAlternationEnabled: true,

                // Features
                filterRow: { visible: true },
                headerFilter: { visible: true },
                searchPanel: { visible: true },
                sorting: { mode: "multiple" },

                // Editing Config
                editing: {
                    mode: "row",
                    allowAdding: true,
                    allowUpdating: true,
                    allowDeleting: true,
                    useIcons: true
                },

                // Column Definitions (camelCase ตาม JSON)
                columns: [
                    {
                        dataField: "purchaseRequestId",
                        caption: "เอกสารใบขอซื้อ",
                        width: 200,
                        validationRules: [{ type: "required" }],
                        lookup: {
                            dataSource: prLookupStore,
                            valueExpr: "id",
                            displayExpr: "code" // ใช้ 'code' ตาม JSON ของ PR เพื่อโชว์เลขที่เอกสาร
                        }
                    },
                    {
                        dataField: "sequence",
                        caption: "ลำดับ",
                        dataType: "number",
                        width: 80,
                        sortOrder: "asc", // บังคับเรียงตามลำดับเสมอ
                        validationRules: [{ type: "required" }]
                    },
                    {
                        dataField: "approverName",
                        caption: "ชื่อผู้อนุมัติ",
                        validationRules: [{ type: "required" }]
                    },
                    {
                        dataField: "role",
                        caption: "ตำแหน่ง",
                        validationRules: [{ type: "required" }]
                    },
                    {
                        dataField: "status",
                        caption: "สถานะ",
                        width: 120,
                        lookup: {
                            dataSource: statusLookup,
                            valueExpr: "id",
                            displayExpr: "name"
                        },
                        cellTemplate: function(element, info) {
                            let statusName = info.displayValue || "Unknown";
                            let colorClass = "badge bg-secondary"; // Default

                            if (info.value === 2) colorClass = "badge bg-success"; // Approved
                            else if (info.value === 3) colorClass = "badge bg-danger"; // Rejected
                            else if (info.value === 1) colorClass = "badge bg-warning text-dark"; // Pending

                            element.append(`<span class="${colorClass}">${statusName}</span>`);
                        }
                    },
                    {
                        dataField: "actionDate",
                        caption: "วันที่อนุมัติ",
                        dataType: "datetime",
                        format: "dd/MM/yyyy HH:mm",
                        width: 160,
                        allowEditing: false // ปกติวันที่อนุมัติควรอ่านอย่างเดียว (ระบบอัปเดตเอง)
                    },
                    {
                        dataField: "comment",
                        caption: "ความเห็น",
                        visible: false, // ซ่อนใน Grid ปกติ (เปิดดูใน Form หรือขยายดูได้)
                        formItem: { visible: true, editorType: "dxTextArea", editorOptions: { height: 60 } }
                    }
                ]
            });
        });
    </script>
}