@{
    ViewData["Title"] = "Purchase Request";
}

<div class="card m-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">รายการใบขอซื้อ (Purchase Requests)</h5>
    </div>
    <div class="card-body">
        <div id="gridPR"></div>
    </div>
</div>

@section Scripts {
    <script>
        // ใช้ Port 7127 ตามที่คุณระบุ
        const API_BASE_URL = "https://localhost:7127/api/";
        const CONTROLLER_NAME = "CRUDPurchaseRequests";

        // กำหนดรายการสถานะสำหรับการแปลงค่าตัวเลข (Int) เป็นข้อความ
        // 0=Draft, 1=Pending, 2=Approved, 3=Rejected, 4=Completed (สมมติลำดับตามมาตรฐาน)
        const statusLookup = [
            { id: 0, name: "Draft" },
            { id: 1, name: "Pending" },
            { id: 2, name: "Approved" },
            { id: 3, name: "Rejected" },
            { id: 4, name: "Completed" }
        ];

        $(function () {
            $("#gridPR").dxDataGrid({
               dataSource: createDataStore(API_BASE_URL, CONTROLLER_NAME),
                remoteOperations: true,
                showBorders: true,
                rowAlternationEnabled: true,
                columnAutoWidth: true,
                hoverStateEnabled: true,
                paging: { pageSize: 10 },
                pager: { showPageSizeSelector: true, allowedPageSizes: [10, 20, 50], showInfo: true },
                filterRow: { visible: true },
                searchPanel: { visible: true, width: 240, placeholder: "ค้นหา..." },

                // การแก้ไขข้อมูล (Popup)
                editing: {
                    mode: "popup",
                    allowAdding: true,
                    allowUpdating: true,
                    allowDeleting: true,
                    useIcons: true,
                    popup: {
                        title: "ข้อมูลใบขอซื้อ",
                        showTitle: true,
                        width: 750,
                        height: 550
                    },
                    form: {
                        items: [
                            { itemType: "group", caption: "ข้อมูลหลัก", colCount: 2, items: ["code", "requestDate"] },
                            { itemType: "group", caption: "รายละเอียด", colCount: 1, items: ["title", "vendorName", "status", "comment"] }
                        ]
                    }
                },

                // กำหนด Columns ให้ตรงกับ JSON Response
                columns: [
                    {
                        dataField: "id",
                        visible: false,
                        allowEditing: false,
                        formItem: { visible: false }
                    },
                    {
                        dataField: "code", // ตรงกับ JSON (แทน PRNumber)
                        caption: "เลขที่เอกสาร",
                        width: 150,
                        validationRules: [{ type: "required", message: "กรุณาระบุเลขที่เอกสาร" }]
                    },
                    {
                        dataField: "title", // ตรงกับ JSON
                        caption: "หัวข้อการจัดซื้อ",
                        validationRules: [{ type: "required", message: "กรุณาระบุหัวข้อ" }]
                    },
                    {
                        dataField: "requestDate", // ตรงกับ JSON
                        caption: "วันที่ขอ",
                        dataType: "date",
                        format: "dd/MM/yyyy",
                        width: 120,
                        validationRules: [{ type: "required" }]
                    },
                    {
                        dataField: "vendorName", // ตรงกับ JSON
                        caption: "ผู้ขาย (Vendor)",
                        visible: true
                    },
                    {
                        dataField: "status", // ตรงกับ JSON (ค่ามาเป็นตัวเลข 1)
                        caption: "สถานะ",
                        width: 120,
                        lookup: {
                            dataSource: statusLookup,
                            valueExpr: "id",
                            displayExpr: "name"
                        },
                        cellTemplate: function(element, info) {
                            // แสดง Badge สีตามสถานะ
                            let statusName = info.displayValue || "Unknown";
                            let statusId = info.value;

                            let colorClass = "badge bg-secondary"; // Default (Draft/0)
                            if (statusId === 1) colorClass = "badge bg-warning text-dark"; // Pending
                            else if (statusId === 2 || statusId === 4) colorClass = "badge bg-success"; // Approved/Completed
                            else if (statusId === 3) colorClass = "badge bg-danger"; // Rejected

                            element.append(`<span class="${colorClass}">${statusName}</span>`);
                        }
                    },
                    {
                        dataField: "comment", // ตรงกับ JSON (แทน Description)
                        caption: "รายละเอียดเพิ่มเติม",
                        visible: false,
                        editorType: "dxTextArea",
                        editorOptions: { height: 80 }
                    }
                ],

                onRowDblClick: function(e) {
                    if (e.data && e.data.id) {
                        window.location.href = '@Url.Action("Detail", "PurchaseRequest")/' + e.data.id;
                    }
                }
            });
        });
    </script>
}