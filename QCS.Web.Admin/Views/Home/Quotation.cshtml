@{
    ViewData["Title"] = "Quotation Management";
}

<div class="card m-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">จัดการข้อมูล Quotation</h5>
    </div>
    <div class="card-body">
        <div id="grid"></div>
    </div>
</div>

@section Scripts {
    <script>
        // ใช้ Port 7127 ตามการตั้งค่า Backend
        const API_BASE_URL = "https://localhost:7127/api/";
        const CONTROLLER_NAME = "CRUDQuotations";

        $(function () {
            $("#grid").dxDataGrid({
                // เชื่อมต่อ API
                dataSource: createDataStore(API_BASE_URL, CONTROLLER_NAME),
                remoteOperations: true,
                showBorders: true,
                columnAutoWidth: true,
                rowAlternationEnabled: true,
                hoverStateEnabled: true,

                // Filter & Search
                filterRow: { visible: true },
                searchPanel: { visible: true, width: 240, placeholder: "ค้นหา..." },
                paging: { pageSize: 10 },
                pager: { showPageSizeSelector: true, allowedPageSizes: [10, 20, 50], showInfo: true },

                // Editing (Popup Mode)
                editing: {
                    mode: "popup",
                    allowAdding: false,
                    allowUpdating: false,
                    allowDeleting: false,
                    useIcons: true,
                    popup: {
                        title: "ข้อมูลใบเสนอราคา (Quotation)",
                        showTitle: true,
                        width: 700,
                        height: 450
                    },
                    
                },

                // Columns Definition (ใช้ camelCase ตาม JSON API)
                columns: [
                    {
                        dataField: "id",
                        visible: false,
                        allowEditing: false,
                        formItem: { visible: false }
                    },
                    {
                        dataField: "purchaseRequestId",
                        caption: "อ้างอิงใบขอซื้อ (PR No.)",
                        width: 180,
                        validationRules: [{ type: "required" }],
                        lookup: {
                            // ดึงข้อมูล PR มาแสดงใน Dropdown
                            dataSource: DevExpress.data.AspNet.createStore({
                                key: "id",
                                loadUrl: API_BASE_URL + "CRUDPurchaseRequests",
                                onBeforeSend: function(method, ajaxOptions) {
                                    ajaxOptions.xhrFields = { withCredentials: true };
                                }
                            }),
                            valueExpr: "id",
                            displayExpr: "code" // แสดงเลขที่เอกสาร (code) แทน ID
                        }
                    },
           
                    {
                        dataField: "fileName", // ชื่อฟิลด์ตามที่เห็นใน Create.cshtml
                        caption: "ไฟล์แนบ",
                        allowEditing: false,
                        cellTemplate: function(container, options) {
                            if(options.data.filePath) {
                                // แปลง Path ให้เป็น URL ที่ถูกต้อง (เปลี่ยน \ เป็น /)
                                let cleanPath = options.data.filePath.replace(/\\/g, "/");
                                let fileUrl = "https://localhost:7127/" + cleanPath;

                                $("<a>")
                                    .attr("href", fileUrl)
                                    .attr("target", "_blank")
                                    .addClass("d-flex align-items-center text-decoration-none")
                                    .append($("<i>").addClass("fas fa-file-pdf text-danger me-2"))
                                    .append($("<span>").text(options.value || "Download"))
                                    .appendTo(container);
                            } else {
                                $("<span>").text("-").appendTo(container);
                            }
                        }
                    }
                ]
            });
        });
    </script>
}