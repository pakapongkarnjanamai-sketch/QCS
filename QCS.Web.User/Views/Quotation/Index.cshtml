@model string

@{
    // แสดงเลขที่เอกสารต่อท้าย Title
    ViewData["Title"] = $"{Model}";
    Layout = "_NoNavLayout";
}

@section Styles {
    <style>
        /* --- Layout & Container --- */
        .quotation-details-container {
            width: 100%;
            margin: 20px auto;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: 1fr 450px; /* Left: Viewer, Right: Info */
            gap: 20px;
            height: calc(100vh - 140px);
            min-height: 700px;
        }

        /* --- Left: PDF Viewer --- */
        .pdf-viewer-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .document-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .document-title {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .control-button {
            padding: 6px 12px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            color: #555;
            transition: 0.2s;
        }

            .control-button:hover {
                background: #e9ecef;
            }

        .pdf-viewer-container {
            flex: 1;
            width: 100%;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #525659;
            position: relative;
            overflow: hidden;
        }

        .loading-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #bbb;
        }

        .error-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #dc3545;
            font-weight: 600;
        }

        /* --- Right: Info Section --- */
        .info-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: 100%;
            overflow-y: auto;
            padding-right: 5px; /* Prevent scrollbar overlap */
        }

        .card-box {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            flex-shrink: 0; /* Prevent shrinking */
        }

        .section-header {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #f1f3f5;
            padding-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- Document List --- */
        .document-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
        }

            .document-item:hover {
                background-color: #f8f9fa;
                border-color: #2190F7;
            }

            .document-item.active {
                background-color: #e3f2fd;
                border-color: #2190F7;
            }

        .document-icon {
            font-size: 20px;
            color: #2190F7;
            margin-right: 12px;
            margin-top: 3px;
        }

        .document-info {
            flex: 1;
            overflow: hidden;
        }

        .document-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .document-type-badge {
            display: inline-block;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: #e9ecef;
            color: #495057;
            margin-right: 5px;
            font-weight: 600;
        }

        .document-meta {
            font-size: 11px;
            color: #888;
        }

        /* --- Approval Timeline --- */
        .timeline {
            position: relative;
            padding-left: 20px;
            margin-top: 10px;
        }

            .timeline::before {
                content: '';
                position: absolute;
                left: 6px;
                top: 5px;
                bottom: 5px;
                width: 2px;
                background: #e9ecef;
            }

        .timeline-item {
            position: relative;
            padding-bottom: 20px;
        }

            .timeline-item:last-child {
                padding-bottom: 0;
            }

        .timeline-dot {
            position: absolute;
            left: -20px;
            top: 5px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #fff;
            border: 3px solid #dee2e6;
            z-index: 1;
        }

            .timeline-dot.completed {
                border-color: #28a745;
                background: #28a745;
            }

            .timeline-dot.current {
                border-color: #ffc107;
                background: #fff;
            }

            .timeline-dot.rejected {
                border-color: #dc3545;
                background: #dc3545;
            }

        .timeline-content {
            margin-left: 10px;
        }

        .timeline-step {
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }

        .timeline-approver {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .timeline-date {
            font-size: 11px;
            color: #999;
            margin-top: 2px;
        }

        .timeline-comment {
            margin-top: 6px;
            font-size: 12px;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            border-left: 3px solid #ddd;
            color: #555;
            font-style: italic;
        }

        /* --- Badges --- */
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .status-secondary {
            background: #e2e3e5;
            color: #383d41;
        }

        /* --- Responsive --- */
        @@media screen and (max-width: 1024px) {
            .details-grid {
                grid-template-columns: 1fr;
                display: block;
            }

            .pdf-viewer-section {
                height: 500px;
                margin-bottom: 20px;
            }
        }
    </style>
}

<div class="quotation-details-container">
    <div class="details-grid">

        <div class="pdf-viewer-section">
            <div class="document-controls">
                <div class="document-title">
                    <i class="fas fa-file-alt"></i> <span id="docTitleLabel">Document Viewer</span>
                </div>
                <button class="control-button" id="btnFullscreen"><i class="fas fa-expand"></i> Fullscreen</button>
            </div>
            <div id="pdfViewer" class="pdf-viewer-container">
                <div class="loading-placeholder">
                    <i class="fas fa-search fa-2x"></i>
                    <span class="mt-2">Select a document to view</span>
                </div>
            </div>
        </div>

        <div class="info-section">

            <div class="card-box">
                <div class="section-header">
                    <span>Request Information</span>
                    <span id="headerStatus"></span>
                </div>
                <div id="requestInfoForm"></div>
            </div>

            <div class="card-box" style="min-height: 200px;">
                <div class="section-header">
                    <span>Attachments</span>
                    <span id="attachmentCount" class="badge bg-secondary rounded-pill">0</span>
                </div>
                <div id="documentList"></div>
            </div>

            <div class="card-box">
                <div class="section-header">Approval Flow</div>
                <div id="approvalList" class="timeline"></div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ==========================================
        // 1. CONFIGURATION
        // ==========================================
        const CONFIG = {
            docCode: "@Model",
            api: {
                baseUrl: API_BASE, // มั่นใจว่า API_BASE ถูกประกาศไว้ใน site.js หรือ _Layout
                endpoints: {
                    getByCode: "/PurchaseRequest/ByCode",
                    viewFile: "/PurchaseRequest/ViewFile"
                }
            },
            // Mapping Enum to Text
            maps: {
                status: { 0: "Draft", 1: "Pending", 2: "Approved", 3: "Completed", 99: "Rejected" },
                docType: { 10: "Quotation", 20: "Technical Spec", 30: "Other" }
            }
        };

        // ==========================================
        // 2. MAIN LOGIC
        // ==========================================
        $(function() {
            if (CONFIG.docCode) initPage();
            else renderError("Document Code is missing.");
        });

        async function initPage() {
            const loader = createLoadingIndicator("Loading Data...");
            try {
                // Fetch Data
                const data = await service.getData(CONFIG.docCode);

                // Render Sections
                ui.renderHeader(data);
                ui.renderForm(data);
                ui.renderDocuments(data.quotations);
                ui.renderApprovals(data.approvalSteps);

                // Auto-load first file if exists
                if (data.quotations && data.quotations.length > 0) {
                    ui.loadViewer(data.quotations[0]);
                } else {
                    ui.setViewerMsg("No files attached.");
                }

                $("#btnFullscreen").on("click", () => utils.toggleFullscreen("pdfViewer"));

            } catch (err) {
                renderError(err.message);
            } finally {
                loader.hide();
            }
        }

        // ==========================================
        // 3. SERVICE
        // ==========================================
        const service = {
            async getData(code) {
                const url = new URL(CONFIG.api.baseUrl + CONFIG.api.endpoints.getByCode);
                url.searchParams.append("code", code);

                const res = await utils.fetchJSON(url.toString());
                // API อาจ return List หรือ Object เดี่ยว ให้เช็คตรงนี้
                const list = res.data || res;
                if (!list || (Array.isArray(list) && list.length === 0)) throw new Error("Document not found.");

                return Array.isArray(list) ? list[0] : list;
            },

            getFileUrl(id) {
                return `${CONFIG.api.baseUrl}${CONFIG.api.endpoints.viewFile}/${id}`;
            }
        };

        // ==========================================
        // 4. UI RENDERING
        // ==========================================
        const ui = {

            // --- Header Status ---
            renderHeader(data) {
                const statusText = CONFIG.maps.status[data.status] || "Unknown";
                let badgeClass = "status-secondary";
                if (data.status === 1) badgeClass = "status-warning";
                if (data.status === 2 || data.status === 3) badgeClass = "status-success";
                if (data.status === 99) badgeClass = "status-danger";

                $("#headerStatus").html(`<span class="status-badge ${badgeClass}">${statusText}</span>`);
            },

            // --- Form Info (Read Only) ---
            renderForm(data) {
                $("#requestInfoForm").dxForm({
                    formData: data,
                    readOnly: true,
                    labelLocation: "top",
                    colCount: 2,
                    items: [
                        { dataField: "code", label: { text: "Request No" }, colSpan: 2 },
                        { dataField: "title", label: { text: "Title" }, colSpan: 2 },
                        { dataField: "vendorName", label: { text: "Vendor" }, colSpan: 2 },
                        {
                            dataField: "validFrom",
                            label: { text: "Valid From" },
                            editorType: "dxDateBox",
                            editorOptions: { displayFormat: "d MMM yyyy" }
                        },
                        {
                            dataField: "validUntil",
                            label: { text: "Valid Until" },
                            editorType: "dxDateBox",
                            editorOptions: { displayFormat: "d MMM yyyy" }
                        },
                        {
                            dataField: "remark",
                            label: { text: "Remark" },
                            colSpan: 2,
                            editorType: "dxTextArea",
                            editorOptions: { autoResizeEnabled: true, minHeight: 60 }
                        }
                    ]
                });
            },

            // --- Documents List ---
            renderDocuments(docs) {
                const container = $("#documentList").empty();
                $("#attachmentCount").text(docs ? docs.length : 0);

                if (!docs || docs.length === 0) {
                    container.html('<div class="text-center text-muted p-3">No files</div>');
                    return;
                }

                docs.forEach(doc => {
                    const typeName = CONFIG.maps.docType[doc.documentTypeId] || `Type ${doc.documentTypeId}`;
                    const iconClass = utils.getIcon(doc.contentType || doc.fileName);
                    const sizeStr = utils.formatSize(doc.fileSize);

                    const item = $(`
                        <div class="document-item" data-id="${doc.id}">
                            <i class="fas ${iconClass} document-icon"></i>
                            <div class="document-info">
                                <div class="document-name" title="${doc.fileName}">${doc.fileName}</div>
                                <div>
                                    <span class="document-type-badge">${typeName}</span>
                                    <span class="document-meta">${sizeStr}</span>
                                </div>
                            </div>
                        </div>
                    `);
                    item.on("click", () => ui.loadViewer(doc));
                    container.append(item);
                });
            },

            // --- Approval Timeline ---
            renderApprovals(steps) {
                const container = $("#approvalList").empty();

                if (!steps || steps.length === 0) {
                    container.html('<div class="text-center text-muted p-3">No approval history</div>');
                    return;
                }

                // Sort by Sequence
                steps.sort((a, b) => a.sequence - b.sequence);

                steps.forEach(step => {
                    let dotClass = "";
                    // Status Check: 2=Approved, 99=Rejected, 1=Current/Pending
                    if (step.status === 2) dotClass = "completed"; 
                    else if (step.status === 99) dotClass = "rejected"; 
                    else if (step.status === 1) dotClass = "current";

                    const stepStatusText = CONFIG.maps.status[step.status] || "Draft/Waiting";
                    
                    // Format Date
                    const actionDateStr = step.actionDate 
                        ? new Date(step.actionDate).toLocaleString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute:'2-digit'}) 
                        : "-";
                    
                    const approver = step.approverName || "Waiting for approver";

                    const html = `
                        <div class="timeline-item">
                            <div class="timeline-dot ${dotClass}"></div>
                            <div class="timeline-content">
                                <div class="timeline-step">Step ${step.sequence}: ${step.stepName}</div>
                                <div class="timeline-approver">
                                    <i class="fas fa-user-circle"></i> ${approver}
                                    <span style="font-size:11px; color:#aaa;">(${stepStatusText})</span>
                                </div>
                                ${step.actionDate ? `<div class="timeline-date"><i class="far fa-clock"></i> ${actionDateStr}</div>` : ''}
                                ${step.comment ? `<div class="timeline-comment">"${step.comment}"</div>` : ''}
                            </div>
                        </div>
                    `;
                    container.append(html);
                });
            },

            // --- PDF Viewer ---
            async loadViewer(doc) {
                $(".document-item").removeClass("active");
                $(`.document-item[data-id="${doc.id}"]`).addClass("active");
                $("#docTitleLabel").text(doc.fileName);

                const viewer = $("#pdfViewer").empty();
                const loader = createLoadingIndicator("Opening file...");

                try {
                    const url = service.getFileUrl(doc.id);
                    // Fetch blob with credentials
                    const res = await fetch(url, { method: 'GET', credentials: 'include' });
                    if (!res.ok) throw new Error("File not found on server");

                    const blob = await res.blob();
                    const objUrl = URL.createObjectURL(blob);
                    const type = doc.contentType || "application/pdf";

                    if (type.startsWith("image/")) {
                        $("<img>").attr("src", objUrl).css({ width: "100%", height: "100%", objectFit: "contain" }).appendTo(viewer);
                    } else {
                        // For PDF or others, try embed
                        $("<embed>").attr({ src: objUrl, type: type, width: "100%", height: "100%" }).appendTo(viewer);
                    }
                } catch (e) {
                    ui.setViewerError(e.message);
                } finally {
                    loader.hide();
                }
            },

            setViewerMsg(msg) { 
                $("#pdfViewer").html(`
                    <div class="loading-placeholder">
                        <i class="fas fa-info-circle fa-2x mb-2"></i>
                        <span>${msg}</span>
                    </div>
                `); 
            },
            setViewerError(msg) { 
                $("#pdfViewer").html(`
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle me-2"></i> ${msg}
                    </div>
                `); 
            }
        };

        // ==========================================
        // 5. UTILITIES
        // ==========================================
        const utils = {
            async fetchJSON(url) {
                const res = await fetch(url, { credentials: 'include' });
                if (!res.ok) throw new Error(`API Error: ${res.statusText}`);
                return res.json();
            },
            formatSize(b) {
                if (!b) return "0 B";
                const i = Math.floor(Math.log(b) / Math.log(1024));
                return (b / Math.pow(1024, i)).toFixed(1) + " " + ["B", "KB", "MB", "GB"][i];
            },
            getIcon(t) {
                t = (t || "").toLowerCase();
                if (t.includes('pdf')) return 'fa-file-pdf';
                if (t.includes('image')) return 'fa-file-image';
                if (t.includes('word')) return 'fa-file-word';
                if (t.includes('excel')) return 'fa-file-excel';
                return 'fa-file';
            },
            toggleFullscreen(id) {
                const el = document.getElementById(id);
                if (!document.fullscreenElement) {
                    if(el.requestFullscreen) el.requestFullscreen();
                    else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
                } else {
                    if(document.exitFullscreen) document.exitFullscreen();
                }
            }
        };

        function createLoadingIndicator(msg) {
            if (typeof DevExpress === 'undefined') return { hide: () => {} };
            let p = $("#global-loader").dxLoadPanel("instance");
            if (!p) {
                $("<div>").attr("id", "global-loader").appendTo("body").dxLoadPanel({
                    shadingColor: "rgba(0,0,0,0.4)", position: { of: window }, visible: false, showIndicator: true, showPane: true, shading: true, closeOnOutsideClick: false
                });
                p = $("#global-loader").dxLoadPanel("instance");
            }
            p.option("message", msg);
            p.show();
            return { hide: () => p.hide() };
        }

        function renderError(msg) {
            if (typeof DevExpress !== 'undefined' && DevExpress.ui) DevExpress.ui.notify(msg, "error", 4000);
            else alert(msg);
        }
    </script>
}