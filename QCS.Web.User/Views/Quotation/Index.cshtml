@{
    ViewData["Title"] = "รายการเอกสารที่อนุมัติแล้ว";
}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0"><i class="fas fa-check-circle text-success me-2"></i>รายการเอกสารที่อนุมัติแล้ว</h2>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div id="gridContainer"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            // URL ของ API
            // หมายเหตุ: ตรวจสอบ Port ของ API ให้ตรงกับที่รันจริง (เช่น localhost:7001 หรือ localhost:5000)
            // หากมีการตั้งค่า Base URL ไว้ที่ site.js หรือไฟล์อื่น สามารถเรียกใช้ตัวแปรนั้นได้เลย


            $("#gridContainer").dxDataGrid({
                dataSource: DevExpress.data.AspNet.createStore({
                    key: "id",
                    loadUrl: `${API_BASE}/PurchaseRequest/ApprovedList`,
                    onBeforeSend: function (method, ajaxOptions) {
                        // หากมีการใช้ Token Auth ให้แนบ Header ตรงนี้
                        // ajaxOptions.headers = { "Authorization": "Bearer " + localStorage.getItem("token") };
                        ajaxOptions.xhrFields = { withCredentials: true };
                    }
                }),
                showBorders: true,
                remoteOperations: false, // โหลดมาทั้งหมดแล้ว Filter Client-side เพราะข้อมูลอาจไม่เยอะมาก
                paging: {
                    pageSize: 10
                },
                pager: {
                    showPageSizeSelector: true,
                    allowedPageSizes: [10, 25, 50, 100],
                    showInfo: true
                },
                filterRow: { visible: true },
                searchPanel: { visible: true, width: 240, placeholder: "ค้นหา..." },
                headerFilter: { visible: true },
                columns: [
                    {
                        dataField: "code",
                        caption: "เลขที่เอกสาร",
                        width: 150,
                        sortOrder: "desc"
                    },
                    {
                        dataField: "title",
                        caption: "หัวข้อ/รายการ",
                    },
                    {
                        dataField: "vendorName",
                        caption: "ผู้ขาย (Vendor)",
                        width: 200
                    },
                    {
                        dataField: "requestDate",
                        caption: "วันที่ขอ",
                        dataType: "date",
                        format: "dd/MM/yyyy",
                        width: 120
                    },
                    {
                        dataField: "status",
                        caption: "สถานะ",
                        width: 130,
                        alignment: "center",
                        cellTemplate: function (container, options) {
                            // Status 2 = Approved, 3 = Completed
                            let text = "อนุมัติแล้ว";
                            let colorClass = "badge bg-success";

                            if (options.value == 3) {
                                text = "จบกระบวนการ";
                                colorClass = "badge bg-primary";
                            }

                            $("<span>")
                                .addClass(colorClass)
                                .text(text)
                                .appendTo(container);
                        }
                    },
                            {
            type: "buttons",
            width: 100,
            buttons: [{
                hint: "ดูรายละเอียด",
                icon: "find",
                onClick: function (e) {
                    // === แก้ไขตรงนี้ให้ไปที่ Action Detail ===
                    window.location.href = '@Url.Action("Detail", "Request")/' + e.row.data.id;
                }
            }]
        }
                ]
            });
        });
    </script>
}