@model string

@{
    ViewData["Title"] = $"{Model}";
    Layout = "_NoNavLayout";
}

@section Styles {
    <style>
        /* --- Layout --- */
        .viewer-container {
            display: grid;
            grid-template-columns: 1fr 400px; /* ขยายส่วน PDF ลดส่วน Info */
            gap: 20px;
            height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        /* --- Left: PDF Viewer --- */
        .pdf-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .pdf-toolbar {
            padding: 12px 15px;
            background: #fff;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pdf-title {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pdf-body {
            flex: 1;
            background: #525659; /* สีพื้นหลังมาตรฐาน PDF Viewer */
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pdf-placeholder {
            color: #ccc;
            text-align: center;
        }

        /* --- Right: Info Panel --- */
        .info-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
            overflow-y: auto;
            padding-right: 5px; /* For Scrollbar */
        }

        .info-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }

        .card-header-text {
            font-size: 15px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #f1f3f5;
            padding-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- File List Item --- */
        .file-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #f1f3f5;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
        }

            .file-item:hover {
                background-color: #f8f9fa;
                border-color: #2190F7;
                transform: translateX(2px);
            }

            .file-item.active {
                background-color: #e3f2fd;
                border-color: #2190F7;
            }

        .file-icon {
            font-size: 24px;
            color: #f05b41; /* Adobe Red */
            margin-right: 15px;
        }

        .file-details {
            flex: 1;
            overflow: hidden;
        }

        .file-name {
            font-weight: 600;
            font-size: 13px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-meta {
            font-size: 11px;
            color: #888;
            margin-top: 2px;
        }

        /* --- Timeline (Clean Design) --- */
        .timeline {
            position: relative;
            padding-left: 25px;
            margin-top: 10px;
        }

            .timeline::before {
                content: '';
                position: absolute;
                left: 8px;
                top: 5px;
                bottom: 5px;
                width: 2px;
                background: #e9ecef;
            }

        .timeline-item {
            position: relative;
            padding-bottom: 25px;
        }

            .timeline-item:last-child {
                padding-bottom: 0;
            }

        .timeline-dot {
            position: absolute;
            left: -25px;
            top: 4px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #fff;
            border: 3px solid #dee2e6;
            z-index: 1;
        }

            .timeline-dot.completed {
                border-color: #28a745;
                background: #28a745;
            }

            .timeline-dot.current {
                border-color: #ffc107;
                background: #fff;
            }

            .timeline-dot.rejected {
                border-color: #dc3545;
                background: #dc3545;
            }

        .timeline-step {
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }

        .timeline-user {
            font-size: 12px;
            color: #555;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 2px;
        }

        .timeline-date {
            font-size: 11px;
            color: #999;
            margin-top: 2px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .timeline-comment {
            margin-top: 8px;
            font-size: 12px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid #ddd;
            color: #555;
            font-style: italic;
        }

        /* --- Badges --- */
        .status-badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        .bg-success-soft {
            background: #d4edda;
            color: #155724;
        }

        .bg-warning-soft {
            background: #fff3cd;
            color: #856404;
        }

        .bg-danger-soft {
            background: #f8d7da;
            color: #721c24;
        }

        .bg-secondary-soft {
            background: #e2e3e5;
            color: #383d41;
        }

        /* Responsive */
        @@media (max-width: 1024px) {
            .viewer-container {
                grid-template-columns: 1fr;
                height: auto;
                overflow-y: auto;
            }

            .pdf-section {
                height: 500px;
            }

            .info-section {
                height: auto;
                overflow: visible;
            }
        }
    </style>
}

<div class="viewer-container">

    <div class="pdf-section">
        <div class="pdf-toolbar">
            <div class="pdf-title">
                <i class="fas fa-file-alt text-primary"></i>
                <span id="docTitleLabel">Document Viewer</span>
            </div>
            <button class="btn btn-sm btn-outline-secondary" id="btnFullscreen">
                <i class="fas fa-expand"></i> Fullscreen
            </button>
        </div>
        <div id="pdfViewer" class="pdf-body">
            <div class="pdf-placeholder">
                <i class="fas fa-search fa-3x mb-3 opacity-50"></i>
                <div>Select a document to view</div>
            </div>
        </div>
    </div>

    <div class="info-section">

        <div class="info-card">
            <div class="card-header-text">
                <span>Request Info</span>
                <span id="headerStatus"></span>
            </div>
            <div id="requestInfoForm"></div>
        </div>

        <div class="info-card" style="min-height: 200px;">
            <div class="card-header-text">
                <span>Attachments</span>
                <span id="attachmentCount" class="badge bg-secondary rounded-pill">0</span>
            </div>
            <div id="documentList"></div>
        </div>

        <div class="info-card">
            <div class="card-header-text">Approval Flow</div>
            <div id="approvalList" class="timeline"></div>
        </div>

    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            // ==========================================
            // 1. CONFIG
            // ==========================================
            const DOC_CODE = "@Model";
            const API = {
                GET_DATA: `${API_BASE}/PurchaseRequest/ByCode`,
                VIEW_FILE: `${API_BASE}/PurchaseRequest/ViewFile`
            };
            const MAPS = {
                status: { 0: "Draft", 1: "Pending", 2: "Approved", 3: "Completed", 99: "Rejected" },
                docType: { 10: "Quotation", 20: "Technical Spec", 30: "Other" }
            };

            // ==========================================
            // 2. INIT
            // ==========================================
            if (DOC_CODE) loadData();
            else showError("Document Code is missing.");

            async function loadData() {
                const loader = createLoader("Loading Data...");
                try {
                    const url = new URL(API.GET_DATA);
                    url.searchParams.append("code", DOC_CODE);

                    const res = await fetch(url, { credentials: 'include' });
                    if (!res.ok) throw new Error("Document not found.");

                    let data = await res.json();
                    if (data.data) data = data.data; // Handle wrapped response
                    if (Array.isArray(data)) data = data[0];
                    if (!data) throw new Error("No data returned.");

                    renderHeader(data);
                    renderForm(data);
                    renderDocuments(data.quotations);
                    renderApprovals(data.approvalSteps);

                    // Auto-load first file
                    if (data.quotations && data.quotations.length > 0) {
                        loadViewer(data.quotations[0]);
                    } else {
                        $("#pdfViewer").html('<div class="pdf-placeholder">No files attached</div>');
                    }

                    $("#btnFullscreen").on("click", toggleFullscreen);

                } catch (err) {
                    showError(err.message);
                } finally {
                    loader.hide();
                }
            }

            // ==========================================
            // 3. RENDERING
            // ==========================================
            function renderHeader(data) {
                const statusText = MAPS.status[data.status] || "Unknown";
                let badgeClass = "bg-secondary-soft";
                if (data.status === 1) badgeClass = "bg-warning-soft";
                if (data.status === 2 || data.status === 3) badgeClass = "bg-success-soft";
                if (data.status === 99) badgeClass = "bg-danger-soft";

                $("#headerStatus").html(`<span class="status-badge ${badgeClass}">${statusText}</span>`);
            }

            function renderForm(data) {
                $("#requestInfoForm").dxForm({
                    formData: data,
                    readOnly: true,
                    labelLocation: "top",
                    colCount: 2,
                    items: [
                        { dataField: "code", label: { text: "No." }, colSpan: 2 },
                        { dataField: "title", label: { text: "Title" }, colSpan: 2 },
                        { dataField: "vendorName", label: { text: "Vendor" }, colSpan: 2 },
                        {
                            dataField: "validFrom", label: { text: "Valid From" },
                            editorType: "dxDateBox", editorOptions: { displayFormat: "yyyy-MM-dd" }
                        },
                        {
                            dataField: "validUntil", label: { text: "Valid Until" },
                            editorType: "dxDateBox", editorOptions: { displayFormat: "yyyy-MM-dd" }
                        },
                        {
                            dataField: "remark", label: { text: "Remark" }, colSpan: 2,
                            editorType: "dxTextArea", editorOptions: { autoResizeEnabled: true, minHeight: 60 }
                        }
                    ]
                });
            }

            function renderDocuments(docs) {
                const container = $("#documentList").empty();
                $("#attachmentCount").text(docs ? docs.length : 0);

                if (!docs || docs.length === 0) {
                    container.html('<div class="text-center text-muted small p-3">No attachments</div>');
                    return;
                }

                docs.forEach(doc => {
                    const typeName = MAPS.docType[doc.documentTypeId] || "Attachment";
                    const sizeStr = formatSize(doc.fileSize);

                    const item = $(`
                        <div class="file-item" data-id="${doc.id}">
                            <i class="fas fa-file-pdf file-icon"></i>
                            <div class="file-details">
                                <div class="file-name" title="${doc.fileName}">${doc.fileName}</div>
                                <div class="file-meta">
                                    <span class="badge bg-light text-dark border me-1">${typeName}</span>
                                    <span>${sizeStr}</span>
                                </div>
                            </div>
                        </div>
                    `);
                    item.on("click", () => loadViewer(doc));
                    container.append(item);
                });
            }

            function renderApprovals(steps) {
                const container = $("#approvalList").empty();
                if (!steps || steps.length === 0) {
                    container.html('<div class="text-center text-muted small p-3">No approval history</div>');
                    return;
                }

                steps.sort((a, b) => a.sequence - b.sequence);
                steps.forEach(step => {
                    let dotClass = "";
                    if (step.status === 2) dotClass = "completed";
                    else if (step.status === 99) dotClass = "rejected";
                    else if (step.status === 1) dotClass = "current";

                    const stepStatus = MAPS.status[step.status] || "Waiting";
                    const approver = step.approverName || "System/Waiting";
                    const dateStr = formatDateTime(step.actionDate);

                    const html = `
                        <div class="timeline-item">
                            <div class="timeline-dot ${dotClass}"></div>
                            <div class="timeline-content">
                                <div class="timeline-step">Step ${step.sequence}: ${step.stepName}</div>
                                <div class="timeline-user">
                                    <i class="fas fa-user-circle"></i> ${approver}
                                    <span class="text-muted">(${stepStatus})</span>
                                </div>
                                ${step.actionDate ? `<div class="timeline-date"><i class="far fa-clock"></i> ${dateStr}</div>` : ''}
                                ${step.comment ? `<div class="timeline-comment">"${step.comment}"</div>` : ''}
                            </div>
                        </div>
                    `;
                    container.append(html);
                });
            }

            async function loadViewer(doc) {
                $(".file-item").removeClass("active");
                $(`.file-item[data-id="${doc.id}"]`).addClass("active");
                $("#docTitleLabel").text(doc.fileName);

                const viewer = $("#pdfViewer").empty();
                const loader = createLoader("Opening file...", "#pdfViewer"); // Local loader

                try {
                    const url = `${API.VIEW_FILE}/${doc.id}`;
                    const res = await fetch(url, { method: 'GET', credentials: 'include' });
                    if (!res.ok) throw new Error("Unable to load file content.");

                    const blob = await res.blob();
                    const objUrl = URL.createObjectURL(blob);
                    const type = doc.contentType || "application/pdf";

                    if (type.startsWith("image/")) {
                        $("<img>").attr("src", objUrl).css({ width: "100%", height: "100%", objectFit: "contain" }).appendTo(viewer);
                    } else {
                        $("<embed>").attr({ src: objUrl, type: type, width: "100%", height: "100%" }).appendTo(viewer);
                    }
                } catch (e) {
                    viewer.html(`<div class="error-message text-danger p-4"><i class="fas fa-exclamation-triangle"></i> ${e.message}</div>`);
                } finally {
                    loader.hide();
                }
            }

            // ==========================================
            // 4. UTILS
            // ==========================================
            function formatSize(b) {
                if (!b) return "0 B";
                const i = Math.floor(Math.log(b) / Math.log(1024));
                return (b / Math.pow(1024, i)).toFixed(1) + " " + ["B", "KB", "MB", "GB"][i];
            }

            function formatDateTime(dateStr) {
                if (!dateStr) return "-";
                const d = new Date(dateStr);
                if (isNaN(d.getTime())) return "-";
                const pad = (n) => n.toString().padStart(2, '0');
                // Format: yyyy-MM-dd HH:mm
                return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
            }

            function createLoader(msg, target = "body") {
                if (typeof DevExpress === 'undefined') return { hide: () => { } };
                // Reuse existing loader if possible or create simple overlay
                const id = "local-loader-" + Math.floor(Math.random() * 1000);
                const $el = $("<div>").attr("id", id).appendTo(target);

                const loadPanel = $el.dxLoadPanel({
                    shadingColor: "rgba(255,255,255,0.7)",
                    position: { of: target },
                    visible: true,
                    showIndicator: true,
                    showPane: true,
                    message: msg,
                    container: target
                }).dxLoadPanel("instance");

                return { hide: () => { loadPanel.hide(); $el.remove(); } };
            }

            function showError(msg) {
                if (typeof DevExpress !== 'undefined') DevExpress.ui.notify(msg, "error", 4000);
                else alert(msg);
            }

            function toggleFullscreen() {
                const el = document.getElementById("pdfViewer");
                if (!document.fullscreenElement) {
                    if (el.requestFullscreen) el.requestFullscreen();
                    else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
                } else {
                    if (document.exitFullscreen) document.exitFullscreen();
                }
            }
        });
    </script>
}