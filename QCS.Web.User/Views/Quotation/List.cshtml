@{
    ViewData["Title"] = "ใบเสนอราคา (Quotation)";
}

@section Styles {
    <style>
        /* --- Layout & Container --- */
        .full-height-container {
            height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
            padding-bottom: 20px;
        }

        .qcs-card-content {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            padding: 20px;
            border: none;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* [สำคัญ] ใช้เป็นจุดอ้างอิงพิกัดให้กับปุ่ม Speed Dial */
            position: relative;
        }

        /* --- Grid Wrapper --- */
        .grid-wrapper {
            flex: 1;
      
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        /* --- Links --- */
        .doc-link {
            color: #2190F7;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s;
        }

            .doc-link:hover {
                color: #0d47a1;
                text-decoration: underline;
            }

        /* --- Custom Status Badges (Specific to this page) --- */
        /* Note: Global badges are available in _DevExtremeLayout,
                   but we keep specific logic here for 'Approved' vs 'Completed' */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .st-completed {
            background-color: #d1e7dd;
            color: #0f5132; /* Green for Approved */
        }

        .st-verify {
            background-color: #17a2b8; /* Blue for Process Completed */
            color: #0f5132;
        }

        /* --- Headers --- */
        .text-header {
            color: #2c3e50;
        }
    </style>
}

<div class="container full-height-container mt-3">
    <div class="qcs-card-content">

        <div class="d-flex align-items-center mb-3 pb-2 border-bottom flex-shrink-0">
            <h6 class="m-0 fw-bold text-header">
                <i class="fas fa-file-invoice-dollar text-primary me-2"></i> @ViewData["Title"]
            </h6>
        </div>

        <div class="grid-wrapper">
            <div id="gridContainer"></div>
        </div>

    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            const DETAIL_URL = '@Url.Action("View", "Quotation")';

            $("#gridContainer").dxDataGrid({
                dataSource: DevExpress.data.AspNet.createStore({
                    key: "id",
                    loadUrl: `${API_BASE}/Request/ApprovedList`,
                    onBeforeSend: function (method, ajaxOptions) {
                        ajaxOptions.xhrFields = { withCredentials: true };
                    }
                }),
                height: "100%",
                showBorders: true,
                rowAlternationEnabled: true,
                hoverStateEnabled: true,
                columnAutoWidth: true,
                scrolling: { mode: "virtual" },
                searchPanel: { visible: true, width: 350, placeholder: "ค้นหาเอกสาร..." },
                headerFilter: { visible: true },
                columns: [
                    {
                        dataField: "code",
                        caption: "เลขที่เอกสาร",
                        width: 160,
                        sortOrder: "desc",
                        cellTemplate: (container, options) => {
                            $("<a>")
                                .addClass("doc-link")
                                .text(options.value)
                                .attr("href", `${DETAIL_URL}/${options.value}`)
                                .attr("target", "_blank")
                                .appendTo(container);
                        }
                    },
                    {
                        dataField: "title",
                        caption: "หัวข้อ/รายการ",
                        minWidth: 180
                    },
                    {
                        dataField: "vendorName",
                        caption: "ผู้ขาย (Vendor)",
                        width: 300
                    },
                    {
                        dataField: "requestDate",
                        caption: "วันที่ขอ",
                        dataType: "date",
                        format: "yyyy-MM-dd", /* Updated Format */
                        width: 120,
                        alignment: "center"
                    },
                    {
                        dataField: "status",
                        caption: "สถานะ",
                        width: 140,
                        alignment: "center",
                        allowSorting: false,
                        allowFiltering: false,
                        cellTemplate: function (container, options) {
                            let text = "Approved";
                            let cls = "st-completed";

                            // Status 3 = Process Completed
                            if (options.value == 3) {
                                text = "จบกระบวนการ";
                                cls = "st-verify";
                            }

                            $("<span>")
                                .addClass("status-badge " + cls)
                                .text(text)
                                .appendTo(container);
                        }
                    },
                    {
                        type: "buttons",
                        width: 80,
                        buttons: [{
                            hint: "ดูรายละเอียด",
                            icon: "find",
                            onClick: function (e) {
                                window.open(`${DETAIL_URL}/${e.row.data.code}`, '_blank');
                            }
                        }]
                    }
                ]
            });
        });
    </script>
}