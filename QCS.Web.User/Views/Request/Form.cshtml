@model int?
@{
    // กำหนด Title ตามสถานะ
    ViewData["Title"] = "สร้างใบเสนอราคา (Create Quotation Comparison)";
}

@section Styles {
    <style>
        /* --- Layout & Cards --- */
        .qcs-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            padding: 25px;
            border: none;
            margin-bottom: 20px;
        }

        .section-header {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2c3e50;
            border-bottom: 2px solid #f1f3f5;
            padding-bottom: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* --- Attachments --- */
        .attachments-container {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px dashed #dee2e6;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

            .file-info i {
                color: #f05b41; /* Adobe PDF Red */
                font-size: 1.3em;
            }

        /* --- Workflow Status Colors --- */
        .current-user-row {
            font-weight: 700;
            color: #2190F7;
        }

        .row-current-step {
            background-color: #f0f9ff !important; /* Soft Blue */
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            display: inline-block;
            min-width: 90px;
            text-align: center;
        }

        .status-draft {
            background-color: #e2e3e5;
            color: #383d41;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background-color: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .unauthorized-overlay {
            opacity: 0.6;
            pointer-events: none;
            filter: grayscale(100%);
        }

        .text-primary-header {
            color: #2c3e50;
        }

        .text-highlight {
            color: #2190F7;
        }
    </style>
}

<div class="container mt-4 mb-5">

    <div class="qcs-card">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="m-0 d-flex align-items-center text-nowrap text-primary-header">
                <i class="fas fa-file-invoice-dollar text-highlight me-2"></i>
                <span id="lblPageTitle" class="fw-bold">@ViewData["Title"]</span>
                @if (Model.HasValue)
                {
                    <span class="mx-3 text-muted opacity-25">|</span>
                    <span id="lblDocNo" class="text-highlight fw-bold">Loading...</span>
                }
            </h5>
            <div id="actionButtons"></div>
        </div>
    </div>

    <div class="qcs-card" id="formContainer">
        <div class="section-header">
            <i class="fas fa-info-circle"></i> ข้อมูลใบเสนอราคา (Comparison Info)
        </div>
        <div id="quotationForm"></div>
    </div>

    <div class="qcs-card">
        <div class="section-header">
            <i class="fas fa-route"></i> เส้นทางการอนุมัติ (Approval Route)
        </div>
        <div id="workflowRouteGrid"></div>
    </div>
</div>

<div id="historyPopup"></div>
<div id="actionPopup">
    <div class="p-2">
        <div id="actionReasonBox"></div>
        <div class="mt-3 d-flex justify-content-end gap-2">
            <div id="btnCancelAction"></div>
            <div id="btnConfirmAction"></div>
        </div>
    </div>
</div>

<div id="loadingIndicator"></div>

@section Scripts {
    <script>
        $(function () {
            // ==========================================
            // 1. CONFIGURATION & CONSTANTS
            // ==========================================
            const PR_ID = @(Model.HasValue? Model.Value: "null");
            const MODE = PR_ID ? "EDIT" : "CREATE";

            const CONFIG = {
                API_BASE_URL: API_BASE,
                // Endpoints
                API_GET_DETAIL: `/PurchaseRequest/Detail/${PR_ID}`,
                API_WORKFLOW_ROUTE_INIT: '/Workflow/route/1',
                // Actions
                API_CREATE_SAVE: '/PurchaseRequest/Save',
                API_CREATE_SUBMIT: '/PurchaseRequest/Submit',
                API_UPDATE_SAVE: '/PurchaseRequest/Update',
                API_UPDATE_SUBMIT: '/PurchaseRequest/SubmitUpdate',
                API_APPROVE: `/Approval/Approve`,
                API_REJECT: `/Approval/Reject`,
                VENDOR_API_URL: "/Vendor"
            };

            const documentTypes = [
                { id: 10, name: 'Main Quotation (ใบเสนอราคาหลัก)' },
                { id: 20, name: 'Comparative Quotation (ใบเสนอราคาคู่เทียบ)' },
                { id: 30, name: 'Specifications (รายละเอียดสเปค)' },
                { id: 40, name: 'Terms & Conditions (เงื่อนไข)' }
            ];

            // Local State
            let fileList = [];          // Files to upload
            let deletedFileIds = [];    // IDs to delete
            let prData = {};            // Loaded Data
            let currentActionType = ""; // For Popup action

            // UI Instances
            let formInstance, toolbarInstance, attachmentGridInstance, actionPopupInstance;

            const loadingIndicator = $("#loadingIndicator").dxLoadPanel({
                shadingColor: "rgba(0,0,0,0.4)", position: { of: "window" }, visible: false,
                showIndicator: true, showPane: true, shading: true, message: "Processing..."
            }).dxLoadPanel("instance");

            const vendorStore = DevExpress.data.AspNet.createStore({
                key: "id", loadUrl: CONFIG.API_BASE_URL + CONFIG.VENDOR_API_URL,
                onBeforeSend: (m, ajax) => ajax.xhrFields = { withCredentials: true }
            });

            // ==========================================
            // 2. HELPER FUNCTIONS (Formatters)
            // ==========================================
            const formatDateTime = (dateStr) => {
                if (!dateStr) return "-";
                const d = new Date(dateStr);
                const pad = (n) => n.toString().padStart(2, '0');
                // Format: yyyy-MM-dd HH:mm
                return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
            };

            const getStatusBadge = (status) => {
                let cls = "status-draft", txt = "Waiting";
                if (status === 1) { cls = "status-pending"; txt = "Pending"; }
                else if (status === 2) { cls = "status-approved"; txt = "Approved"; }
                else if (status === 9) { cls = "status-rejected"; txt = "Rejected"; }
                return { cls, txt };
            };

            // ==========================================
            // 3. INITIALIZATION
            // ==========================================
            initUI();
            if (MODE === "CREATE") loadCreateModeData();
            else loadEditModeData();

            function initUI() {
                initToolbar();
                initForm();
                initActionPopup();
            }

            function initToolbar() {
                const items = [
                    {
                        location: 'after', widget: 'dxButton', visible: (MODE === "EDIT"),
                        options: { text: 'ประวัติ (History)', icon: 'clock', stylingMode: 'text', onClick: showHistoryPopup }
                    },
                    {
                        location: 'after', widget: 'dxButton',
                        options: { text: 'กลับ (Back)', stylingMode: 'outlined', icon: 'arrowleft', onClick: () => window.location.href = '@Url.Action("Index", "Home")' }
                    },
                    // Action Buttons (Hidden by default, shown based on permission)
                    {
                        location: 'after', widget: 'dxButton', visible: false,
                        options: { elementAttr: { id: "btnSave" }, text: 'บันทึก (Save Draft)', icon: 'save', type: 'default', stylingMode: 'outlined', onClick: () => handleSaveOrSubmit(false) }
                    },
                    {
                        location: 'after', widget: 'dxButton', visible: false,
                        options: { elementAttr: { id: "btnSubmit" }, text: 'ส่งอนุมัติ (Submit)', icon: 'check', type: 'default', stylingMode: 'contained', onClick: () => handleSaveOrSubmit(true) }
                    },
                    {
                        location: 'after', widget: 'dxButton', visible: false,
                        options: { elementAttr: { id: "btnReject" }, text: 'ไม่อนุมัติ (Reject)', type: 'danger', stylingMode: 'contained', onClick: () => openActionPopup('Reject') }
                    },
                    {
                        location: 'after', widget: 'dxButton', visible: false,
                        options: { elementAttr: { id: "btnApprove" }, text: 'อนุมัติ (Approve)', type: 'success', stylingMode: 'contained', onClick: () => openActionPopup('Approve') }
                    }
                ];
                toolbarInstance = $("#actionButtons").dxToolbar({ items: items }).dxToolbar("instance");
            }

            function initForm() {
                formInstance = $("#quotationForm").dxForm({
                    formData: { validFrom: new Date(), validUntil: new Date(new Date().setMonth(new Date().getMonth() + 1)) },
                    colCount: 2, labelLocation: "top",
                    items: [
                        {
                            itemType: "group", colSpan: 2, colCount: 2,
                            items: [
                                { dataField: "title", label: { text: "หัวข้อ (Title)" }, colSpan: 2, validationRules: [{ type: "required" }] },
                                {
                                    dataField: "vendorId", label: { text: "ผู้ขาย (Vendor)" }, colSpan: 2,
                                    editorType: "dxSelectBox",
                                    editorOptions: { dataSource: vendorStore, valueExpr: "Id", displayExpr: "Name", searchEnabled: true, placeholder: "เลือก Vendor..." },
                                    validationRules: [{ type: "required" }]
                                },
                                {
                                    dataField: "validFrom", label: { text: "วันที่เริ่ม (Valid From)" },
                                    editorType: "dxDateBox",
                                    editorOptions: { displayFormat: "yyyy-MM-dd" }, // <--- Date Format Adjusted
                                    validationRules: [{ type: "required" }]
                                },
                                {
                                    dataField: "validUntil", label: { text: "ถึงวันที่ (Valid Until)" },
                                    editorType: "dxDateBox",
                                    editorOptions: { displayFormat: "yyyy-MM-dd" }, // <--- Date Format Adjusted
                                    validationRules: [{ type: "required" }]
                                },
                                { dataField: "remark", label: { text: "หมายเหตุ (Remark)" }, editorType: "dxTextArea", editorOptions: { height: 80 }, colSpan: 2 }
                            ]
                        },
                        {
                            itemType: "group", caption: "เอกสารแนบ (Attachments)", colSpan: 2,
                            items: [{ template: (d, item) => renderAttachmentsSection([], item, true) }]
                        }
                    ]
                }).dxForm("instance");
            }

            // ==========================================
            // 4. DATA LOADING
            // ==========================================

            function loadCreateModeData() {
                loadingIndicator.show();
                $.ajax({
                    url: CONFIG.API_BASE_URL + CONFIG.API_WORKFLOW_ROUTE_INIT,
                    type: 'GET', xhrFields: { withCredentials: true },
                    success: function (data) {
                        if (data) {
                            renderWorkflowRouteGrid(data, 1);
                            const items = toolbarInstance.option("items");
                            const canInitiate = data.canInitiate;
                            updateButtonVisibility(items, "btnSave", canInitiate);
                            updateButtonVisibility(items, "btnSubmit", canInitiate);
                            if(!canInitiate) $("#formContainer").addClass("unauthorized-overlay");
                            toolbarInstance.option("items", items);
                        }
                    },
                    complete: () => loadingIndicator.hide()
                });
            }

            async function loadEditModeData() {
                loadingIndicator.show();
                try {
                    const response = await fetch(CONFIG.API_BASE_URL + CONFIG.API_GET_DETAIL, { credentials: 'include' });
                    if (!response.ok) throw new Error("ไม่พบข้อมูลเอกสาร");
                    const data = await response.json();

                    // Pre-load Vendor if missing
                    if ((!data.vendorId || data.vendorId === 0) && data.vendorName) {
                        try {
                            const vendors = await vendorStore.load({ filter: ["Name", "=", data.vendorName] });
                            if (vendors && vendors.length > 0) data.vendorId = vendors[0].Id;
                        } catch (ex) {}
                    }

                    prData = data;
                    $("#lblDocNo").text(data.docNo || data.documentNo || "-");

                    const canEdit = data.permissions && data.permissions.canEdit;
                    formInstance.option("formData", data);
                    formInstance.option("readOnly", !canEdit);

                    // Update Attachment Grid
                    if (attachmentGridInstance) {
                        const files = data.quotations || [];
                        attachmentGridInstance.option("dataSource", files);
                        attachmentGridInstance.option("editing.allowUpdating", canEdit);
                        attachmentGridInstance.columnOption(2, "buttons", [
                            {
                                hint: "View", icon: "eyeopen",
                                onClick: (e) => { if (e.row.data.id) viewPdf(e.row.data.id); }
                            },
                            {
                                name: "delete", visible: canEdit, icon: "trash",
                                onClick: (e) => {
                                    if (confirm("ยืนยันการลบไฟล์?")) {
                                        const row = e.row.data;
                                        if (row.id && row.id > 0) deletedFileIds.push(row.id);
                                        else {
                                            const idx = fileList.findIndex(f => f.name === (row.originalFileName || row.fileName));
                                            if (idx > -1) fileList.splice(idx, 1);
                                        }
                                        const ds = attachmentGridInstance.option("dataSource");
                                        const index = ds.indexOf(row);
                                        if (index > -1) { ds.splice(index, 1); attachmentGridInstance.refresh(); }
                                    }
                                }
                            }
                        ]);
                        if(canEdit) $("#uploaderSection").show(); else $("#uploaderSection").hide();
                    }

                    renderWorkflowRouteGrid(data.workflowRoute, data.currentStepId);

                    // Update Toolbar Buttons
                    const items = toolbarInstance.option("items");
                    const setBtn = (id, v) => { const idx = items.findIndex(i => i.options?.elementAttr?.id === id); if (idx >= 0) items[idx].visible = v; };
                    setBtn("btnSave", canEdit);
                    setBtn("btnSubmit", canEdit);
                    setBtn("btnApprove", data.permissions.canApprove);
                    setBtn("btnReject", data.permissions.canReject);
                    toolbarInstance.option("items", items);

                } catch (err) {
                    console.error("Load Error:", err);
                } finally {
                    loadingIndicator.hide();
                }
            }

            function updateButtonVisibility(items, id, visible) {
                const btn = items.find(i => i.options?.elementAttr?.id === id);
                if (btn) btn.visible = visible;
            }

            // ==========================================
            // 5. ATTACHMENTS HANDLING
            // ==========================================
            function renderAttachmentsSection(files, itemElement, canEdit) {
                const $container = $("<div>").addClass("attachments-container").attr("id", "attachmentsContainer");
                const $uploaderDiv = $("<div>").attr("id", "uploaderSection").appendTo($container);

                $("<div>").dxFileUploader({
                    multiple: true, accept: ".pdf", uploadMode: "useForm",
                    labelText: "ลากไฟล์ PDF มาวางที่นี่", selectButtonText: "เพิ่มไฟล์",
                    onValueChanged: (e) => {
                        if (!e.value || e.value.length === 0) return;
                        let currentData = attachmentGridInstance.option("dataSource") || [];
                        const filesToAdd = [];

                        e.value.forEach(f => {
                            if (f.type !== "application/pdf") { DevExpress.ui.notify(`ไฟล์ ${f.name} ไม่ใช่ PDF`, "error", 3000); return; }
                            if (currentData.some(row => (row.originalFileName || row.fileName) === f.name)) { DevExpress.ui.notify(`ไฟล์ ${f.name} มีอยู่แล้ว`, "warning", 2000); return; }

                            fileList.push(f);
                            // Negative ID for temp files
                            filesToAdd.push({
                                id: -1 * (new Date().getTime() + Math.floor(Math.random() * 1000)),
                                originalFileName: f.name, fileName: f.name, isNew: true, fileSize: f.size, documentTypeId: 10
                            });
                        });

                        if (filesToAdd.length > 0) attachmentGridInstance.option("dataSource", [...currentData, ...filesToAdd]);
                        setTimeout(() => { e.component.reset(); }, 100);
                    }
                }).appendTo($uploaderDiv);

                if (!canEdit) $uploaderDiv.hide();

                attachmentGridInstance = $("<div>").dxDataGrid({
                    dataSource: files, showBorders: true, columnAutoWidth: true, noDataText: "ไม่มีไฟล์แนบ", keyExpr: "id",
                    editing: { mode: "cell", allowUpdating: canEdit, allowDeleting: false },
                    columns: [
                        {
                            dataField: "originalFileName", caption: "ชื่อไฟล์ (File Name)", allowEditing: false,
                            calculateDisplayValue: (r) => r.originalFileName || r.fileName,
                            cellTemplate: (c, o) => {
                                const isNew = o.data.isNew ? ' <span class="badge bg-success ms-1">New</span>' : '';
                                $("<div>").addClass("file-info")
                                    .append($("<i>").addClass("fas fa-file-pdf"))
                                    .append($("<span>").html(o.displayValue + isNew))
                                    .appendTo(c);
                            }
                        },
                        {
                            dataField: "documentTypeId", caption: "ประเภท (Type)", width: 250,
                            lookup: { dataSource: documentTypes, valueExpr: "id", displayExpr: "name" },
                            validationRules: [{ type: "required" }]
                        },
                        {
                            type: "buttons", width: 100,
                            buttons: [
                                {
                                    hint: "View", icon: "eyeopen",
                                    onClick: (e) => {
                                        if (e.row.data.id && e.row.data.id > 0) viewPdf(e.row.data.id);
                                        else DevExpress.ui.notify("ไฟล์ใหม่ต้องบันทึกก่อน", "warning", 2000);
                                    }
                                },
                                {
                                    name: "delete", visible: canEdit, icon: "trash",
                                    onClick: (e) => {
                                        if (confirm("ยืนยันการลบไฟล์?")) {
                                            const row = e.row.data;
                                            if (row.id && row.id > 0) deletedFileIds.push(row.id);
                                            else {
                                                const idx = fileList.findIndex(f => f.name === (row.originalFileName || row.fileName));
                                                if (idx > -1) fileList.splice(idx, 1);
                                            }
                                            const ds = attachmentGridInstance.option("dataSource");
                                            const index = ds.findIndex(r => r.id === row.id);
                                            if (index > -1) { ds.splice(index, 1); attachmentGridInstance.refresh(); }
                                        }
                                    }
                                }
                            ]
                        }
                    ]
                }).dxDataGrid("instance");

                attachmentGridInstance.element().appendTo($container);
                $container.appendTo(itemElement);
            }

            // ==========================================
            // 6. ACTIONS (Save, Submit, Approve, Reject)
            // ==========================================
            async function handleSaveOrSubmit(isSubmit) {
                if (!formInstance.validate().isValid) {
                    DevExpress.ui.notify("กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน", "error", 2000);
                    return;
                }

                const ds = attachmentGridInstance.option("dataSource");
                if (!ds || ds.length === 0) {
                    DevExpress.ui.notify("กรุณาแนบไฟล์เอกสารอย่างน้อย 1 รายการ", "error", 3000);
                    return;
                }
                if (!ds.some(f => f.documentTypeId === 10)) {
                    DevExpress.ui.notify("กรุณาแนบ 'ใบเสนอราคาหลัก (Main Quotation)'", "error", 3000);
                    return;
                }

                if (isSubmit) openActionPopup('Submit');
                else executeSaveOrSubmit(false, null);
            }

            function openActionPopup(action) {
                currentActionType = action;
                let title = "ยืนยัน (Confirm)";
                let btnType = "default";
                let ph = "ความคิดเห็นเพิ่มเติม (Optional)...";

                if (action === 'Reject') {
                    title = "ระบุเหตุผลไม่อนุมัติ (Reject Reason)";
                    btnType = "danger";
                    ph = "ต้องระบุเหตุผล (Required)...";
                } else if (action === 'Approve') {
                    title = "ยืนยันอนุมัติ (Confirm Approve)";
                    btnType = "success";
                } else if (action === 'Submit') {
                    title = "ยืนยันส่งอนุมัติ (Confirm Submit)";
                    btnType = "default";
                }

                actionPopupInstance.option("title", title);
                actionPopupInstance.show().done(() => {
                    const textArea = $("#actionReasonBox").dxTextArea("instance");
                    if (textArea) {
                        textArea.reset();
                        textArea.option("placeholder", ph);
                        setTimeout(() => textArea.focus(), 100);
                    }

                    const btnConfirm = $("#btnConfirmAction").dxButton("instance");
                    if (btnConfirm) {
                        btnConfirm.option({
                            type: btnType,
                            onClick: () => {
                                const comment = textArea ? textArea.option("value") : "";
                                if (currentActionType === 'Reject' && !comment) {
                                    DevExpress.ui.notify("กรุณาระบุเหตุผล", "error", 2000);
                                    textArea.focus();
                                    return;
                                }
                                actionPopupInstance.hide();
                                if (currentActionType === 'Submit') executeSaveOrSubmit(true, comment);
                                else sendApprovalAction(currentActionType, comment);
                            }
                        });
                    }
                });
            }

            async function executeSaveOrSubmit(isSubmit, comment) {
                loadingIndicator.show();
                try {
                    const formData = new FormData();
                    const data = formInstance.option("formData");

                    if (MODE === "EDIT") formData.append("Id", PR_ID);
                    formData.append("Title", data.title);

                    const vendorEditor = formInstance.getEditor("vendorId");
                    formData.append("VendorId", vendorEditor.option("value"));
                    formData.append("VendorName", vendorEditor.option("displayValue") || "");

                    if(data.validFrom) formData.append("ValidFrom", new Date(data.validFrom).toISOString());
                    if(data.validUntil) formData.append("ValidUntil", new Date(data.validUntil).toISOString());
                    formData.append("Remark", comment || data.remark || "");

                    const gridFiles = attachmentGridInstance.option("dataSource");
                    const newFilesMeta = [];
                    const existingUpdates = [];

                    gridFiles.forEach(f => {
                        if (f.isNew) newFilesMeta.push({ FileName: f.fileName || f.originalFileName, DocumentTypeId: f.documentTypeId });
                        else if (f.id) existingUpdates.push({ Id: f.id, DocumentTypeId: f.documentTypeId });
                    });

                    formData.append("QuotationsJson", JSON.stringify(newFilesMeta));
                    if (MODE === "EDIT") {
                        formData.append("UpdatedQuotationsJson", JSON.stringify(existingUpdates));
                        if (deletedFileIds.length > 0) formData.append("DeletedFileIds", deletedFileIds.join(","));
                    }

                    fileList.forEach(f => formData.append(MODE === "CREATE" ? "Attachments" : "NewAttachments", f));

                    let endpoint = "";
                    if (MODE === "CREATE") endpoint = isSubmit ? CONFIG.API_CREATE_SUBMIT : CONFIG.API_CREATE_SAVE;
                    else endpoint = isSubmit ? CONFIG.API_UPDATE_SUBMIT : CONFIG.API_UPDATE_SAVE;

                    const res = await fetch(CONFIG.API_BASE_URL + endpoint, { method: 'POST', body: formData, credentials: 'include' });
                    if (!res.ok) throw new Error(await res.text());

                    setTimeout(() => window.location.href = '@Url.Action("Index", "Home")', 500);
                } catch (err) {
                    console.error("Execute Error:", err.message);
                } finally {
                    loadingIndicator.hide();
                }
            }

            async function sendApprovalAction(action, comment) {
                loadingIndicator.show();
                try {
                    const endpoint = (action === 'Approve') ? CONFIG.API_APPROVE : CONFIG.API_REJECT;
                    const res = await fetch(CONFIG.API_BASE_URL + endpoint, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ purchaseRequestId: PR_ID, comment: comment }), credentials: 'include'
                    });
                    if (!res.ok) throw new Error(await res.text());
                    setTimeout(() => location.reload(), 500);
                } catch (err) {
                    console.error("Approval Error:", err.message);
                } finally {
                    loadingIndicator.hide();
                }
            }

            // ==========================================
            // 7. WORKFLOW & HISTORY GRIDS
            // ==========================================
            function renderWorkflowRouteGrid(routeData, currentStepId) {
                const gridData = (routeData && routeData.steps) ? routeData.steps.map(s => ({
                    sequenceNo: s.sequenceNo, stepName: s.stepName, rawAssignments: s.assignments,
                    status: s.status || 0, approverName: s.approverName, approverNId: s.approverNId,
                    actionDate: s.actionDate, comment: s.comment
                })) : [];

                $("#workflowRouteGrid").dxDataGrid({
                    dataSource: gridData, showBorders: true, showRowLines: true, columnAutoWidth: true, paging: { enabled: false },
                    onRowPrepared: (e) => {
                        if (e.rowType === "data" && e.data.sequenceNo === currentStepId) e.rowElement.addClass("row-current-step");
                    },
                    columns: [
                        { dataField: "sequenceNo", caption: "#", width: 50, alignment: "center" },
                        { dataField: "stepName", caption: "ขั้นตอน (Step)", width: 200 },
                        {
                            dataField: "assignees", caption: "ผู้มีสิทธิ์อนุมัติ (Assignees)",
                            cellTemplate: (c, o) => {
                                const list = o.data.rawAssignments || [];
                                if(list.length === 0) return $("<span>").text("Any").appendTo(c);
                                list.forEach(a => $("<div>").html(a.isCurrentUser ?
                                    `<span class="current-user-row"><i class="fas fa-user-circle"></i> ${a.employeeName} (You)</span>` :
                                    `<span class="text-muted"><i class="fas fa-user"></i> ${a.employeeName}</span>`).appendTo(c));
                            }
                        },
                        {
                            dataField: "status", caption: "สถานะ", width: 100, alignment: "center",
                            cellTemplate: (c, o) => {
                                const b = getStatusBadge(o.value);
                                $("<span>").addClass("status-badge " + b.cls).text(b.txt).appendTo(c);
                            }
                        },
                        {
                            dataField: "approverName", caption: "ผู้ดำเนินการ",
                            cellTemplate: (c, o) => {
                                const name = o.data.approverName;
                                const txt = name ? (o.data.approverNId ? `${name} (${o.data.approverNId})` : name) : "-";
                                $("<span>").text(txt).appendTo(c);
                            }
                        },
                        {
                            dataField: "actionDate", caption: "วันที่", width: 140, alignment: "center",
                            customizeText: (c) => formatDateTime(c.value) // <--- Date Format Adjusted (yyyy-MM-dd HH:mm)
                        },
                        { dataField: "comment", caption: "ความเห็น", customizeText: (c) => c.value || "-" }
                    ]
                });
            }

            function showHistoryPopup() {
                const historyData = prData ? (prData.workflowRoute ? prData.workflowRoute.steps : []) : [];
                $("#historyPopup").dxPopup({
                    title: "ประวัติการอนุมัติ (Approval History)", width: 850, height: 500, visible: true, dragEnabled: true, showCloseButton: true,
                    contentTemplate: (c) => {
                        $("<div>").dxDataGrid({
                            dataSource: historyData, showBorders: true, showRowLines: true, columnAutoWidth: true, paging: { enabled: false },
                            columns: [
                                { caption: "#", width: 50, alignment: "center", cellTemplate: (cnt, opt) => cnt.text(opt.rowIndex + 1) },
                                { dataField: "stepName", caption: "Step" },
                                {
                                    dataField: "approverName", caption: "Approver",
                                    cellTemplate: (c, o) => {
                                        const name = o.data.approverName;
                                        const txt = name ? (o.data.approverNId ? `${name} (${o.data.approverNId})` : name) : "-";
                                        $("<span>").text(txt).appendTo(c);
                                    }
                                },
                                {
                                    dataField: "actionDate", caption: "Date", width: 140, alignment: "center",
                                    customizeText: (info) => formatDateTime(info.value) // <--- Date Format Adjusted (yyyy-MM-dd HH:mm)
                                },
                                {
                                    dataField: "status", caption: "Status", width: 100,
                                    cellTemplate: (cnt, opt) => {
                                        const b = getStatusBadge(opt.value);
                                        $("<span>").addClass("status-badge " + b.cls).text(b.txt).appendTo(cnt);
                                    }
                                },
                                { dataField: "comment", caption: "Remark", customizeText: (info) => info.value || "-" }
                            ]
                        }).appendTo(c);
                    }
                }).dxPopup("instance").show();
            }

            function initActionPopup() {
                actionPopupInstance = $("#actionPopup").dxPopup({
                    width: 400, height: "auto", visible: false, dragEnabled: true, hideOnOutsideClick: false, showCloseButton: true, title: "Action",
                    contentTemplate: function(contentElement) {
                        const container = $("<div>").addClass("p-2");
                        $("<div>").attr("id", "actionReasonBox").appendTo(container).dxTextArea({ height: 100, value: "", stylingMode: "outlined" });
                        const btnGroup = $("<div>").addClass("mt-3 d-flex justify-content-end gap-2").appendTo(container);

                        $("<div>").appendTo(btnGroup).dxButton({
                            text: "ยกเลิก (Cancel)", stylingMode: "text",
                            onClick: () => actionPopupInstance.hide()
                        });
                        $("<div>").attr("id", "btnConfirmAction").appendTo(btnGroup).dxButton({
                            text: "ยืนยัน (Confirm)", stylingMode: "contained"
                        });
                        return container;
                    }
                }).dxPopup("instance");
            }

            async function viewPdf(id) {
                const loadingHtml = `<div style="text-align:center; padding-top:20px;"><h3>Processing PDF...</h3><p>Please wait...</p></div>`;
                const loadingUrl = URL.createObjectURL(new Blob([loadingHtml], { type: 'text/html' }));
                const newWindow = window.open(loadingUrl, '_blank');
                if (!newWindow) { alert("Pop-up blocked!"); return; }

                try {
                    const response = await fetch(`${CONFIG.API_BASE_URL}/PurchaseRequest/ViewFile/${id}`, { method: 'GET', credentials: 'include' });
                    if (!response.ok) throw new Error("Cannot download file.");
                    const pdfBlob = await response.blob();
                    if (pdfBlob.type !== 'application/pdf') throw new Error("Invalid PDF");
                    newWindow.location.href = window.URL.createObjectURL(pdfBlob);
                } catch (error) {
                    if (newWindow && !newWindow.closed) newWindow.close();
                    console.error("View PDF Error:", error.message);
                }
            }
        });
    </script>
}