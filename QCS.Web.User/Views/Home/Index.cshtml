@{
    ViewData["Title"] = "My Tasks & Requests";
}

@section Styles {
    <style>
        /* --- Layout & Container --- */
        .full-height-container {
            height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
            padding-bottom: 20px;
        }

        .qcs-card-content {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            padding: 20px;
            border: none;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* --- TabPanel Customization --- */
        #tabPanel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

            /* Force DevExtreme containers to fill height */
            #tabPanel .dx-tabpanel-container,
            #tabPanel .dx-multiview-wrapper,
            #tabPanel .dx-multiview-item-container,
            #tabPanel .dx-multiview-item,
            #tabPanel .dx-multiview-item-content {
                height: 100%;
                display: flex;
                flex-direction: column;
            }

            #tabPanel .dx-tabs {
                border-bottom: 1px solid #f1f3f5;
                background-color: transparent;
                flex-shrink: 0;
                margin-bottom: 10px;
            }

            #tabPanel .dx-tab {
                background-color: transparent !important;
                padding: 10px 20px;
            }

            #tabPanel .dx-tab-text {
                font-family: 'Segoe UI', sans-serif;
                font-size: 1rem;
                font-weight: 600;
                color: #6c757d;
                text-transform: none;
            }

            #tabPanel .dx-tab-selected {
                border-bottom: 3px solid #258cfb;
                color: #258cfb;
            }

                #tabPanel .dx-tab-selected .dx-tab-text {
                    color: #258cfb;
                }

        /* --- Grid & Content --- */
        .grid-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            padding: 5px;
        }

            /* Force DataGrid to fill wrapper */
            .grid-wrapper .dx-datagrid {
                height: 100%;
            }

        .doc-link {
            color: #258cfb;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s;
        }

            .doc-link:hover {
                color: #0a58ca;
                text-decoration: underline;
            }

        .text-header {
            color: #2c3e50;
        }

        /* Status Badge Styling */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        /* (คุณอาจต้องมี CSS หรือ Logic เพิ่มเติมสำหรับ class สีของ status แต่ละแบบ) */
        .status-draft { background-color: #e9ecef; color: #495057; }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-approved { background-color: #d1e7dd; color: #0f5132; }
        .status-rejected { background-color: #f8d7da; color: #842029; }
    </style>
}

<div class="container full-height-container mt-3">
    <div class="qcs-card-content" id="main-dashboard-card">

        <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom flex-shrink-0">
            <h6 class="m-0 fw-bold text-header">
                <i class="fas fa-clipboard-list text-primary me-2"></i> @ViewData["Title"]
            </h6>
            
            <button id="btnCreateHeader" class="btn btn-primary btn-sm px-3 shadow-sm">
                <i class="fas fa-plus me-1"></i> สร้างใบเสนอราคาใหม่
            </button>
        </div>

        <div id="tabPanel"></div>

        <div id="emptyState" class="d-none text-center h-100 d-flex flex-column justify-content-center align-items-center">
            <div class="p-4 rounded-circle bg-light mb-3">
                <i class="fas fa-inbox fa-3x text-muted opacity-50"></i>
            </div>
            <h5 class="text-muted mb-3">ไม่มีข้อมูลเอกสารในขณะนี้</h5>
            <button id="btnCreateEmpty" class="btn btn-primary px-4 rounded-pill">
                <i class="fas fa-plus me-2"></i>สร้างใบเสนอราคาใหม่
            </button>
        </div>

    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            // === CONFIG ===
            const FORM_URL = '@Url.Action("Form", "Request")';
            
            // === BUTTON EVENTS ===
            // 1. ปุ่มบน Header
            $("#btnCreateHeader").on("click", function() {
                window.location.href = FORM_URL;
            });

            // 2. ปุ่มใน Empty State
            $("#btnCreateEmpty").on("click", function() {
                window.location.href = FORM_URL;
            });

            // === MAIN LOGIC ===
            loadSummaryData();

            function loadSummaryData() {
                $.ajax({
                    url: `${API_BASE}/Dashboard/Summary`,
                    method: "GET",
                    xhrFields: { withCredentials: true },
                    success: function (data) {
                        initTabPanel(data.myRequestCount, data.myTaskCount, data.approvedCount);
                    },
                    error: function(err) {
                        console.error("Failed to load summary", err);
                        // Fallback กรณี Error ให้แสดง 0
                        initTabPanel(0, 0, 0);
                    }
                });
            }

            function initTabPanel(requestCount, taskCount, approvedCount) {
                const tabs = [];

                // Tab 1: My Tasks (งานรออนุมัติ - สำคัญสุด)
                if (taskCount > 0) {
                    tabs.push({
                        title: "งานรออนุมัติ (My Tasks)",
                        icon: "check",
                        badge: taskCount,
                        template: () => $("<div>").addClass("grid-wrapper").append($("<div>").attr("id", "gridMyTasks"))
                    });
                }

                // Tab 2: My Requests (เอกสารของฉัน)
                tabs.push({
                    title: "เอกสารของฉัน (My Requests)",
                    icon: "file",
                    badge: requestCount,
                    template: () => $("<div>").addClass("grid-wrapper").append($("<div>").attr("id", "gridMyRequests"))
                });

                // Tab 3: Approved List (เอกสารที่อนุมัติแล้ว)
                if (approvedCount > 0) {
                    tabs.push({
                        title: "เอกสารที่อนุมัติแล้ว (Approved)",
                        icon: "activefolder",
                        badge: approvedCount,
                        template: () => $("<div>").addClass("grid-wrapper").append($("<div>").attr("id", "gridApproved"))
                    });
                }

                // Show Empty State if absolutely no data
                if (tabs.length === 0 && requestCount === 0) {
                    $("#emptyState").removeClass("d-none");
                    return;
                }

                $("#tabPanel").dxTabPanel({
                    items: tabs,
                    height: "100%",
                    deferRendering: false,
                    itemTitleTemplate: function(itemData) {
                        const container = $("<div>").addClass("d-flex align-items-center gap-2");
                        if(itemData.icon) {
                            container.append($("<i>").addClass("dx-icon-" + itemData.icon));
                        }
                        container.append($("<span>").text(itemData.title));
                        return container;
                    },
                    onContentReady: function(e) {
                        // Init Grids when tab is ready
                        if ($("#gridMyRequests").length && !$("#gridMyRequests").data("dxDataGrid")) {
                            renderMyRequestsGrid();
                        }
                        if ($("#gridMyTasks").length && !$("#gridMyTasks").data("dxDataGrid")) {
                            renderMyTasksGrid();
                        }
                        if ($("#gridApproved").length && !$("#gridApproved").data("dxDataGrid")) {
                            renderApprovedGrid();
                        }
                    }
                });
            }

            // === GRID COLUMNS & CONFIG ===
            const baseColumns = [
                {
                    dataField: "code",
                    caption: "เลขที่เอกสาร",
                    width: 150,
                    cellTemplate: (container, options) => {
                        const docNo = options.value || "(Draft)";
                        $("<a>")
                            .addClass("doc-link")
                            .text(docNo)
                            .attr("href", `${FORM_URL}/${options.data.id}`)
                            .appendTo(container);
                    }
                },
                {
                    dataField: "title",
                    caption: "หัวข้อ",
                    minWidth: 180,
                    allowSorting: false,
                    allowFiltering: false,
                    allowSearch: false
                },
                {
                    dataField: "vendorName",
                    caption: "ผู้ขาย",
                    width: 300
                },
                {
                    dataField: "requestDate",
                    caption: "วันที่ขอ",
                    dataType: "date",
                    format: "yyyy-MM-dd",
                    width: 120,
                    alignment: "center"
                },
                {
                    dataField: "status",
                    caption: "สถานะ",
                    width: 140,
                    alignment: "center",
                    allowSorting: false,
                    allowFiltering: false,
                    allowSearch: false,
                    cellTemplate: (container, options) => {
                        // หมายเหตุ: ตรวจสอบให้แน่ใจว่าฟังก์ชัน getStatusInfo มีอยู่ในโปรเจกต์ของคุณ
                        // หรือถ้าไม่มี ให้เขียนฟังก์ชันนี้เพิ่ม
                        let info = { cls: "status-draft", text: options.value };
                        if(typeof getStatusInfo === 'function') {
                             info = getStatusInfo(options.value, options.data.currentStepId);
                        } else {
                            // Basic Fallback if function missing
                             if(options.value === 1) info = { cls: "status-pending", text: "Pending" };
                             else if(options.value === 2) info = { cls: "status-approved", text: "Approved" };
                             else if(options.value === 9) info = { cls: "status-rejected", text: "Rejected" };
                        }

                        $("<span>")
                            .addClass("status-badge " + info.cls)
                            .text(info.text)
                            .appendTo(container);
                    }
                },
                {
                    type: "buttons",
                    width: 70,
                    buttons: [{
                        hint: "เปิดดู",
                        icon: "arrowright",
                        onClick: (e) => window.location.href = `${FORM_URL}/${e.row.data.id}`
                    }]
                }
            ];

            function renderMyRequestsGrid() {
                $("#gridMyRequests").dxDataGrid({
                    dataSource: DevExpress.data.AspNet.createStore({
                        key: "id",
                        loadUrl: `${API_BASE}/Request/MyRequests`,
                        onBeforeSend: (m, ajax) => ajax.xhrFields = { withCredentials: true }
                    }),
                    height: "100%",
                    showBorders: true,
                    rowAlternationEnabled: true,
                    hoverStateEnabled: true,
                    columnAutoWidth: true,
                    filterRow: { visible: true },
                    headerFilter: { visible: true },
                    scrolling: { mode: "virtual" },
                    searchPanel: { visible: true, width: 350, placeholder: "ค้นหาเอกสาร..." },
                    columns: baseColumns
                });
            }

            function renderMyTasksGrid() {
                const taskColumns = [
                    ...baseColumns.slice(0, 2),
                    {
                        dataField: "requesterName",
                        caption: "ผู้ขอซื้อ (Requester)",
                        width: 180
                    },
                    ...baseColumns.slice(2)
                ];
                $("#gridMyTasks").dxDataGrid({
                    dataSource: DevExpress.data.AspNet.createStore({
                        key: "id",
                        loadUrl: `${API_BASE}/Request/PendingApprovals`,
                        onBeforeSend: (m, ajax) => ajax.xhrFields = { withCredentials: true }
                    }),
                    height: "100%",
                    showBorders: true,
                    rowAlternationEnabled: true,
                    hoverStateEnabled: true,
                    columnAutoWidth: true,
                    filterRow: { visible: true },
                    headerFilter: { visible: true },
                    scrolling: { mode: "virtual" },
                    searchPanel: { visible: true, width: 350, placeholder: "ค้นหางาน..." },
                    columns: taskColumns
                });
            }

            function renderApprovedGrid() {
                $("#gridApproved").dxDataGrid({
                    dataSource: DevExpress.data.AspNet.createStore({
                        key: "id",
                        loadUrl: `${API_BASE}/Request/ApprovedList`,
                        onBeforeSend: (m, ajax) => ajax.xhrFields = { withCredentials: true }
                    }),
                    height: "100%",
                    showBorders: true,
                    rowAlternationEnabled: true,
                    hoverStateEnabled: true,
                    columnAutoWidth: true,
                    filterRow: { visible: true },
                    headerFilter: { visible: true },
                    scrolling: { mode: "virtual" },
                    searchPanel: { visible: true, width: 350, placeholder: "ค้นหาเอกสารที่อนุมัติแล้ว..." },
                    columns: baseColumns
                });
            }
        });
    </script>
}