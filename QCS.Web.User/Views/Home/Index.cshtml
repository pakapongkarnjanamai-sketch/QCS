@{
    ViewData["Title"] = "รายการใบเสนอราคา (Quotation Comparison List)";
}

@section Styles {
    <style>
        /* --- Shared Styles (Matched with Form.cshtml) --- */
        .qcs-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 20px;
            border: 1px solid #eaeaea;
        }

        .mt-card {
            margin-top: 20px;
        }

        /* --- Status Badges --- */
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }

        .status-draft {
            background-color: #6c757d;
        }

        .status-pending {
            background-color: #ffc107;
            color: #000;
        }

        .status-approved {
            background-color: #28a745;
        }

        .status-rejected {
            background-color: #dc3545;
        }

        /* --- Grid Tweaks --- */
        .dx-datagrid-header-panel {
            padding-bottom: 10px;
        }

        .doc-link {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

            .doc-link:hover {
                text-decoration: underline;
            }
    </style>
}

<div class="container mt-4">
    <div class="qcs-card mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="m-0 d-flex align-items-center text-nowrap">
                <i class="fas fa-list-alt text-primary me-2"></i>
                <span class="fw-bold">@ViewData["Title"]</span>
            </h6>
            <div id="actionButtons"></div>
        </div>
    </div>

    <div class="qcs-card">
        <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
            <h6 class="m-0 text-secondary font-weight-bold">
                <i class="fas fa-table me-2"></i>
                รายการเอกสาร (Document List)
            </h6>
        </div>
        <div id="gridContainer"></div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            // === CONFIGURATION ===
            const CONFIG = {
                API_BASE_URL: "https://localhost:7127/api",
                API_LOAD_URL: "/PurchaseRequest/MyRequests",
                FORM_URL: '@Url.Action("Form", "Request")'
            };

            // === STORE ===
            const store = DevExpress.data.AspNet.createStore({
                key: "id",
                loadUrl: CONFIG.API_BASE_URL + CONFIG.API_LOAD_URL,
                onBeforeSend: function (method, ajaxOptions) {
                    ajaxOptions.xhrFields = { withCredentials: true };
                }
            });

            // === INIT UI ===
            const toolbarItems = [
                {
                    location: 'after',
                    widget: 'dxButton',
                    options: {
                        text: 'สร้างใบเสนอราคาใหม่ (New Request)',
                        icon: 'plus',
                        type: 'default',
                        stylingMode: 'contained',
                        onClick: function () {
                            window.location.href = CONFIG.FORM_URL;
                        }
                    }
                }
            ];

            $("#actionButtons").dxToolbar({ items: toolbarItems });

            $("#gridContainer").dxDataGrid({
                dataSource: store,
                showBorders: true,
                showRowLines: true,
                rowAlternationEnabled: true,
                columnAutoWidth: true,
                hoverStateEnabled: true,

                // Features
                searchPanel: { visible: true, width: 250, placeholder: "ค้นหา (Search)..." },
                filterRow: { visible: true, applyFilter: "auto" },
                headerFilter: { visible: true },
                paging: { pageSize: 10 },
                pager: { showPageSizeSelector: true, allowedPageSizes: [10, 20, 50], showInfo: true },

                // Columns Configuration (แก้ไขชื่อ DataField ให้ตรงกับ JSON)
                columns: [
                    {
                        dataField: "code", // [แก้ไข] จาก docNo เป็น code
                        caption: "เลขที่เอกสาร",
                        width: 160,
                        cellTemplate: function(container, options) {
                            const docNo = options.value || "(Draft)";
                            $("<a>")
                                .addClass("doc-link")
                                .text(docNo)
                                .attr("href", `${CONFIG.FORM_URL}/${options.data.id}`)
                                .appendTo(container);
                        }
                    },
                    {
                        dataField: "title",
                        caption: "หัวข้อ (Title)",
                        minWidth: 200
                    },
                    {
                        dataField: "vendorName",
                        caption: "ผู้ขาย (Vendor)",
                        width: 250
                    },
                    {
                        dataField: "requestDate", // [แก้ไข] จาก createdDate เป็น requestDate
                        caption: "วันที่ขอซื้อ",
                        dataType: "date",
                        format: "dd/MM/yyyy",
                        width: 120,
                        alignment: "center"
                    },
                    {
                        dataField: "status",
                        caption: "สถานะ",
                        width: 120,
                        alignment: "center",
                        cellTemplate: function (container, options) {
                            const status = options.value;
                            let text = "Waiting";
                            let cls = "status-draft";

                            // Logic Mapping Status
                            if (status === 1) { text = "Pending"; cls = "status-pending"; }
                            else if (status === 2) { text = "Approved"; cls = "status-approved"; }
                            else if (status === 9) { text = "Rejected"; cls = "status-rejected"; }

                            $("<span>").addClass("status-badge " + cls).text(text).appendTo(container);
                        }
                    },
                    {
                        type: "buttons",
                        width: 70,
                        buttons: [
                            {
                                hint: "ดูรายละเอียด / แก้ไข",
                                icon: "edit",
                                onClick: function (e) {
                                    window.location.href = `${CONFIG.FORM_URL}/${e.row.data.id}`;
                                }
                            }
                        ]
                    }
                ]
            });
        });
    </script>
}