@using QCS.Domain.Enum
@{
    ViewData["Title"] = "Dashboard";
}

@section Styles {
    <link href="~/css/devextreme/dx.light.css" rel="stylesheet" />
    <style>
        .card-counter {
            box-shadow: 2px 2px 10px #DADADA;
            margin: 5px;
            padding: 20px 10px;
            background-color: #fff;
            height: 100px;
            border-radius: 5px;
            transition: .3s linear all;
            position: relative;
        }

            .card-counter:hover {
                box-shadow: 4px 4px 20px #DADADA;
                transform: translateY(-2px);
            }

            .card-counter i {
                font-size: 5em;
                opacity: 0.2;
            }

            .card-counter .count-numbers {
                position: absolute;
                right: 35px;
                top: 20px;
                font-size: 32px;
                display: block;
                font-weight: bold;
            }

            .card-counter .count-name {
                position: absolute;
                right: 35px;
                top: 65px;
                font-style: italic;
                text-transform: capitalize;
                opacity: 0.7;
                display: block;
                font-size: 16px;
            }
        /* Custom Colors */
        .bg-primary-light {
            background-color: #e3f2fd;
            color: #0d6efd;
        }

        .bg-warning-light {
            background-color: #fff3cd;
            color: #856404;
        }

        .bg-success-light {
            background-color: #d1e7dd;
            color: #0f5132;
        }

        .bg-danger-light {
            background-color: #f8d7da;
            color: #842029;
        }
    </style>
}

<div class="container-xxl bd-gutter mt-3 my-md-4 bd-layout">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="dx-icon-home"></i> ภาพรวมของฉัน</h3>
        <button id="btnRefresh" class="btn btn-sm btn-outline-secondary"><i class="dx-icon-refresh"></i> รีเฟรชข้อมูล</button>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card-counter bg-primary-light">
                <i class="dx-icon-doc"></i>
                <span class="count-numbers" id="lblTotal">...</span>
                <span class="count-name">ทั้งหมด</span>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card-counter bg-warning-light">
                <i class="dx-icon-clock"></i>
                <span class="count-numbers" id="lblPending">...</span>
                <span class="count-name">รออนุมัติ</span>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card-counter bg-success-light">
                <i class="dx-icon-check"></i>
                <span class="count-numbers" id="lblApproved">...</span>
                <span class="count-name">อนุมัติแล้ว</span>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card-counter bg-danger-light">
                <i class="dx-icon-close"></i>
                <span class="count-numbers" id="lblRejected">...</span>
                <span class="count-name">ไม่อนุมัติ</span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">รายการขอซื้อล่าสุด</h5>
                </div>
                <div class="card-body p-0">
                    <div id="recentRequestsGrid"></div>
                </div>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script src="~/js/devextreme/dx.all.js"></script>
    <script>
        $(function () {
            // รับ API URL มาจาก Controller (หรือ Hardcode ถ้าจำเป็น)
            const API_URL = 'https://localhost:7127/api/dashboard/my-summary';
            // const USER_ID = 1; // ถ้ามีการส่ง user id

            // ฟังก์ชันโหลดข้อมูล
            function loadDashboardData() {
                // แสดง Loading State (ถ้าต้องการ)
                // $('#lblTotal').text('...');

                $.ajax({
                    url: API_URL,
                    type: 'GET',
                    xhrFields: { withCredentials: true },
                    dataType: 'json',
                    // data: { userId: USER_ID },
                    success: function (data) {
                        // 1. อัปเดตตัวเลขใน Card
                        updateCounter('#lblTotal', data.totalRequests);
                        updateCounter('#lblPending', data.pendingRequests);
                        updateCounter('#lblApproved', data.approvedRequests);
                        updateCounter('#lblRejected', data.rejectedRequests);

                        // 2. อัปเดตข้อมูลใน DataGrid
                        var grid = $("#recentRequestsGrid").dxDataGrid("instance");
                        grid.option("dataSource", data.recentRequests);
                    },
                    error: function (xhr, status, error) {
                        console.error("Error loading dashboard:", error);
                        DevExpress.ui.notify("ไม่สามารถโหลดข้อมูล Dashboard ได้", "error", 3000);
                    }
                });
            }

            // ฟังก์ชัน Animation ตัวเลขวิ่งๆ (เพื่อความสวยงาม)
            function updateCounter(selector, value) {
                $(selector).prop('Counter', 0).animate({
                    Counter: value
                }, {
                    duration: 1000,
                    easing: 'swing',
                    step: function (now) {
                        $(this).text(Math.ceil(now));
                    },
                    complete: function() {
                        $(this).text(value); // Ensure final value is exact
                    }
                });
            }

            // เริ่มต้นสร้าง DataGrid (โครงเปล่าๆ รอรับข้อมูล)
            $("#recentRequestsGrid").dxDataGrid({
                dataSource: [], // เริ่มต้นเป็นว่าง
                keyExpr: "id",
                showBorders: false,
                columnAutoWidth: true,
                hoverStateEnabled: true,
                loadPanel: { enabled: true },
                noDataText: "กำลังโหลดข้อมูล...",
                columns: [
                    { dataField: "code", caption: "เลขที่เอกสาร", width: 150 },
                    { dataField: "title", caption: "เรื่อง" },
                    { dataField: "vendorName", caption: "ผู้ขาย" },
                    {
                        dataField: "requestDate",
                        caption: "วันที่ขอ",
                        dataType: "date",
                        format: "dd/MM/yyyy"
                    },
                    {
                        dataField: "status",
                        caption: "สถานะ",
                        width: 120,
                        alignment: "center",
                        cellTemplate: function (container, options) {
                            var status = options.value;
                            var text = "";
                            var colorClass = "";

                            // ใช้ตัวเลข Magic Number หรือสร้าง Object Map เพื่อให้อ่านง่าย
                            if (status == @RequestStatus.Draft) { text = "แบบร่าง"; colorClass = "badge bg-secondary"; }
                            else if (status == @RequestStatus.Pending) { text = "รออนุมัติ"; colorClass = "badge bg-warning text-dark"; }
                            else if (status == @RequestStatus.Approved) { text = "อนุมัติ"; colorClass = "badge bg-success"; }
                            else if (status == @RequestStatus.Completed) { text = "เสร็จสมบูรณ์"; colorClass = "badge bg-success"; }
                            else if (status == @RequestStatus.Rejected) { text = "ไม่อนุมัติ"; colorClass = "badge bg-danger"; }
                            else { text = "อื่นๆ"; colorClass = "badge bg-light text-dark"; }

                            $("<span class='" + colorClass + "'>" + text + "</span>").appendTo(container);
                        }
                    },
                    {
                        type: "buttons",
                        width: 80,
                        buttons: [{
                            hint: "ดูรายละเอียด",
                            icon: "find",
                            onClick: function (e) {
                                var id = e.row.data.id;
                                // เปลี่ยน URL ไปยังหน้า Detail
                                window.location.href = '@Url.Action("Form", "Request")?id=' + id;
                            }
                        }]
                    }
                ]
            });

            // ปุ่ม Refresh
            $("#btnRefresh").click(function() {
                loadDashboardData();
            });

            // เรียกโหลดข้อมูลครั้งแรก
            loadDashboardData();
        });
    </script>
}