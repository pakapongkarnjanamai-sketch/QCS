@{
    ViewData["Title"] = "Dashboard & My Tasks";
}

@section Styles {
    <style>
        /* --- Layout & Container --- */
        .full-height-container {
            height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
            padding-bottom: 20px;
        }

        .qcs-card-dashboard {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            padding: 25px;
            border: none;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Dashboard Widgets --- */
        .dash-widget {
            display: flex;
            align-items: center;
            padding: 20px;
            border-radius: 12px;
            color: #fff;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            cursor: default;
            border: none;
        }

            .dash-widget:hover {
                transform: translateY(-3px);
                box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            }

        .dash-icon {
            font-size: 2.5rem;
            opacity: 0.8;
            margin-right: 15px;
        }

        .dash-info h3 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
        }

        .dash-info span {
            font-size: 0.9rem;
            opacity: 0.95;
            font-weight: 500;
        }

        /* Formal Gradients */
        .bg-gradient-primary {
            background: linear-gradient(135deg, #2190F7, #1565C0);
        }

        .bg-gradient-warning {
            background: linear-gradient(135deg, #FFC107, #FF8F00);
            color: #333 !important;
        }

        .bg-gradient-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }

        .bg-gradient-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        /* --- TabPanel Customization --- */
        #tabPanel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            margin-top: 25px;
        }

            #tabPanel .dx-tabs {
                border-bottom: 2px solid #f1f3f5;
                background-color: transparent;
            }

            #tabPanel .dx-tab {
                background-color: transparent !important;
                padding: 10px 20px;
            }

                #tabPanel .dx-tab .dx-tab-text {
                    font-family: 'Segoe UI', sans-serif;
                    font-size: 1rem;
                    font-weight: 600;
                    color: #6c757d;
                    text-transform: none;
                }

                #tabPanel .dx-tab.dx-tab-selected {
                    border-bottom: 3px solid #2190F7;
                    color: #2190F7;
                }

                    #tabPanel .dx-tab.dx-tab-selected .dx-tab-text {
                        color: #2190F7;
                    }

        /* --- Grid & Content --- */
        .grid-wrapper {
            flex: 1;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .doc-link {
            color: #2190F7;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s;
        }

            .doc-link:hover {
                color: #0d47a1;
                text-decoration: underline;
            }

        /* --- Helper Classes --- */
        .text-header {
            color: #2c3e50;
        }
    </style>
}

<div class="container full-height-container mt-3">
    <div class="qcs-card-dashboard">

        <div class="d-flex justify-content-between align-items-center mb-4 flex-shrink-0">
            <h4 class="fw-bold m-0 text-header">
                <i class="fas fa-chart-pie text-primary me-2"></i>@ViewData["Title"]
            </h4>
        </div>

        <div class="row g-3 flex-shrink-0" id="dashboardWidgets">
            <div class="col-md-3 col-sm-6">
                <div class="dash-widget bg-gradient-primary">
                    <i class="fas fa-file-alt dash-icon"></i>
                    <div class="dash-info"><h3 id="lblTotalCreated">-</h3><span>เอกสารที่สร้าง</span></div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="dash-widget bg-gradient-warning">
                    <i class="fas fa-clock dash-icon" style="color: #333;"></i>
                    <div class="dash-info"><h3 id="lblTotalPending">-</h3><span>รออนุมัติ</span></div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="dash-widget bg-gradient-success">
                    <i class="fas fa-check-circle dash-icon"></i>
                    <div class="dash-info"><h3 id="lblTotalCompleted">-</h3><span>อนุมัติ/เสร็จสิ้น</span></div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="dash-widget bg-gradient-danger">
                    <i class="fas fa-user-check dash-icon"></i>
                    <div class="dash-info"><h3 id="lblMyTasks">-</h3><span>งานรออนุมัติ</span></div>
                </div>
            </div>
        </div>

        <div id="tabPanel"></div>

        <div id="emptyState" class="d-none text-center h-100 d-flex flex-column justify-content-center align-items-center">
            <div class="p-4 rounded-circle bg-light mb-3">
                <i class="fas fa-inbox fa-3x text-muted opacity-50"></i>
            </div>
            <h5 class="text-muted mb-3">ไม่มีข้อมูลเอกสารในขณะนี้</h5>
            <button id="btnCreateEmpty" class="btn btn-primary px-4 rounded-pill">
                <i class="fas fa-plus me-2"></i>สร้างใบเสนอราคาใหม่
            </button>
        </div>

    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            // === CONFIG ===
            const FORM_URL = '@Url.Action("Form", "Request")';

            // === MAIN LOGIC ===
            loadDashboardData();

            function loadDashboardData() {
                $.ajax({
                    url: `${API_BASE}/Dashboard/Summary`,
                    method: "GET",
                    xhrFields: { withCredentials: true },
                    success: function (data) {
                        // 1. Update Widgets
                        $("#lblTotalCreated").text(data.totalCreated);
                        $("#lblTotalPending").text(data.totalPending);
                        $("#lblTotalCompleted").text(data.totalCompleted);
                        $("#lblMyTasks").text(data.myTaskCount);

                        // 2. Build Tabs
                        initTabPanel(data.myRequestCount, data.myTaskCount);
                    },
                    error: function(err) {
                        console.error("Failed to load dashboard summary", err);
                        // Initialize empty tabs on error as fallback
                        initTabPanel(0, 0);
                    }
                });
            }

            function initTabPanel(requestCount, taskCount) {
                const tabs = [];

                // Tab 1: My Requests
                if (requestCount > 0) {
                    tabs.push({
                        title: "เอกสารของฉัน (My Requests)",
                        icon: "file",
                        badge: requestCount,
                        template: () => $("<div>").addClass("grid-wrapper").append($("<div>").attr("id", "gridMyRequests"))
                    });
                }

                // Tab 2: My Tasks
                if (taskCount > 0) {
                    tabs.push({
                        title: "งานรออนุมัติ (My Tasks)",
                        icon: "check",
                        badge: taskCount,
                        template: () => $("<div>").addClass("grid-wrapper").append($("<div>").attr("id", "gridMyTasks"))
                    });
                }

                // Show Empty State if no data
                if (tabs.length === 0) {
                    $("#emptyState").removeClass("d-none");
                    return;
                }

                $("#tabPanel").dxTabPanel({
                    items: tabs,
                    height: "100%",
                    deferRendering: false,
                    itemTitleTemplate: function(itemData) {
                        const container = $("<div>").addClass("d-flex align-items-center gap-2");
                        if(itemData.icon) {
                            container.append($("<i>").addClass("dx-icon-" + itemData.icon));
                        }
                        container.append($("<span>").text(itemData.title));
                        return container;
                    },
                    onContentReady: function(e) {
                        // Init Grids when tab is ready
                        if ($("#gridMyRequests").length && !$("#gridMyRequests").data("dxDataGrid")) {
                            renderMyRequestsGrid();
                        }
                        if ($("#gridMyTasks").length && !$("#gridMyTasks").data("dxDataGrid")) {
                            renderMyTasksGrid();
                        }
                    }
                });
            }

            // === GRID CONFIGURATION ===
            const baseColumns = [
                {
                    dataField: "code",
                    caption: "เลขที่เอกสาร",
                    width: 150,
                    cellTemplate: (container, options) => {
                        const docNo = options.value || "(Draft)";
                        $("<a>")
                            .addClass("doc-link")
                            .text(docNo)
                            .attr("href", `${FORM_URL}/${options.data.id}`)
                            .appendTo(container);
                    }
                },
                {
                    dataField: "title",
                    caption: "หัวข้อ",
                    minWidth: 200,
                    allowSorting: false,
                    allowFiltering: false,
                    allowSearch: false
                },
                {
                    dataField: "vendorName",
                    caption: "ผู้ขาย",
                    width: 220
                },
                {
                    dataField: "requestDate",
                    caption: "วันที่ขอซื้อ",
                    dataType: "date",
                    format: "yyyy-MM-dd", // <--- Updated Date Format
                    width: 120,
                    alignment: "center"
                },
                {
                    dataField: "status",
                    caption: "สถานะ",
                    width: 140,
                    alignment: "center",
                    allowSorting: false,
                    allowFiltering: false,
                    allowSearch: false,
                    cellTemplate: (container, options) => {
                        // Use global helper from _DevExtremeLayout
                        const info = getStatusInfo(options.value, options.data.currentStepId);
                        $("<span>")
                            .addClass("status-badge " + info.cls)
                            .text(info.text)
                            .appendTo(container);
                    }
                },
                {
                    type: "buttons",
                    width: 70,
                    buttons: [{
                        hint: "เปิดดู",
                        icon: "arrowright",
                        onClick: (e) => window.location.href = `${FORM_URL}/${e.row.data.id}`
                    }]
                }
            ];

            function renderMyRequestsGrid() {
                $("#gridMyRequests").dxDataGrid({
                    dataSource: DevExpress.data.AspNet.createStore({
                        key: "id",
                        loadUrl: `${API_BASE}/PurchaseRequest/MyRequests`,
                        onBeforeSend: (m, ajax) => ajax.xhrFields = { withCredentials: true }
                    }),
                    height: "100%",
                    showBorders: true,
                    rowAlternationEnabled: true,
                    hoverStateEnabled: true,
                    columnAutoWidth: true,
                    filterRow: { visible: true },
                    headerFilter: { visible: true },
                    scrolling: { mode: "virtual" },
                    searchPanel: { visible: true, width: 350, placeholder: "ค้นหาเอกสาร..." },
                    columns: baseColumns,
                    onToolbarPreparing: function(e) {
                        e.toolbarOptions.items.unshift({
                            location: "before",
                            widget: "dxButton",
                            options: {
                                icon: "plus",
                                text: "สร้างใบเสนอราคาใหม่",
                                type: "default",
                                stylingMode: "contained",
                                onClick: function() { window.location.href = FORM_URL; }
                            }
                        });
                    }
                });
            }

            function renderMyTasksGrid() {
                // Add 'Requester' column for tasks grid
                const taskColumns = [
                    ...baseColumns.slice(0, 2), // Code, Title
                    {
                        dataField: "requesterName",
                        caption: "ผู้ขอซื้อ (Requester)",
                        width: 180
                    },
                    ...baseColumns.slice(2) // Vendor, Date, Status, Buttons
                ];

                $("#gridMyTasks").dxDataGrid({
                    dataSource: DevExpress.data.AspNet.createStore({
                        key: "id",
                        loadUrl: `${API_BASE}/PurchaseRequest/PendingApprovals`,
                        onBeforeSend: (m, ajax) => ajax.xhrFields = { withCredentials: true }
                    }),
                    height: "100%",
                    showBorders: true,
                    rowAlternationEnabled: true,
                    hoverStateEnabled: true,
                    columnAutoWidth: true,
                    filterRow: { visible: true },
                    headerFilter: { visible: true },
                    scrolling: { mode: "virtual" },
                    searchPanel: { visible: true, width: 350, placeholder: "ค้นหางาน..." },
                    columns: taskColumns
                });
            }

            // Create button event for empty state
            $("#btnCreateEmpty").on("click", function() { window.location.href = FORM_URL; });
        });
    </script>
}