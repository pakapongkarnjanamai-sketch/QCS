@{
    ViewData["Title"] = "รายการใบขอซื้อ (My Requests)";
}

@section Styles {
    <style>
        /* --- Link Styling --- */
        .doc-no-link {
            color: #0d6efd;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
        }

            .doc-no-link:hover {
                text-decoration: underline;
                color: #0a58ca;
            }

        /* --- Status Badge (Theme เดียวกับหน้า Detail) --- */
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            color: white;
            display: inline-block;
            min-width: 90px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-draft {
            background-color: #6c757d;
        }

        .status-pending {
            background-color: #ffc107;
            color: #212529;
        }

        .status-approved {
            background-color: #28a745;
        }

        .status-rejected {
            background-color: #dc3545;
        }

        /* --- Card & Layout --- */
        .qcs-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 20px;
            border: 1px solid #eaeaea;
        }
    </style>
}

<div class="container mt-4">
    <div class="qcs-card mb-3">
        <div class="page-header-row d-flex justify-content-between align-items-center">
            <div>
                <h6 class="page-title mb-1 d-flex align-items-center">
                    <i class="fas fa-list-alt text-primary me-2"></i>
                    <span>รายการใบขอซื้อ (My Purchase Requests)</span>
                </h6>
                <small class="text-muted ms-4 ps-2">รายการเอกสารที่คุณสร้างและสถานะปัจจุบัน</small>
            </div>

            <a href="@Url.Action("Create", "PurchaseRequest")" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i> สร้างใบขอซื้อใหม่
            </a>
        </div>
    </div>

    <div class="qcs-card">
        <div id="requestsGrid"></div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            // === 1. CONFIGURATION ===
            const CONFIG = {
                API_URL: "https://localhost:7127/api/PurchaseRequest/MyRequests",
                DETAIL_URL: '@Url.Action("Detail", "PurchaseRequest")'
            };

            // === 2. DATA STORE ===
            const store = DevExpress.data.AspNet.createStore({
                key: "id",
                loadUrl: CONFIG.API_URL,
                onBeforeSend: function(method, ajaxOptions) {
                    ajaxOptions.xhrFields = { withCredentials: true };
                }
            });

            // === 3. RENDER GRID ===
            $("#requestsGrid").dxDataGrid({
                dataSource: store,
                showBorders: true,
                showRowLines: true,
                columnAutoWidth: true,
                hoverStateEnabled: true,
                rowAlternationEnabled: true,
                searchPanel: { visible: true, width: 250, placeholder: "ค้นหาเอกสาร..." },
                filterRow: { visible: true },
                paging: { pageSize: 10 },
                pager: {
                    showPageSizeSelector: true,
                    allowedPageSizes: [10, 20, 50],
                    showInfo: true
                },
                selection: { mode: "single" },
                // คลิกแถวเพื่อไปหน้า Detail
                onRowClick: function(e) {
                    if(e.rowType === "data") {
                        goToDetail(e.data.id);
                    }
                },
                columns: [
                    {
                        dataField: "code",
                        caption: "เลขที่เอกสาร",
                        width: 160,
                        alignment: "center",
                        cellTemplate: function(container, options) {
                            // แสดงเป็น Link สีน้ำเงิน
                            $("<span>")
                                .addClass("doc-no-link")
                                .text(options.value)
                                .on("click", function(e) {
                                    e.stopPropagation(); // ป้องกัน row click ซ้ำซ้อน
                                    goToDetail(options.data.id);
                                })
                                .appendTo(container);
                        }
                    },
                    {
                        dataField: "title",
                        caption: "หัวข้อการจัดซื้อ (Title)",
                        minWidth: 200
                    },
                    {
                        dataField: "vendorName",
                        caption: "ผู้ขาย (Vendor)",
                        width: 200
                    },
                    {
                        dataField: "requestDate",
                        caption: "วันที่สร้าง",
                        dataType: "date",
                        format: "dd/MM/yyyy",
                        width: 120,
                        alignment: "center"
                    },
                    {
                        dataField: "status",
                        caption: "สถานะ",
                        width: 150,
                        alignment: "center",
                        cellTemplate: function (container, options) {
                            // ใช้ Helper Map Status (Int -> Text/Class)
                            const s = mapStatus(options.value);
                            $("<span>")
                                .addClass("status-badge " + s.cls)
                                .text(s.text)
                                .appendTo(container);
                        }
                    },
                    {
                        type: "buttons",
                        width: 80,
                        buttons: [{
                            hint: "ดูรายละเอียด",
                            icon: "find",
                            onClick: function(e) {
                                goToDetail(e.row.data.id);
                            }
                        }]
                    }
                ]
            });

            // === HELPER FUNCTIONS ===

            function goToDetail(id) {
                window.location.href = `${CONFIG.DETAIL_URL}/${id}`;
            }

            // แปลง Status ID (Int) เป็น Text และ CSS Class
            function mapStatus(status) {
                // 0=Draft, 1=Pending, 2=Approved, 9=Rejected
                if (status == 0) return { text: 'Draft', cls: 'status-draft' };
                if (status == 1) return { text: 'Pending', cls: 'status-pending' };
                if (status == 2) return { text: 'Approved', cls: 'status-approved' };
                if (status == 9) return { text: 'Rejected', cls: 'status-rejected' };

                // กรณีไม่ตรงเงื่อนไข (หรือ Status เป็น null)
                return { text: 'Unknown', cls: 'status-draft' };
            }
        });
    </script>
}