@{
    ViewData["Title"] = "รายการใบขอซื้อ (My Requests)";
}

@section Styles {
    <style>
        .doc-no-link {
            color: #0d6efd;
            font-weight: 500;
            text-decoration: none;
        }

            .doc-no-link:hover {
                text-decoration: underline;
            }

        /* Status Badge Styling (Theme เดียวกับหน้า Create/Detail) */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
            color: white;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }

        .status-draft {
            background-color: #6c757d;
        }

        .status-pending {
            background-color: #ffc107;
            color: #000;
        }

        .status-approved {
            background-color: #28a745;
        }

        .status-rejected {
            background-color: #dc3545;
        }
    </style>
}

<div class="container mt-4">
    <div class="qcs-card mb-3">
        <div class="page-header-row d-flex justify-content-between align-items-center">
            <div>
                <h6 class="page-title mb-1">
                    <i class="fas fa-list-alt text-primary me-2"></i>
                    รายการใบขอซื้อ (My Purchase Requests)
                </h6>
                <small class="text-muted ms-4 ps-2">รายการเอกสารที่คุณสร้างและสถานะปัจจุบัน</small>
            </div>

            <a href="@Url.Action("Create", "PurchaseRequest")" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i> สร้างใบขอซื้อใหม่
            </a>
        </div>
    </div>

    <div class="qcs-card">
        <div id="requestsGrid"></div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            // === 1. CONFIGURATION ===
            const CONFIG = {
                API_URL: "https://localhost:7127/api/PurchaseRequest/MyRequests",
                DETAIL_URL: '@Url.Action("Detail", "PurchaseRequest")'
            };

            // === 2. DATA STORE ===
            const store = DevExpress.data.AspNet.createStore({
                key: "id",
                loadUrl: CONFIG.API_URL,
                onBeforeSend: function(method, ajaxOptions) {
                    ajaxOptions.xhrFields = { withCredentials: true }; // สำคัญ: ส่ง Cookie/Auth ไปด้วย
                }
            });

            // === 3. RENDER GRID ===
            $("#requestsGrid").dxDataGrid({
                dataSource: store,
                showBorders: true,
                columnAutoWidth: true,
                hoverStateEnabled: true,
                rowAlternationEnabled: true,
                searchPanel: { visible: true, width: 250, placeholder: "ค้นหาเอกสาร..." },
                filterRow: { visible: true },
                paging: { pageSize: 10 },
                pager: { showPageSizeSelector: true, allowedPageSizes: [10, 20, 50], showInfo: true },
                selection: { mode: "single" },
                // คลิกแถวเพื่อไปหน้า Detail
                onRowClick: function(e) {
                    if(e.rowType === "data") {
                        window.location.href = `${CONFIG.DETAIL_URL}/${e.data.id}`;
                    }
                },
                columns: [
                    {
                        dataField: "code",
                        caption: "เลขที่เอกสาร",
                        width: 160,
                        cellTemplate: function(container, options) {
                            // แสดงเป็น Link สีน้ำเงิน
                            $("<span>").addClass("doc-no-link").text(options.value).appendTo(container);
                        }
                    },
                    {
                        dataField: "title",
                        caption: "หัวข้อการจัดซื้อ (Title)",
                        minWidth: 200
                    },
                    {
                        dataField: "vendorName", // เพิ่มคอลัมน์ Vendor ตาม Model ใหม่
                        caption: "ผู้ขาย (Vendor)",
                        width: 200
                    },
                    {
                        dataField: "requestDate",
                        caption: "วันที่สร้าง",
                        dataType: "date",
                        format: "dd/MM/yyyy",
                        width: 120,
                        alignment: "center"
                    },
                    {
                        dataField: "status",
                        caption: "สถานะ",
                        width: 150,
                        alignment: "center",
                        cellTemplate: function (container, options) {
                            const statusText = options.value || "Draft";
                            const cssClass = getStatusClass(statusText);

                            $("<span>")
                                .addClass("status-badge " + cssClass)
                                .text(statusText)
                                .appendTo(container);
                        }
                    },
                    {
                        type: "buttons",
                        width: 60,
                        buttons: [{
                            hint: "ดูรายละเอียด",
                            icon: "find",
                            onClick: function(e) {
                                window.location.href = `${CONFIG.DETAIL_URL}/${e.row.data.id}`;
                            }
                        }]
                    }
                ]
            });

            // Helper: แปลงข้อความสถานะเป็นชื่อ CSS Class
            function getStatusClass(status) {
                if (!status) return "status-draft";
                const s = status.toLowerCase();

                if (s.includes('pending')) return "status-pending";
                if (s === 'approved') return "status-approved";
                if (s === 'rejected') return "status-rejected";

                return "status-draft";
            }
        });
    </script>
}