@{
    ViewData["Title"] = "Create Purchase Request";
}

@section Styles {
    <style>
     
        .form-container {
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
        }
        .file-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

            .file-info i {
                color: #f05b41;
                font-size: 1.2em;
            }

        .upload-instructions {
            margin-top: 8px;
            color: #666;
            font-size: 0.85em;
        }

        .attachments-container {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px dashed #ced4da;
        }
    </style>
}

<div class="container mt-4">
    <div class="form-container mb-3">
        <h4><i class="fas fa-plus-circle text-primary me-2"></i>สร้างใบขอซื้อใหม่ (New Request)</h4>
        <div id="actionButtons"></div>
    </div>

    <div class="form-container">
        <div id="quotationForm"></div>
    </div>
</div>

<div id="loadingIndicator"></div>

@section Scripts {
    <script>
        $(function () {
            // === CONFIGURATION ===
            const API_BASE_URL = "https://localhost:7127/api";
            const VENDOR_API_URL = "https://ap-ntc2138-qawb/iChaSue/Service/Supplier/api";

            // === DATA STORE ===
            const vendorStore = DevExpress.data.AspNet.createStore({
                key: "id",
                loadUrl: VENDOR_API_URL + "/Suppliers",
                onBeforeSend: function(method, ajaxOptions) {
                    ajaxOptions.xhrFields = { withCredentials: true };
                }
            });

            const mockDocumentTypes = [
                { id: 10, name: 'Main Quotation' },
                { id: 20, name: 'Specifications' },
                { id: 30, name: 'Terms & Conditions' }
            ];

            // === DATA MODEL ===
            const requestData = {
                documentName: "",
                // requestDate ถูกตัดออกจากหน้าจอ (จะ auto assign ตอน submit)

                // ย้ายข้อมูลเหล่านี้มาอยู่ที่ Header แทน
                vendorId: null,
                validFrom: new Date(),
                validUntil: new Date(new Date().setMonth(new Date().getMonth() + 3)),
                comment: "",

                attachments: []
            };

            let fileList = [];
            let attachmentGridInstance = null;
            let formInstance = null;

            // === INITIALIZATION ===
            const loadingIndicator = $("#loadingIndicator").dxLoadPanel({
                shadingColor: "rgba(0,0,0,0.4)",
                visible: false,
                showIndicator: true,
                showPane: true,
                shading: true,
                position: { of: "body" }
            }).dxLoadPanel("instance");

            renderForm();
            renderActionButtons();

            // === RENDER FUNCTIONS ===
            function renderForm() {
                formInstance = $("#quotationForm").dxForm({
                    formData: requestData,
                    colCount: 2,
                    labelLocation: "top",
                    items: [
                        {
                            itemType: "group",
                            caption: "ข้อมูลเอกสาร (Document Info)",
                            colCount: 2,
                            colSpan: 2,
                            items: [
                                {
                                    dataField: "documentName",
                                    label: { text: "หัวข้อการจัดซื้อ (Title)" },
                                    editorOptions: { placeholder: "เช่น จัดซื้ออุปกรณ์สำนักงาน..." },
                                    colSpan: 1,
                                    validationRules: [{ type: "required", message: "กรุณาระบุหัวข้อ" }]
                                },
                                // ย้าย Vendor มาที่นี่
                                {
                                    dataField: "vendorId",
                                    label: { text: "ผู้ขาย (Vendor)" },
                                    editorType: "dxSelectBox",
                                    editorOptions: {
                                        dataSource: vendorStore,
                                        valueExpr: "Id",
                                        displayExpr: "Name",
                                        searchEnabled: true,
                                        placeholder: "เลือก Vendor..."
                                    },
                                    colSpan: 1, // ให้กว้างเต็มบรรทัด
                                    validationRules: [{ type: "required", message: "กรุณาเลือก Vendor" }]
                                },
                                // ย้าย Valid From/Until มาที่นี่
                                {
                                    dataField: "validFrom",
                                    label: { text: "ราคาใช้ได้ตั้งแต่ (Valid From)" },
                                    editorType: "dxDateBox",
                                    editorOptions: { displayFormat: "dd/MM/yyyy", type: "date" },
                                    validationRules: [{ type: "required" }]
                                },
                                {
                                    dataField: "validUntil",
                                    label: { text: "ถึงวันที่ (Valid Until)" },
                                    editorType: "dxDateBox",
                                    editorOptions: { displayFormat: "dd/MM/yyyy", type: "date" },
                                    validationRules: [{ type: "required" }]
                                },
                                // ย้าย Comment มาที่นี่
                                {
                                    dataField: "comment",
                                    label: { text: "หมายเหตุ (Comment)" },
                                    editorType: "dxTextArea",
                                    editorOptions: { height: 80 },
                                    colSpan: 2
                                }
                            ]
                        },
                        {
                            itemType: "group",
                            caption: "เอกสารแนบ (Attachments)",
                            colSpan: 2,
                            items: [{
                                template: renderAttachmentsSection
                            }]
                        }
                    ]
                }).dxForm("instance");
            }

            function renderAttachmentsSection(data, itemElement) {
                const $container = $("<div>").addClass("attachments-container");

                // 1. File Uploader
                $("<div>").dxFileUploader({
                    multiple: true,
                    accept: ".pdf",
                    uploadMode: "useForm",
                    showFileList: false,
                    labelText: "ลากไฟล์ PDF มาวางที่นี่ หรือคลิกเพื่อเลือกไฟล์",
                    selectButtonText: "เลือกไฟล์ (Select Files)",
                    allowedFileExtensions: ['.pdf'],
                    onValueChanged: function (e) {
                        if (e.value && e.value.length > 0) {
                            e.value.forEach(file => handleFileUpload(file));
                            e.component.reset();
                        }
                    }
                }).appendTo($container);

                // 2. Grid (ตัดคอลัมน์ที่ไม่ใช้ออก)
                attachmentGridInstance = $("<div>").dxDataGrid({
                    dataSource: requestData.attachments,
                    showBorders: true,
                    paging: { enabled: false },
                    noDataText: "ยังไม่มีไฟล์แนบ",
                    columnAutoWidth: true,
                    editing: {
                        mode: "cell",
                        allowUpdating: true,
                        allowDeleting: true,
                        useIcons: true
                    },
                    onRowRemoved: function(e) {
                        fileList = fileList.filter(f => f.name !== e.data.fileName);
                    },
                    columns: [
                        {
                            dataField: "fileName",
                            caption: "ชื่อไฟล์",
                            allowEditing: false,
                            cellTemplate: function (container, options) {
                                $("<div>").addClass("file-info")
                                    .append($("<i>").addClass("fas fa-file-pdf"), $("<span>").text(options.value))
                                    .appendTo(container);
                            }
                        },
                        {
                            dataField: "fileSize",
                            caption: "ขนาด",
                            width: 100,
                            allowEditing: false,
                            customizeText: function (cellInfo) {
                                return formatFileSize(cellInfo.value);
                            }
                        },
                        {
                            dataField: "documentType",
                            caption: "ประเภทเอกสาร",
                            width: 250,
                            lookup: {
                                dataSource: mockDocumentTypes,
                                valueExpr: "id",
                                displayExpr: "name"
                            },
                            validationRules: [{ type: "required" }]
                        },
                        {
                            type: "buttons",
                            width: 50,
                            buttons: ["delete"]
                        }
                    ]
                }).dxDataGrid("instance");

                attachmentGridInstance.element().appendTo($container);
                $container.appendTo(itemElement);
            }

            function renderActionButtons() {
                $("#actionButtons").dxToolbar({
                    items: [
                        {
                            location: 'after',
                            widget: 'dxButton',
                            options: {
                                text: 'ยกเลิก',
                                stylingMode: 'outlined',
                                onClick: () => window.location.href = '@Url.Action("Index", "Home")'
                            }
                        },
                        {
                            location: 'after',
                            widget: 'dxButton',
                            options: {
                                text: 'บันทึกข้อมูล',
                                icon: 'save',
                                type: 'default',
                                onClick: submitData
                            }
                        }
                    ]
                });
            }

            // === LOGIC FUNCTIONS ===

            function handleFileUpload(file) {
                if (file.type !== "application/pdf") {
                    DevExpress.ui.notify("รองรับเฉพาะไฟล์ PDF เท่านั้น", "error", 2000);
                    return;
                }

                if (fileList.some(f => f.name === file.name && f.size === file.size)) {
                    DevExpress.ui.notify("ไฟล์นี้ถูกเพิ่มไปแล้ว", "warning", 2000);
                    return;
                }

                fileList.push(file);

                // Default Values for Grid Item
                requestData.attachments.push({
                    tempId: generateUUID(),
                    fileName: file.name,
                    fileSize: file.size,
                    documentType: mockDocumentTypes[0].id
                });

                if (attachmentGridInstance) {
                    attachmentGridInstance.option("dataSource", requestData.attachments);
                    attachmentGridInstance.refresh();
                }
            }

            async function submitData() {
                if (!formInstance.validate().isValid) {
                    DevExpress.ui.notify("กรุณากรอกข้อมูลให้ครบถ้วน", "error", 2000);
                    return;
                }

                if (requestData.attachments.length === 0) {
                    DevExpress.ui.notify("กรุณาแนบไฟล์อย่างน้อย 1 รายการ", "error", 2000);
                    return;
                }

                loadingIndicator.show();

                try {
                    const formData = new FormData();

                    // Header Fields
                    formData.append("Title", requestData.documentName);
                    // RequestDate ถูกตัดจากหน้าจอ ให้ใช้วันที่ปัจจุบัน
                    formData.append("RequestDate", new Date().toISOString());

                    // Map Attachments to JSON
                    // นำข้อมูล Vendor/Date/Comment จาก Header ไปใส่ในทุก Item ของ Attachments
                    const quotationsInfo = requestData.attachments.map(att => ({
                        FileName: att.fileName,

                        // ใช้ข้อมูลจาก Header (requestData) แทนข้อมูลใน row
                        VendorId: requestData.vendorId,
                        VendorName: "Vendor_" + requestData.vendorId, // (หรือให้ Backend ไปหาชื่อเองจาก ID)
                        TotalAmount: 0, // ยกเลิกการกรอก TotalAmount -> ส่ง 0 ไปก่อน

                        DocumentTypeId: att.documentType,

                        // ใช้ข้อมูลจาก Header
                        ValidFrom: requestData.validFrom ? requestData.validFrom.toISOString() : null,
                        ValidUntil: requestData.validUntil ? requestData.validUntil.toISOString() : null,
                        Comment: requestData.comment
                    }));

                    formData.append("QuotationsJson", JSON.stringify(quotationsInfo));

                    // Append File Objects
                    fileList.forEach(file => {
                        formData.append("Attachments", file);
                    });

                    const response = await fetch(`${API_BASE_URL}/PurchaseRequest/Create`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText || "Server returned error");
                    }

                    DevExpress.ui.notify("บันทึกข้อมูลสำเร็จ", "success", 2000);
                    setTimeout(() => {
                        window.location.href = '@Url.Action("Index", "Home")';
                    }, 1000);

                } catch (err) {
                    console.error(err);
                    DevExpress.ui.notify("เกิดข้อผิดพลาด: " + err.message, "error", 4000);
                } finally {
                    loadingIndicator.hide();
                }
            }

            function formatFileSize(bytes) {
                if (!bytes) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            function generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
        });
    </script>
}