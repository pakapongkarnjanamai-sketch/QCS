@{
    ViewData["Title"] = "สร้างใบขอซื้อ (Create Purchase Request)";
}

@section Styles {
    <style>
        /* --- Layout & Card --- */
        .qcs-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 20px;
            border: 1px solid #eaeaea;
        }

        .mt-card {
            margin-top: 20px;
        }

        /* --- Attachments --- */
        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .file-info i {
                color: #f05b41;
                font-size: 1.2em;
            }

        .attachments-container {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px dashed #dee2e6;
        }

        /* --- Workflow Grid --- */
        .current-user-row {
            font-weight: bold;
            color: #007bff;
        }

        .row-current-step {
            background-color: #e8f4ff !important;
            font-weight: 500;
        }

            .row-current-step td {
                border-top: 2px solid #007bff !important;
                border-bottom: 2px solid #007bff !important;
            }

        /* --- Badges & States --- */
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }

        .status-draft {
            background-color: #6c757d;
        }

        .unauthorized-overlay {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
}

<div class="container mt-4">
    <div class="qcs-card mb-3">
        <div class="page-header-row">
            <h6 class="page-title d-flex align-items-center text-nowrap">
                <i class="fas fa-file-invoice text-primary me-2"></i>
                <span>สร้างใบขอซื้อใหม่ (New Request)</span>
            </h6>
            <div id="actionButtons"></div>
        </div>
    </div>

    <div class="qcs-card" id="formContainer">
        <div id="quotationForm"></div>
    </div>

    <div class="qcs-card mt-card">
        <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
            <h6 class="m-0 text-secondary font-weight-bold">
                <i class="fas fa-project-diagram me-2"></i>
                เส้นทางการอนุมัติ (Approval Route)
            </h6>
        </div>
        <div id="workflowRouteGrid"></div>
    </div>
</div>

<div id="actionPopup">
    <div class="p-2">
        <div id="actionReasonBox"></div>
        <div class="mt-3 d-flex justify-content-end gap-2">
            <div id="btnConfirmAction"></div>
            <div id="btnCancelAction"></div>
        </div>
    </div>
</div>

<div id="loadingIndicator"></div>

@section Scripts {
    <script>
        $(function () {
            // === 1. CONFIGURATION ===
            const CONFIG = {
                API_BASE_URL: "https://localhost:7127/api",
                API_SAVE_ENDPOINT: '/PurchaseRequest/Save',     // Endpoint บันทึกร่าง
                API_SUBMIT_ENDPOINT: '/PurchaseRequest/Submit', // Endpoint ส่งอนุมัติ
                API_WORKFLOW_ROUTE: '/Workflow/route/1',
                // เปลี่ยนไปใช้ Proxy ของ Backend เราเอง
                VENDOR_API_URL: "/Vendor"
            };

            const documentTypes = [
                { id: 10, name: 'Main Quotation (ใบเสนอราคาหลัก)' },
                { id: 20, name: 'Specifications (รายละเอียดสเปค)' },
                { id: 30, name: 'Terms & Conditions (เงื่อนไข)' }
            ];

            // === 2. STATE & STORES ===
            const requestData = {
                documentName: "",
                vendorId: null,
                validFrom: new Date(),
                validUntil: new Date(new Date().setMonth(new Date().getMonth() + 1)),
                comment: "",
                attachments: []
            };

            const vendorStore = DevExpress.data.AspNet.createStore({
                key: "id",
                loadUrl: CONFIG.API_BASE_URL + CONFIG.VENDOR_API_URL, // ใช้ URL Proxy
                onBeforeSend: function(method, ajaxOptions) {
                    ajaxOptions.xhrFields = { withCredentials: true };
                }
            });

            let fileList = [];
            let attachmentGridInstance = null;
            let formInstance = null;
            let toolbarInstance = null;
            let actionPopupInstance = null;

            const loadingIndicator = $("#loadingIndicator").dxLoadPanel({
                shadingColor: "rgba(0,0,0,0.4)",
                position: { of: "body" }, visible: false, showIndicator: true, showPane: true, shading: true, message: "กำลังตรวจสอบข้อมูล..."
            }).dxLoadPanel("instance");

            // === 3. INITIALIZATION ===
            initToolbar();
            initForm();
            initActionPopup();
            loadWorkflowRoute();

            // === 4. UI RENDERERS ===

            function initToolbar() {
                toolbarInstance = $("#actionButtons").dxToolbar({
                    items: [
                        {
                            location: 'after', widget: 'dxButton',
                            options: {
                                text: 'ยกเลิก', stylingMode: 'outlined', icon: 'close',
                                onClick: () => window.location.href = '@Url.Action("Index", "PurchaseRequest")'
                            }
                        },
                        {
                            location: 'after', widget: 'dxButton',
                            options: {
                                elementAttr: { id: "btnSave" },
                                text: 'บันทึก (Save)',
                                icon: 'save',
                                stylingMode: 'outlined',
                                type: 'default',
                                disabled: true,
                                onClick: onSaveClick
                            }
                        },
                        {
                            location: 'after', widget: 'dxButton',
                            options: {
                                elementAttr: { id: "btnSubmit" },
                                text: 'ส่งอนุมัติ (Submit)',
                                icon: 'check',
                                type: 'default',
                                disabled: true,
                                onClick: onSubmitClick
                            }
                        }
                    ]
                }).dxToolbar("instance");
            }

            function initForm() {
                formInstance = $("#quotationForm").dxForm({
                    formData: requestData,
                    colCount: 2,
                    labelLocation: "top",
                    items: [
                        {
                            itemType: "group", caption: "1. ข้อมูลทั่วไป (General Information)", colSpan: 2, colCount: 2,
                            items: [
                                {
                                    dataField: "documentName", label: { text: "หัวข้อการจัดซื้อ (Title)" },
                                    editorOptions: { placeholder: "ระบุชื่องาน หรือรายการที่ต้องการซื้อ..." }, colSpan: 1,
                                    validationRules: [{ type: "required", message: "กรุณาระบุหัวข้อ" }]
                                },
                                {
                                    dataField: "vendorId", label: { text: "ผู้ขาย (Vendor)" },
                                    editorType: "dxSelectBox",
                                    editorOptions: {
                                        dataSource: vendorStore, valueExpr: "Id", displayExpr: "Name",
                                        searchEnabled: true, placeholder: "ค้นหาและเลือกผู้ขาย..."
                                    },
                                    colSpan: 1,
                                    validationRules: [{ type: "required", message: "กรุณาเลือก Vendor" }]
                                },
                                {
                                    dataField: "validFrom", label: { text: "วันที่เริ่มยืนราคา (Valid From)" },
                                    editorType: "dxDateBox", editorOptions: { displayFormat: "dd/MM/yyyy", type: "date" },
                                    validationRules: [{ type: "required" }]
                                },
                                {
                                    dataField: "validUntil", label: { text: "ถึงวันที่ (Valid Until)" },
                                    editorType: "dxDateBox", editorOptions: { displayFormat: "dd/MM/yyyy", type: "date" },
                                    validationRules: [{ type: "required" }]
                                },
                                {
                                    dataField: "comment", label: { text: "หมายเหตุ (Comment)" },
                                    editorType: "dxTextArea", editorOptions: { height: 80, placeholder: "รายละเอียดเพิ่มเติม..." }, colSpan: 2
                                }
                            ]
                        },
                        {
                            itemType: "group", caption: "2. เอกสารแนบ (Attachments)", colSpan: 2,
                            items: [{ template: renderAttachmentsSection }]
                        }
                    ]
                }).dxForm("instance");
            }

            // === 5. ACTION LOGIC ===

            function initActionPopup() {
                actionPopupInstance = $("#actionPopup").dxPopup({
                    width: 400, height: "auto", visible: false, dragEnabled: true,
                    hideOnOutsideClick: false, showCloseButton: true, title: "ยืนยันการส่งอนุมัติ (Confirm Submit)",
                    contentTemplate: function(contentElement) {
                        const container = $("<div>").addClass("p-1");
                        $("<div>").attr("id", "actionReasonInput").dxTextArea({
                            height: 100, placeholder: "ระบุความเห็นเพิ่มเติม (ถ้ามี)..."
                        }).appendTo(container);

                        const btnGroup = $("<div>").addClass("mt-3 text-end").appendTo(container);
                        $("<div>").dxButton({
                            text: "ยกเลิก (Cancel)", stylingMode: "outlined", type: "normal",
                            onClick: () => actionPopupInstance.hide()
                        }).addClass("me-2").appendTo(btnGroup);

                        $("<div>").dxButton({
                            text: "ยืนยัน (Confirm)", stylingMode: "contained", type: "default",
                            elementAttr: { id: "btnActionConfirm" },
                            onClick: confirmAction
                        }).appendTo(btnGroup);

                        container.appendTo(contentElement);
                    }
                }).dxPopup("instance");
            }

            function onSaveClick() {
                if (!validateForm()) return;
                submitData(false, null); // Save Draft
            }

            function onSubmitClick() {
                if (!validateForm()) return;
                const textArea = $("#actionReasonInput").dxTextArea("instance");
                if (textArea) {
                    textArea.reset();
                    textArea.option("value", requestData.comment);
                }
                actionPopupInstance.show();
            }

            function confirmAction() {
                const textArea = $("#actionReasonInput").dxTextArea("instance");
                const extraComment = textArea.option("value") || "";
                actionPopupInstance.hide();
                submitData(true, extraComment); // Submit
            }

            function validateForm() {
                const validationResult = formInstance.validate();
                if (!validationResult.isValid) return false;
                if (requestData.attachments.length === 0) {
                    DevExpress.ui.notify("กรุณาแนบไฟล์อย่างน้อย 1 รายการ", "error", 2000);
                    return false;
                }
                return true;
            }

            // === 6. DATA SUBMISSION ===

            async function submitData(isSubmit, popupComment) {
                loadingIndicator.show();
                try {
                    const endpoint = isSubmit ? CONFIG.API_SUBMIT_ENDPOINT : CONFIG.API_SAVE_ENDPOINT;
                    const formData = new FormData();
                    formData.append("Title", requestData.documentName);

                    const vendorEditor = formInstance.getEditor("vendorId");
                    formData.append("VendorId", requestData.vendorId);
                    formData.append("VendorName", vendorEditor.option("displayValue") || "");

                    if(requestData.validFrom) formData.append("ValidFrom", requestData.validFrom.toISOString());
                    if(requestData.validUntil) formData.append("ValidUntil", requestData.validUntil.toISOString());

                    const finalComment = (popupComment !== null) ? popupComment : (requestData.comment || "");
                    formData.append("Comment", finalComment);

                    const quotationsMeta = requestData.attachments.map(att => ({
                        FileName: att.fileName,
                        DocumentTypeId: att.documentType
                    }));
                    formData.append("QuotationsJson", JSON.stringify(quotationsMeta));

                    fileList.forEach(file => { formData.append("Attachments", file); });

                    const response = await fetch(CONFIG.API_BASE_URL + endpoint, {
                        method: 'POST', body: formData, credentials: 'include'
                    });

                    if (!response.ok) throw new Error(await response.text());

                    const result = await response.json();
                    const actionText = isSubmit ? "ส่งอนุมัติ" : "บันทึกร่าง";
                    DevExpress.ui.notify(`${actionText}สำเร็จ (เลขที่: ${result.docNo})`, "success", 2000);

                    setTimeout(() => { window.location.href = '@Url.Action("Index", "PurchaseRequest")'; }, 1500);
                } catch (err) {
                    console.error("Submit Error:", err);
                    DevExpress.ui.notify("เกิดข้อผิดพลาด: " + err.message, "error", 5000);
                } finally {
                    loadingIndicator.hide();
                }
            }

            // === 7. WORKFLOW & FILES ===

            function loadWorkflowRoute() {
                loadingIndicator.show();
                $.ajax({
                    url: CONFIG.API_BASE_URL + CONFIG.API_WORKFLOW_ROUTE,
                    type: 'GET', xhrFields: { withCredentials: true },
                    success: function (data) {
                        if (data && data.steps) {
                            renderWorkflowRouteGrid(data, 1);

                            const isAuthorized = data.canInitiate;
                            const items = toolbarInstance.option("items");
                            const btnSave = items.find(i => i.options && i.options.elementAttr && i.options.elementAttr.id === "btnSave");
                            const btnSubmit = items.find(i => i.options && i.options.elementAttr && i.options.elementAttr.id === "btnSubmit");

                            if (isAuthorized) {
                                if(btnSave) btnSave.options.disabled = false;
                                if(btnSubmit) btnSubmit.options.disabled = false;
                            } else {
                                if(btnSave) btnSave.options.disabled = true;
                                if(btnSubmit) btnSubmit.options.disabled = true;
                                $("#formContainer").addClass("unauthorized-overlay");
                                DevExpress.ui.notify("คุณไม่มีสิทธิ์สร้างเอกสารในขั้นตอนนี้", "warning", 5000);
                            }
                            toolbarInstance.option("items", items);
                        }
                    },
                    complete: function() { loadingIndicator.hide(); }
                });
            }

            function renderWorkflowRouteGrid(routeData, currentStepId) {
                const gridData = routeData.steps.map(step => ({
                    sequenceNo: step.sequenceNo, stepName: step.stepName, rawAssignments: step.assignments,
                    status: 0, approverName: null, actionDate: null, comment: null
                }));

                $("#workflowRouteGrid").dxDataGrid({
                    dataSource: gridData, showBorders: true, showRowLines: true, columnAutoWidth: true, paging: { enabled: false },
                    noDataText: "กำลังโหลดข้อมูลเส้นทาง...",
                    onRowPrepared: function(e) {
                        if (e.rowType === "data" && e.data.sequenceNo === currentStepId) e.rowElement.addClass("row-current-step");
                    },
                    columns: [
                        { dataField: "sequenceNo", caption: "ลำดับ", width: 60, alignment: "center" },
                        { dataField: "stepName", caption: "ขั้นตอน", width: 200 },
                        {
                            dataField: "assignees", caption: "ผู้มีสิทธิ์", width: 250,
                            cellTemplate: function(container, options) {
                                const assignments = options.data.rawAssignments || [];
                                if(assignments.length === 0) { $("<span>").text("Any").appendTo(container); return; }
                                assignments.forEach(a => {
                                    const name = a.employeeName || a.nId;
                                    const $div = $("<div>");
                                    if (a.isCurrentUser) $div.addClass("current-user-row").html(`<i class="fas fa-user-circle me-1"></i>${name} (You)`);
                                    else $div.html(`<i class="fas fa-user text-muted me-1"></i>${name}`);
                                    $div.appendTo(container);
                                });
                            }
                        },
                        { dataField: "status", caption: "สถานะ", width: 100, alignment: "center", cellTemplate: (c) => $("<span>").addClass("status-badge status-draft").text("Waiting").appendTo(c) },
                        { dataField: "approverName", caption: "ผู้ดำเนินการ", width: 150, customizeText: () => "-" },
                        { dataField: "actionDate", caption: "วันที่", width: 120, alignment: "center", customizeText: () => "" },
                        { dataField: "comment", caption: "ความเห็น", customizeText: () => "-" }
                    ]
                }).dxDataGrid("instance");
            }

            function renderAttachmentsSection(data, itemElement) {
                const $container = $("<div>").addClass("attachments-container");
                $("<div>").dxFileUploader({
                    multiple: true, accept: ".pdf", uploadMode: "useForm", showFileList: false,
                    labelText: "ลากไฟล์ PDF มาวางที่นี่ หรือคลิกเพื่อเลือกไฟล์", selectButtonText: "เพิ่มไฟล์",
                    allowedFileExtensions: ['.pdf'],
                    onValueChanged: function (e) {
                        if (e.value && e.value.length > 0) {
                            e.value.forEach(file => handleFileUpload(file));
                            e.component.reset();
                        }
                    }
                }).appendTo($container);

                attachmentGridInstance = $("<div>").dxDataGrid({
                    dataSource: requestData.attachments, showBorders: true, paging: { enabled: false },
                    noDataText: "ยังไม่มีไฟล์แนบ", columnAutoWidth: true, hoverStateEnabled: true,
                    editing: { mode: "cell", allowUpdating: true, allowDeleting: true, useIcons: true },
                    columns: [
                        {
                            dataField: "fileName", caption: "ชื่อไฟล์",
                            cellTemplate: (c, o) => $("<div>").addClass("file-info").append($("<i>").addClass("fas fa-file-pdf")).append($("<span>").text(o.value)).appendTo(c)
                        },
                        { dataField: "fileSize", caption: "ขนาด", width: 100, alignment: "center", customizeText: (cell) => formatFileSize(cell.value) },
                        { dataField: "documentType", caption: "ประเภทเอกสาร", width: 250, lookup: { dataSource: documentTypes, valueExpr: "id", displayExpr: "name" } },
                        {
                            type: "buttons", width: 60, buttons: [{
                                name: "delete", onClick: (e) => {
                                    fileList = fileList.filter(f => f.name !== e.row.data.fileName);
                                    const index = requestData.attachments.indexOf(e.row.data);
                                    if (index > -1) { requestData.attachments.splice(index, 1); e.component.refresh(); }
                                }
                            }]
                        }
                    ]
                }).dxDataGrid("instance");
                attachmentGridInstance.element().appendTo($container);
                $container.appendTo(itemElement);
            }

            function handleFileUpload(file) {
                if (file.type !== "application/pdf") { DevExpress.ui.notify("รองรับเฉพาะไฟล์ PDF เท่านั้น", "error", 3000); return; }
                if (fileList.some(f => f.name === file.name && f.size === file.size)) { DevExpress.ui.notify(`ไฟล์ ${file.name} ถูกเพิ่มไปแล้ว`, "warning", 3000); return; }
                fileList.push(file);
                requestData.attachments.push({
                    tempId: generateUUID(), fileName: file.name, fileSize: file.size, documentType: documentTypes[0].id
                });
                if (attachmentGridInstance) attachmentGridInstance.refresh();
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024, sizes = ['Bytes', 'KB', 'MB', 'GB'], i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            function generateUUID() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => (c==='x'?Math.random()*16|0:(Math.random()*16|0)&0x3|0x8).toString(16)); }
        });
    </script>
}