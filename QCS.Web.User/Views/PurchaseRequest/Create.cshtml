@{
    ViewData["Title"] = "สร้างใบขอซื้อ (Create Purchase Request)";
}

@section Styles {
    <style>
        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .file-info i {
                color: #d9534f;
                font-size: 1.4em;
            }

        .attachments-container {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px dashed #dee2e6;
        }

        /* Status Badge Styling for Approval Flow */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
            color: white;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }

        .status-pending {
            background-color: #6c757d; /* สีเทา */
        }

        .status-review {
            background-color: #ffc107; /* สีเหลือง */
            color: #000;
        }

        .status-approved {
            background-color: #28a745; /* สีเขียว */
        }

        /* ระยะห่างระหว่าง Card */
        .mt-card {
            margin-top: 20px;
        }
    </style>
}

<div class="container mt-4">
    <div class="qcs-card mb-3">
        <div class="page-header-row">
            <h6 class="page-title d-flex align-items-center text-nowrap">
                <i class="fas fa-file-invoice text-primary me-2"></i>
                <span>สร้างใบขอซื้อใหม่ (New Request)</span>
            </h6>
            <div id="actionButtons"></div>
        </div>
    </div>

    <div class="qcs-card">
        <div id="quotationForm"></div>
    </div>


    <div class="qcs-card mt-card">
        <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
            <h6 class="m-0 text-secondary">
                <i class="fas fa-project-diagram me-2"></i>
                เส้นทางการอนุมัติ (Approval Route)
            </h6>
        </div>
        <div id="approvalFlowGrid"></div>
    </div>
</div>

<div id="loadingIndicator"></div>

@section Scripts {
    <script>
        $(function () {
            // === 1. CONFIGURATION ===
            const CONFIG = {
                // Base URL ของ QCS.Api
                API_BASE_URL: "https://localhost:7127/api",

                API_CREATE_ENDPOINT: '/PurchaseRequest/Create',
                // Endpoint ที่เราสร้างไว้ใน QCS.Api เพื่อ Proxy ไปหา Workflow Api
                API_WORKFLOW_ROUTE: '/Workflow/route/1',

                // URL API สำหรับดึง Vendor (ปรับตามจริง)
                VENDOR_API_URL: "https://ap-ntc2138-qawb/iChaSue/Service/Supplier/api/Suppliers"
            };

            // === 2. DATA STORES ===
            const vendorStore = DevExpress.data.AspNet.createStore({
                key: "id",
                loadUrl: CONFIG.VENDOR_API_URL,
                onBeforeSend: function(method, ajaxOptions) {
                    ajaxOptions.xhrFields = { withCredentials: true };
                }
            });

            const documentTypes = [
                { id: 10, name: 'Main Quotation (ใบเสนอราคาหลัก)' },
                { id: 20, name: 'Specifications (รายละเอียดสเปค)' },
                { id: 30, name: 'Terms & Conditions (เงื่อนไข)' }
            ];

            // === 3. INITIAL DATA MODEL ===
            const requestData = {
                documentName: "",
                vendorId: null,
                validFrom: new Date(),
                validUntil: new Date(new Date().setMonth(new Date().getMonth() + 1)),
                comment: "",
                attachments: [] // เก็บ Metadata ของไฟล์
            };

            let fileList = []; // เก็บ File Object จริงๆ ที่จะ Upload
            let attachmentGridInstance = null;
            let formInstance = null;

            // === 4. UI COMPONENTS ===
            const loadingIndicator = $("#loadingIndicator").dxLoadPanel({
                shadingColor: "rgba(0,0,0,0.4)",
                position: { of: "body" },
                visible: false,
                showIndicator: true,
                showPane: true,
                shading: true,
                message: "กำลังบันทึกข้อมูล..."
            }).dxLoadPanel("instance");

            // 4.1 Render Form (Input Section Only)
            formInstance = $("#quotationForm").dxForm({
                formData: requestData,
                colCount: 2,
                labelLocation: "top",
                items: [
                    {
                        itemType: "group",
                        caption: "1. ข้อมูลทั่วไป (General Information)",
                        colSpan: 2,
                        colCount: 2,
                        items: [
                            {
                                dataField: "documentName",
                                label: { text: "หัวข้อการจัดซื้อ (Title)" },
                                editorOptions: { placeholder: "ระบุชื่องาน หรือรายการที่ต้องการซื้อ..." },
                                colSpan: 1,
                                validationRules: [{ type: "required", message: "กรุณาระบุหัวข้อ" }]
                            },
                            {
                                dataField: "vendorId",
                                label: { text: "ผู้ขาย (Vendor)" },
                                editorType: "dxSelectBox",
                                editorOptions: {
                                    dataSource: vendorStore,
                                    valueExpr: "Id",
                                    displayExpr: "Name",
                                    searchEnabled: true,
                                    placeholder: "ค้นหาและเลือกผู้ขาย..."
                                },
                                colSpan: 1,
                                validationRules: [{ type: "required", message: "กรุณาเลือก Vendor" }]
                            },
                            {
                                dataField: "validFrom",
                                label: { text: "วันที่เริ่มยืนราคา (Valid From)" },
                                editorType: "dxDateBox",
                                editorOptions: { displayFormat: "dd/MM/yyyy", type: "date" },
                                validationRules: [{ type: "required" }]
                            },
                            {
                                dataField: "validUntil",
                                label: { text: "ถึงวันที่ (Valid Until)" },
                                editorType: "dxDateBox",
                                editorOptions: { displayFormat: "dd/MM/yyyy", type: "date" },
                                validationRules: [{ type: "required" }]
                            },
                            {
                                dataField: "comment",
                                label: { text: "หมายเหตุ (Comment)" },
                                editorType: "dxTextArea",
                                editorOptions: { height: 80, placeholder: "รายละเอียดเพิ่มเติม..." },
                                colSpan: 2
                            }
                        ]
                    },
                    {
                        itemType: "group",
                        caption: "2. เอกสารแนบ (Attachments)",
                        colSpan: 2,
                        items: [{ template: renderAttachmentsSection }]
                    }
                ]
            }).dxForm("instance");

            // 4.2 Render Approval Grid (Workflow Route from API)
            const approvalGrid = $("#approvalFlowGrid").dxDataGrid({
                dataSource: [], // เริ่มต้นเป็นว่าง รอโหลดจาก API
                showBorders: true,
                showRowLines: true,
                columnAutoWidth: true,
                paging: { enabled: false },
                loadPanel: { enabled: true }, // แสดง Loading ใน Grid ตอนโหลดข้อมูล
                noDataText: "กำลังโหลดข้อมูลผู้อนุมัติ...",
                columns: [
                    {
                        dataField: "step",
                        caption: "ลำดับ (Seq)",
                        width: 80,
                        alignment: "center",
                        sortOrder: "asc"
                    },
                    {
                        dataField: "role",
                        caption: "ขั้นตอน/ตำแหน่ง (Step Name)",
                        width: 250
                    },
                    {
                        dataField: "approver",
                        caption: "ผู้อนุมัติ (Approver Name)",
                        cellTemplate: function(container, options) {
                            // ถ้ามีหลายคนให้แสดงเป็นรายการ
                            const names = options.value ? options.value.split(',') : [];
                            if(names.length > 1) {
                                names.forEach(name => {
                                    $("<div>").html('<i class="fas fa-user text-muted me-1"></i>' + name).appendTo(container);
                                });
                            } else {
                                $("<span>").html('<i class="fas fa-user text-muted me-1"></i>' + (options.value || "Any")).appendTo(container);
                            }
                        }
                    },
                    {
                        dataField: "statusText",
                        caption: "สถานะ (Status)",
                        width: 150,
                        alignment: "center",
                        cellTemplate: function(container, options) {
                            $("<span>")
                                .addClass("status-badge status-pending") // Default เป็น Pending สำหรับ Create Mode
                                .text(options.value)
                                .appendTo(container);
                        }
                    }
                ]
            }).dxDataGrid("instance");

            // 4.3 Render Toolbar Buttons
            $("#actionButtons").dxToolbar({
                items: [
                    {
                        location: 'after',
                        widget: 'dxButton',
                        options: {
                            text: 'ยกเลิก',
                            stylingMode: 'outlined',
                            icon: 'close',
                            onClick: () => window.location.href = '@Url.Action("Index", "PurchaseRequest")'
                        }
                    },
                    {
                        location: 'after',
                        widget: 'dxButton',
                        options: {
                            text: 'สร้างใบขอซื้อ',
                            icon: 'save',
                            type: 'default',
                            onClick: submitData
                        }
                    }
                ]
            });

            // === 5. LOAD WORKFLOW DATA ===
            // เรียกฟังก์ชันนี้ทันทีเพื่อดึงข้อมูล Route
            loadWorkflowData();

           function loadWorkflowData() {
                const apiUrl = CONFIG.API_BASE_URL + CONFIG.API_WORKFLOW_ROUTE;

                $.ajax({
                    url: apiUrl,
                    type: 'GET',
                    dataType: 'json',
                    // เพิ่มส่วนนี้เพื่อให้ส่ง Cookie Authentication (.AspNetCore.Identity.Application) ไปด้วย
                    xhrFields: {
                        withCredentials: true
                    },
                    crossDomain: true, // ย้ำให้แน่ใจว่าเป็น Cross Domain Request
                    success: function (data) {
                        if (data && data.steps) {
                            // แปลงข้อมูลจาก API ให้เข้ากับ Column ของ Grid
                            const mappedData = data.steps.map(step => {
                                // ดึงชื่อพนักงานทั้งหมดใน Step นั้นมาต่อกัน
                                const approverNames = step.assignments
                                    ? step.assignments.map(a => a.employeeName || a.nId).join(',')
                                    : "";

                                return {
                                    step: step.sequenceNo,
                                    role: step.stepName,
                                    approver: approverNames,
                                    statusText: "รออนุมัติ" // สถานะเริ่มต้น
                                };
                            });

                            // เรียงลำดับ
                            mappedData.sort((a, b) => a.step - b.step);

                            // อัปเดตข้อมูลเข้า Grid
                            const grid = $("#approvalFlowGrid").dxDataGrid("instance");
                            grid.option("dataSource", mappedData);
                            grid.option("noDataText", "ไม่พบข้อมูลเส้นทางการอนุมัติ");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error loading workflow route:", error);
                        console.log("Status:", xhr.status);

                        const grid = $("#approvalFlowGrid").dxDataGrid("instance");

                        if (xhr.status === 401) {
                            grid.option("noDataText", "Session หมดอายุ หรือไม่มีสิทธิ์เข้าถึง (401)");
                            // อาจจะ Redirect ไปหน้า Login ถ้าจำเป็น
                            // window.location.href = '/Account/Login';
                        } else {
                            grid.option("noDataText", "เกิดข้อผิดพลาดในการโหลดข้อมูล Workflow");
                        }
                    }
                });
            }

            // === 6. TEMPLATE FUNCTIONS ===
            function renderAttachmentsSection(data, itemElement) {
                const $container = $("<div>").addClass("attachments-container");

                // File Uploader Component
                $("<div>").dxFileUploader({
                    multiple: true,
                    accept: ".pdf",
                    uploadMode: "useForm", // ไม่ Upload ทันที รอ submit form
                    showFileList: false,   // ซ่อน list default เพราะเราจะใช้ Grid แสดงแทน
                    labelText: "ลากไฟล์ PDF มาวางที่นี่ หรือคลิกเพื่อเลือกไฟล์",
                    selectButtonText: "เพิ่มไฟล์ (Add Files)",
                    allowedFileExtensions: ['.pdf'],
                    onValueChanged: function (e) {
                        if (e.value && e.value.length > 0) {
                            e.value.forEach(file => handleFileUpload(file));
                            e.component.reset();
                        }
                    }
                }).appendTo($container);

                // Grid แสดงรายการไฟล์
                attachmentGridInstance = $("<div>").dxDataGrid({
                    dataSource: requestData.attachments,
                    showBorders: true,
                    paging: { enabled: false },
                    noDataText: "ยังไม่มีไฟล์แนบ (กรุณาอัปโหลดไฟล์ PDF)",
                    columnAutoWidth: true,
                    hoverStateEnabled: true,
                    editing: {
                        mode: "cell",
                        allowUpdating: true,
                        allowDeleting: true,
                        useIcons: true
                    },
                    onRowRemoved: function(e) {
                        // ลบไฟล์จริงออกจาก Array fileList เมื่อลบแถวใน Grid
                        fileList = fileList.filter(f => f.name !== e.data.fileName);
                    },
                    columns: [
                        {
                            dataField: "fileName",
                            caption: "ชื่อไฟล์",
                            allowEditing: false,
                            cellTemplate: function (container, options) {
                                $("<div>").addClass("file-info")
                                    .append($("<i>").addClass("fas fa-file-pdf"))
                                    .append($("<span>").text(options.value))
                                    .appendTo(container);
                            }
                        },
                        {
                            dataField: "fileSize",
                            caption: "ขนาด",
                            width: 120,
                            allowEditing: false,
                            alignment: "center",
                            customizeText: (cellInfo) => formatFileSize(cellInfo.value)
                        },
                        {
                            dataField: "documentType",
                            caption: "ประเภทเอกสาร",
                            width: 250,
                            lookup: {
                                dataSource: documentTypes,
                                valueExpr: "id",
                                displayExpr: "name"
                            },
                            validationRules: [{ type: "required", message: "ระบุประเภท" }]
                        },
                        { type: "buttons", width: 60, buttons: ["delete"] }
                    ]
                }).dxDataGrid("instance");

                attachmentGridInstance.element().appendTo($container);
                $container.appendTo(itemElement);
            }

            // === 7. LOGIC FUNCTIONS ===
            function handleFileUpload(file) {
                if (file.type !== "application/pdf") {
                    DevExpress.ui.notify("รองรับเฉพาะไฟล์ PDF เท่านั้น", "error", 3000);
                    return;
                }
                // เช็คไฟล์ซ้ำ (ชื่อ+ขนาด)
                if (fileList.some(f => f.name === file.name && f.size === file.size)) {
                    DevExpress.ui.notify(`ไฟล์ ${file.name} ถูกเพิ่มไปแล้ว`, "warning", 3000);
                    return;
                }

                fileList.push(file);
                // เพิ่ม Metadata ลง Model สำหรับแสดงใน Grid
                requestData.attachments.push({
                    tempId: generateUUID(),
                    fileName: file.name,
                    fileSize: file.size,
                    documentType: documentTypes[0].id // Default = Main Quotation
                });

                if (attachmentGridInstance) attachmentGridInstance.refresh();
            }

            async function submitData() {
                const validationResult = formInstance.validate();
                if (!validationResult.isValid) {
                    DevExpress.ui.notify("กรุณากรอกข้อมูลสำคัญให้ครบถ้วน", "error", 2000);
                    return;
                }

                if (requestData.attachments.length === 0) {
                    DevExpress.ui.notify("กรุณาแนบไฟล์อย่างน้อย 1 รายการ", "error", 2000);
                    return;
                }

                loadingIndicator.show();

                try {
                    const formData = new FormData();

                    // 1. Append Header Fields (ตามโครงสร้างใหม่)
                    formData.append("Title", requestData.documentName);

                    // Vendor Info
                    const vendorEditor = formInstance.getEditor("vendorId");
                    const selectedVendorName = vendorEditor.option("displayValue") || "";
                    formData.append("VendorId", requestData.vendorId);
                    formData.append("VendorName", selectedVendorName);

                    // Dates & Comment
                    if(requestData.validFrom) formData.append("ValidFrom", requestData.validFrom.toISOString());
                    if(requestData.validUntil) formData.append("ValidUntil", requestData.validUntil.toISOString());
                    formData.append("Comment", requestData.comment || "");

                    // 2. Append Attachments & Metadata
                    // สร้าง JSON Metadata สำหรับไฟล์แนบ
                    const quotationsMeta = requestData.attachments.map(att => ({
                        FileName: att.fileName,
                        DocumentTypeId: att.documentType
                    }));
                    formData.append("QuotationsJson", JSON.stringify(quotationsMeta));

                    // แนบไฟล์ Binary
                    fileList.forEach(file => {
                        formData.append("Attachments", file);
                    });

                    // 3. Send API Request
                    const response = await fetch(CONFIG.API_BASE_URL + CONFIG.API_CREATE_ENDPOINT, {
                        method: 'POST',
                        body: formData,
                        credentials: 'include' // ส่ง cookie authentication ไปด้วย
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText || "Server error occurred.");
                    }

                    const result = await response.json();
                    DevExpress.ui.notify(`บันทึกสำเร็จ (เลขที่: ${result.docNo})`, "success", 2000);

                    // Redirect กลับหน้า Index
                    setTimeout(() => {
                        window.location.href = '@Url.Action("Index", "PurchaseRequest")';
                    }, 1500);

                } catch (err) {
                    console.error("Submit Error:", err);
                    DevExpress.ui.notify("เกิดข้อผิดพลาด: " + err.message, "error", 5000);
                } finally {
                    loadingIndicator.hide();
                }
            }

            // Helpers
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            function generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
        });
    </script>
}