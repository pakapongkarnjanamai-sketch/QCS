@model int
@{
    ViewData["Title"] = "Purchase Request Detail";
}

@section Styles {
    <style>
        .qcs-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 20px;
            border: 1px solid #eaeaea;
        }

        .mt-card {
            margin-top: 20px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .file-info i {
                color: #f05b41;
                font-size: 1.2em;
            }

        .attachments-container {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            display: inline-block;
            min-width: 80px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-draft {
            background-color: #6c757d;
        }

        .status-pending {
            background-color: #ffc107;
            color: #212529;
        }

        .status-approved {
            background-color: #28a745;
        }

        .status-rejected {
            background-color: #dc3545;
        }

        .current-user-row {
            font-weight: bold;
            color: #007bff;
        }

        .row-current-step {
            background-color: #e8f4ff !important;
            font-weight: 500;
        }

            .row-current-step td {
                border-top: 2px solid #007bff !important;
                border-bottom: 2px solid #007bff !important;
            }
    </style>
}

<div class="container mt-4">
    <div class="qcs-card mb-3">
        <div class="page-header-row">
            <h6 class="page-title d-flex align-items-center text-nowrap">
                <i class="fas fa-file-invoice text-primary me-2"></i>
                <span id="lblDocNo" class="me-2">Loading...</span>
            </h6>
            <div id="actionButtons"></div>
        </div>
    </div>

    <div class="qcs-card">
        <div id="quotationForm"></div>
    </div>

    <div class="qcs-card mt-card">
        <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
            <h6 class="m-0 text-secondary font-weight-bold">
                <i class="fas fa-project-diagram me-2"></i>
                Approval Route & History
            </h6>
        </div>
        <div id="workflowRouteGrid"></div>
    </div>
</div>

<div id="historyPopup"></div>
<div id="actionPopup">
    <div class="p-2">
        <div id="actionReasonBox"></div>
        <div class="mt-3 d-flex justify-content-end gap-2">
            <div id="btnConfirmAction"></div>
            <div id="btnCancelAction"></div>
        </div>
    </div>
</div>
<div id="loadingIndicator"></div>

@section Scripts {
    <script>
        $(function () {
            // === 1. CONFIGURATION ===
            const PR_ID = @Model;
            const CONFIG = {
                API_BASE_URL: "https://localhost:7127/api",
                API_GET_DETAIL: `/PurchaseRequest/Detail/${PR_ID}`,
                API_APPROVE: `/Approval/Approve`,
                API_REJECT: `/Approval/Reject`,
                API_UPDATE: `/PurchaseRequest/Update`,
                API_SUBMIT_UPDATE: `/PurchaseRequest/SubmitUpdate`,
                // Proxy URL
                VENDOR_API_URL: "/Vendor"
            };

            const documentTypes = [
                { id: 10, name: 'Main Quotation' },
                { id: 20, name: 'Specifications' },
                { id: 30, name: 'Terms & Conditions' }
            ];

            // === 2. VARIABLES ===
            let toolbarInstance = null;
            let actionPopupInstance = null;
            let formInstance = null;
            let attachmentGridInstance = null;
            let currentActionType = "";
            let prData = null;
            let fileList = [];
            let deletedFileIds = [];

            const loadingIndicator = $("#loadingIndicator").dxLoadPanel({
                shadingColor: "rgba(0,0,0,0.4)", position: { of: "body" }, visible: false, showIndicator: true, showPane: true, shading: true, message: "Processing..."
            }).dxLoadPanel("instance");

            // Store for Vendor Dropdown
            const vendorStore = DevExpress.data.AspNet.createStore({
                key: "id",
                loadUrl: CONFIG.API_BASE_URL + CONFIG.VENDOR_API_URL,
                onBeforeSend: function(method, ajaxOptions) { ajaxOptions.xhrFields = { withCredentials: true }; }
            });

            // === 3. INIT ===
            initToolbar();
            initActionPopup();
            loadData();

            // === 4. TOOLBAR ===
            function initToolbar() {
                toolbarInstance = $("#actionButtons").dxToolbar({
                    items: [
                        { location: 'after', widget: 'dxButton', options: { text: 'History', icon: 'clock', stylingMode: 'text', onClick: showHistoryPopup } },
                        { location: 'after', widget: 'dxButton', options: { text: 'Back', stylingMode: 'outlined', icon: 'arrowleft', onClick: () => window.location.href = '@Url.Action("Index", "PurchaseRequest")' } },

                        // Edit Buttons
                        { location: 'after', visible: false, widget: 'dxButton', options: { elementAttr: { id: "btnSaveEdit" }, text: 'Save Draft', icon: 'save', type: 'default', stylingMode: 'outlined', onClick: () => handleUpdate(false) } },
                        { location: 'after', visible: false, widget: 'dxButton', options: { elementAttr: { id: "btnSubmitEdit" }, text: 'Submit', icon: 'check', type: 'default', onClick: () => handleUpdate(true) } },

                        // Approve Buttons
                        { location: 'after', visible: false, widget: 'dxButton', options: { elementAttr: { id: "btnReject" }, text: 'Reject', stylingMode: 'contained', type: 'danger', onClick: () => openActionPopup('Reject') } },
                        { location: 'after', visible: false, widget: 'dxButton', options: { elementAttr: { id: "btnApprove" }, text: 'Approve', stylingMode: 'contained', type: 'success', onClick: () => openActionPopup('Approve') } }
                    ]
                }).dxToolbar("instance");
            }

            function updateToolbarPermissions(perms) {
                const items = toolbarInstance.option("items");

                const btnReject = items.find(i => i.options && i.options.elementAttr && i.options.elementAttr.id === "btnReject");
                const btnApprove = items.find(i => i.options && i.options.elementAttr && i.options.elementAttr.id === "btnApprove");
                if (btnReject) btnReject.visible = perms.canReject;
                if (btnApprove) btnApprove.visible = perms.canApprove;

                const btnSaveEdit = items.find(i => i.options && i.options.elementAttr && i.options.elementAttr.id === "btnSaveEdit");
                const btnSubmitEdit = items.find(i => i.options && i.options.elementAttr && i.options.elementAttr.id === "btnSubmitEdit");
                if (btnSaveEdit) btnSaveEdit.visible = perms.canEdit;
                if (btnSubmitEdit) btnSubmitEdit.visible = perms.canEdit;

                toolbarInstance.option("items", items);

                if (perms.canEdit) DevExpress.ui.notify("You can edit this document.", "info", 4000);
                else if (perms.canApprove) DevExpress.ui.notify("You have permission to approve this document.", "info", 4000);
            }

            // === 5. LOAD DATA & AUTO-FIX ===
            async function loadData() {
                loadingIndicator.show();
                try {
                    const response = await fetch(CONFIG.API_BASE_URL + CONFIG.API_GET_DETAIL, { credentials: 'include' });
                    if (!response.ok) throw new Error("Document not found.");
                    const data = await response.json();

                    // [Auto-Fix] If VendorId=0 but has Name, try to find ID
                    if ((!data.vendorId || data.vendorId === 0) && data.vendorName) {
                        try {
                            const vendors = await vendorStore.load({ filter: ["Name", "=", data.vendorName] });
                            if (vendors && vendors.length > 0) {
                                data.vendorId = vendors[0].Id;
                                console.log(`Auto-fixed VendorId to: ${data.vendorId}`);
                            }
                        } catch (ex) { console.error("Vendor Auto-fix failed", ex); }
                    }

                    prData = data;
                    renderPageContent(data);
                    renderWorkflowRouteGrid(data.workflowRoute, data.currentStepId);
                    updateToolbarPermissions(data.permissions);

                } catch (err) {
                    DevExpress.ui.notify(err.message, "error", 3000);
                } finally {
                    loadingIndicator.hide();
                }
            }

            function renderPageContent(data) {
                $("#lblDocNo").text(data.docNo || data.documentNo || "-");
                const isEditable = data.permissions && data.permissions.canEdit;

                formInstance = $("#quotationForm").dxForm({
                    formData: data,
                    readOnly: !isEditable,
                    colCount: 2,
                    labelLocation: "top",
                    items: [
                        {
                            itemType: "group", caption: "1. General Information", colSpan: 2, colCount: 2,
                            items: [
                                { dataField: "title", label: { text: "Title" }, colSpan: 2, validationRules: [{ type: "required" }] },
                                {
                                    dataField: "vendorId", label: { text: "Vendor" }, colSpan: 2,
                                    editorType: "dxSelectBox",
                                    editorOptions: {
                                        dataSource: vendorStore, valueExpr: "Id", displayExpr: "Name", searchEnabled: true,
                                        value: data.vendorId
                                    },
                                    validationRules: [{ type: "required" }]
                                },
                                { dataField: "validFrom", label: { text: "Valid From" }, editorType: "dxDateBox", editorOptions: { displayFormat: "dd/MM/yyyy" }, validationRules: [{ type: "required" }] },
                                { dataField: "validUntil", label: { text: "Valid Until" }, editorType: "dxDateBox", editorOptions: { displayFormat: "dd/MM/yyyy" }, validationRules: [{ type: "required" }] },
                                { dataField: "comment", label: { text: "Comment" }, editorType: "dxTextArea", editorOptions: { height: 60, autoResizeEnabled: true }, colSpan: 2 }
                            ]
                        },
                        {
                            itemType: "group", caption: "2. Attachments", colSpan: 2,
                            items: [{ template: (d, item) => renderAttachmentsSection(data.quotations || [], item, isEditable) }]
                        }
                    ]
                }).dxForm("instance");
            }

            function renderAttachmentsSection(files, itemElement, canEdit) {
                const $container = $("<div>").addClass("attachments-container");

                if (canEdit) {
                    $("<div>").dxFileUploader({
                        multiple: true, accept: ".pdf", uploadMode: "useForm",
                        labelText: "Drag & drop PDF file here to add", selectButtonText: "Add File",
                        allowedFileExtensions: ['.pdf'],
                        onValueChanged: (e) => {
                            if (e.value && e.value.length > 0) {
                                e.value.forEach(f => {
                                    if(f.type !== "application/pdf") {
                                        DevExpress.ui.notify("Only PDF files are allowed.", "error", 2000);
                                        return;
                                    }
                                    fileList.push(f);
                                    const ds = attachmentGridInstance.option("dataSource");
                                    ds.push({ originalFileName: f.name, isNew: true, fileSize: f.size, documentTypeId: 10 });
                                });
                                attachmentGridInstance.refresh();
                                e.component.reset();
                            }
                        }
                    }).appendTo($container);
                }

                attachmentGridInstance = $("<div>").dxDataGrid({
                    dataSource: files, showBorders: true, showRowLines: true, columnAutoWidth: true,
                    paging: { pageSize: 5 }, noDataText: "No attachments",
                    editing: {
                        mode: "cell", allowUpdating: canEdit, allowDeleting: false, useIcons: true
                    },
                    columns: [
                        {
                            dataField: "originalFileName", caption: "File Name", allowEditing: false,
                            cellTemplate: (c, o) => {
                                const isNew = o.data.isNew ? ' <span class="badge bg-success">New</span>' : '';
                                $("<div>").addClass("file-info").append($("<i>").addClass("fas fa-file-pdf")).append($("<span>").html(o.value + isNew)).appendTo(c)
                            }
                        },
                        {
                            dataField: "documentTypeId", caption: "Type", width: 250,
                            lookup: { dataSource: documentTypes, valueExpr: "id", displayExpr: "name" },
                            validationRules: [{ type: "required" }]
                        },
                        {
                            type: "buttons", width: 100,
                            buttons: [
                                {
                                    hint: "View", icon: "eyeopen",
                                    onClick: (e) => {
                                        if (e.row.data.id) {
                                            viewPdf(e.row.data.id);
                                        } else if(e.row.data.isNew) {
                                            DevExpress.ui.notify("New files must be saved before viewing.", "warning", 3000);
                                        }
                                    }
                                },
                                {
                                    name: "delete", visible: canEdit,
                                    onClick: (e) => {
                                        DevExpress.ui.dialog.confirm("Delete this file?", "Confirm").done(res => {
                                            if(res) {
                                                const rowData = e.row.data;
                                                if (rowData.id) deletedFileIds.push(rowData.id);
                                                else if (rowData.isNew) {
                                                    const idx = fileList.findIndex(f => f.name === rowData.originalFileName);
                                                    if(idx > -1) fileList.splice(idx, 1);
                                                }
                                                const ds = attachmentGridInstance.option("dataSource");
                                                const index = ds.indexOf(rowData);
                                                if (index > -1) { ds.splice(index, 1); attachmentGridInstance.refresh();
                                                }
                                            }
                                        });
                                    }
                                }
                            ]
                        }
                    ]
                }).dxDataGrid("instance");
                attachmentGridInstance.element().appendTo($container);
                $container.appendTo(itemElement);
            }

            // === [NEW] View PDF with Loading Window (Anti-Popup Blocker) ===
            async function viewPdf(id) {
                // 1. Create Loading HTML
                const loadingHtml = `
                                <div style="text-align:center;">
                                    <h3>Processing PDF...</h3>
                                    <p>Please wait while we generate your document.</p>
                                </div>`;

                // 2. Create Blob URL for Loading Page
                const loadingBlob = new Blob([loadingHtml], { type: 'text/html' });
                const loadingUrl = URL.createObjectURL(loadingBlob);

                // 3. Open Window Immediately (Synchronous context)
                const newWindow = window.open(loadingUrl, '_blank');

                if (!newWindow) {
                    DevExpress.ui.notify("Pop-up blocked! Please allow pop-ups for this site.", "warning", 5000);
                    return;
                }

                try {
                    // 4. Fetch File from Backend
                    const response = await fetch(CONFIG.API_BASE_URL + '/PurchaseRequest/ViewFile/' + id, {
                        method: 'GET',
                        credentials: 'include' 
                    });

                    if (!response.ok) {
                        newWindow.close();
                        throw new Error(await response.text() || "Cannot download file.");
                    }

                    // 5. Get Blob
                    const pdfBlob = await response.blob();

                    if (pdfBlob.type !== 'application/pdf') {
                         newWindow.close();
                         throw new Error("The returned file is not a valid PDF.");
                    }

                    // 6. Create PDF Blob URL
                    const pdfUrl = window.URL.createObjectURL(pdfBlob);

                    // 7. Redirect the loading window to PDF
                    newWindow.location.href = pdfUrl;

                    // Optional: Revoke loading URL
                    setTimeout(() => window.URL.revokeObjectURL(loadingUrl), 1000);

                } catch (error) {
                    console.error('Error viewing PDF:', error);
                    if(newWindow && !newWindow.closed) newWindow.close();
                    DevExpress.ui.notify(`Error: ${error.message}`, "error", 3000);
                }
            }

            // === 6. UPDATE (SAVE/SUBMIT) ===
            async function handleUpdate(isSubmit) {
                if (!formInstance.validate().isValid) return;
                if (isSubmit) {
                    const result = DevExpress.ui.dialog.confirm("Confirm Submit?", "Confirm Submit");
                    result.done(confirmed => { if (confirmed) sendUpdateData(true); });
                } else {
                    sendUpdateData(false);
                }
            }

            async function sendUpdateData(isSubmit) {
                loadingIndicator.show();
                try {
                    const formData = new FormData();
                    formData.append("Id", PR_ID);

                    const data = formInstance.option("formData");
                    formData.append("Title", data.title);

                    const vendorEditor = formInstance.getEditor("vendorId");
                    const vendorId = vendorEditor.option("value");
                    const vendorName = vendorEditor.option("displayValue");
                    if (!vendorId) throw new Error("Please select a Vendor.");

                    formData.append("VendorId", vendorId);
                    formData.append("VendorName", vendorName || "");
                    if(data.validFrom) formData.append("ValidFrom", new Date(data.validFrom).toISOString());
                    if(data.validUntil) formData.append("ValidUntil", new Date(data.validUntil).toISOString());
                    formData.append("Comment", data.comment || "");

                    // Files & Types
                    const currentGridData = attachmentGridInstance.option("dataSource");
                    const existingFilesUpdates = [];
                    const newFilesMeta = [];

                    currentGridData.forEach(row => {
                        if (row.id) existingFilesUpdates.push({ Id: row.id, DocumentTypeId: row.documentTypeId });
                        else if (row.isNew) newFilesMeta.push({ FileName: row.originalFileName, DocumentTypeId: row.documentTypeId });
                    });
                    fileList.forEach(file => formData.append("NewAttachments", file));
                    formData.append("QuotationsJson", JSON.stringify(newFilesMeta));
                    if (existingFilesUpdates.length > 0) formData.append("UpdatedQuotationsJson", JSON.stringify(existingFilesUpdates));
                    if (deletedFileIds.length > 0) formData.append("DeletedFileIds", deletedFileIds.join(","));

                    const endpoint = isSubmit ? CONFIG.API_SUBMIT_UPDATE : CONFIG.API_UPDATE;
                    const response = await fetch(CONFIG.API_BASE_URL + endpoint, { method: 'POST', body: formData, credentials: 'include' });
                    if (!response.ok) throw new Error(await response.text());

                    const actionText = isSubmit ? "Submit" : "Save";
                    DevExpress.ui.notify(`${actionText} successful.`, "success", 2000);
                    setTimeout(() => location.reload(), 1500);

                } catch (err) {
                    console.error(err);
                    DevExpress.ui.notify("Error: " + err.message, "error", 3000);
                } finally {
                    loadingIndicator.hide();
                }
            }

            // === 7. WORKFLOW & APPROVAL ===
            function renderWorkflowRouteGrid(routeData, currentStepId) {
                const gridData = (routeData && routeData.steps) ?
                routeData.steps.map(step => ({
                    sequenceNo: step.sequenceNo, stepName: step.stepName, rawAssignments: step.assignments,
                    status: step.status, approverName: step.approverName, actionDate: step.actionDate, comment: step.comment
                })) : [];

                $("#workflowRouteGrid").dxDataGrid({
                    dataSource: gridData, showBorders: true, showRowLines: true, columnAutoWidth: true, paging: { enabled: false },
                    onRowPrepared: (e) => { if (e.rowType === "data" && e.data.sequenceNo === currentStepId) e.rowElement.addClass("row-current-step"); },
                    columns: [
                        { dataField: "sequenceNo", caption: "Seq", width: 60, alignment: "center" },
                        { dataField: "stepName", caption: "Step", width: 200 },
                        {
                            dataField: "assignees", caption: "Assignees", width: 250,
                            cellTemplate: (c, o) => { (o.data.rawAssignments || []).forEach(a => $("<div>").html(a.isCurrentUser ? `<span class="current-user-row"><i class="fas fa-user-circle"></i> ${a.employeeName} (You)</span>` : `<span class="text-muted"><i class="fas fa-user"></i> ${a.employeeName}</span>`).appendTo(c)); }
                        },
                        { dataField: "status", caption: "Status", width: 100, alignment: "center", cellTemplate: (c, o) => { const s = mapStatus(o.value);
                        $("<span>").addClass("status-badge " + s.cls).text(s.text).appendTo(c); } },
                        { dataField: "approverName", caption: "Approver", width: 150, customizeText: (c) => c.value || "-" },
                        { dataField: "actionDate", caption: "Action Date", width: 120, alignment: "center", customizeText: (c) => formatDate(c.value) },
                        { dataField: "comment", caption: "Comment", customizeText: (c) => c.value || "-" }
                    ]
                });
            }

            function initActionPopup() {
                actionPopupInstance = $("#actionPopup").dxPopup({
                    width: 400, height: "auto", visible: false, dragEnabled: true,
                    hideOnOutsideClick: false, showCloseButton: true, title: "Action",
                    contentTemplate: function(contentElement) {
                        const container = $("<div>").addClass("p-1");
                        $("<div>").attr("id", "actionReasonBox").dxTextArea({ height: 120, placeholder: "Enter comment..." }).appendTo(container);
                        const btnGroup = $("<div>").addClass("mt-3 text-end").appendTo(container);
                        $("<div>").dxButton({ text: "Cancel", stylingMode: "outlined", type: "normal", onClick: () => actionPopupInstance.hide() }).addClass("me-2").appendTo(btnGroup);
                        $("<div>").dxButton({ text: "Confirm", stylingMode: "contained", type: "default", elementAttr: { id: "btnActionConfirm" }, onClick: confirmAction }).appendTo(btnGroup);
                        container.appendTo(contentElement);
                    }
                }).dxPopup("instance");
            }

            function openActionPopup(type) {
                currentActionType = type;
                const isReject = type === 'Reject';
                const title = isReject ? "Reject Reason" : "Confirm Approval";
                const btnType = isReject ? "danger" : "success";
                const placeholder = isReject ? "Please specify reason..." : "Additional comment (optional)...";

                const textArea = $("#actionReasonBox").dxTextArea("instance");
                if(textArea) { textArea.reset();
                textArea.option("placeholder", placeholder); }
                const confirmBtn = $("#btnActionConfirm").dxButton("instance");
                if(confirmBtn) confirmBtn.option("type", btnType);

                actionPopupInstance.option("title", title);
                actionPopupInstance.show();
            }

            function confirmAction() {
                const textArea = $("#actionReasonBox").dxTextArea("instance");
                const comment = textArea.option("value") || "";
                if (currentActionType === 'Reject' && !comment.trim()) {
                    DevExpress.ui.notify("Please specify a rejection reason.", "warning", 2000);
                    return;
                }
                actionPopupInstance.hide();
                sendApprovalAction(currentActionType, comment);
            }

            async function sendApprovalAction(action, comment) {
                loadingIndicator.show();
                try {
                    const endpoint = (action === 'Approve') ? CONFIG.API_APPROVE : CONFIG.API_REJECT;
                    const res = await fetch(CONFIG.API_BASE_URL + endpoint, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ purchaseRequestId: PR_ID, comment: comment }), credentials: 'include'
                    });
                    if (!res.ok) throw new Error(await res.text());
                    DevExpress.ui.notify("Action completed successfully.", "success", 2000);
                    setTimeout(() => location.reload(), 1500);
                } catch (err) { DevExpress.ui.notify("Error: " + err.message, "error", 3000);
                }
                finally { loadingIndicator.hide();
                }
            }

            // === [NEW] Show History Popup (ApprovalStep Version + English) ===
            function showHistoryPopup() {
                // Try getting ApprovalSteps, fallback to WorkflowRoute steps if needed
                const historyData = prData ? (prData.approvalSteps || (prData.workflowRoute ? prData.workflowRoute.steps : [])) : [];

                $("#historyPopup").dxPopup({
                    title: "Approval History",
                    width: 800,
                    height: 500,
                    visible: true,
                    dragEnabled: true,
                    showCloseButton: true,
                    contentTemplate: (contentElement) => {
                        $("<div>").dxDataGrid({
                            dataSource: historyData,
                            showBorders: true,
                            showRowLines: true,
                            columnAutoWidth: true,
                            paging: { enabled: false },
                            columns: [
                                {
                                    caption: "#", width: 50, alignment: "center",
                                    cellTemplate: (container, options) => container.text(options.rowIndex + 1)
                                },
                                {
                                    dataField: "role", caption: "Step / Role",
                                    customizeText: (cellInfo) => cellInfo.value || (cellInfo.data.stepName || "-")
                                },
                                {
                                    dataField: "approverName", caption: "Approver",
                                    customizeText: (cellInfo) => cellInfo.value || "-"
                                },
                                {
                                    dataField: "actionDate", caption: "Action Date", width: 140, alignment: "center",
                                    customizeText: (cellInfo) => formatDate(cellInfo.value)
                                },
                                {
                                    dataField: "status", caption: "Status", width: 120, alignment: "center",
                                    cellTemplate: (container, options) => {
                                        const statusObj = mapStatus(options.value);
                                        $("<span>").addClass("status-badge " + statusObj.cls).text(statusObj.text).appendTo(container);
                                    }
                                },
                                {
                                    dataField: "comment", caption: "Comment",
                                    customizeText: (cellInfo) => cellInfo.value || "-"
                                }
                            ]
                        }).appendTo(contentElement);
                    }
                }).dxPopup("instance").show();
            }

            function mapStatus(s) {
                if (s == 0) return { text: 'Waiting', cls: 'status-draft' };
                if (s == 1) return { text: 'Pending', cls: 'status-pending' };
                if (s == 2) return { text: 'Approved', cls: 'status-approved' };
                if (s == 9) return { text: 'Rejected', cls: 'status-rejected' };
                return { text: '-', cls: 'status-draft' };
            }

            function formatDate(d) {
                if (!d) return "-";
                // Use 'en-GB' for dd MMM yyyy format
                return new Date(d).toLocaleDateString('en-GB', {
                    day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
                });
            }
        });
    </script>
}