@model int
@{
    ViewData["Title"] = "รายละเอียดใบขอซื้อ (Purchase Request Detail)";
}

@section Styles {
    <style>
        /* --- General Layout --- */
        .qcs-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 20px;
            border: 1px solid #eaeaea;
        }

        .mt-card {
            margin-top: 20px;
        }

        /* --- Attachments --- */
        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .file-info i {
                color: #d9534f;
                font-size: 1.4em;
            }

        .attachments-container {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px dashed #dee2e6;
        }

        /* --- Status Badge --- */
        .status-badge {
            padding: 5px 15px;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-draft {
            background-color: #6c757d;
        }

        .status-pending {
            background-color: #ffc107;
            color: #212529;
        }

        .status-approved {
            background-color: #28a745;
        }

        .status-rejected {
            background-color: #dc3545;
        }

        /* --- Current User Highlight in Grid --- */
        .current-user-row {
            font-weight: bold;
            color: #007bff;
            background-color: #f0f8ff;
        }
    </style>
}

<div class="container mt-4">

    <div class="qcs-card mb-3">
        <div class="page-header-row">
            <h6 class="page-title d-flex align-items-center text-nowrap">
                <i class="fas fa-file-invoice text-primary me-2"></i>
                <span id="lblDocNo" class="me-2">Loading...</span>
                <span id="statusBadge"></span>
            </h6>
            <div id="actionButtons"></div>
        </div>
    </div>

    <div class="qcs-card">
        <div id="quotationForm"></div>
    </div>

    <div class="qcs-card mt-card">
        <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
            <h6 class="m-0 text-secondary font-weight-bold">
                <i class="fas fa-project-diagram me-2"></i>
                เส้นทางการอนุมัติ (Approval Route)
            </h6>
        </div>
        <div id="workflowRouteGrid"></div>
    </div>

</div>

<div id="historyPopup"></div>

<div id="loadingIndicator"></div>

@section Scripts {
    <script>
        $(function () {
            // === 1. CONFIGURATION ===
            const PR_ID = @Model;
            const CONFIG = {
                API_BASE_URL: "https://localhost:7127/api",
                API_GET_DETAIL: `/PurchaseRequest/Detail/${PR_ID}`,
                API_APPROVE: `/Approval/Approve`,
                API_REJECT: `/Approval/Reject`,
                API_WORKFLOW_ROUTE: `/Workflow/route/1` // Workflow Route
            };

            const documentTypes = [
                { id: 10, name: 'Main Quotation (ใบเสนอราคาหลัก)' },
                { id: 20, name: 'Specifications (รายละเอียดสเปค)' },
                { id: 30, name: 'Terms & Conditions (เงื่อนไข)' }
            ];

            const loadingIndicator = $("#loadingIndicator").dxLoadPanel({
                shadingColor: "rgba(0,0,0,0.4)",
                position: { of: "body" },
                visible: false,
                showIndicator: true,
                showPane: true,
                shading: true,
                message: "กำลังประมวลผล..."
            }).dxLoadPanel("instance");

            let toolbarInstance = null;
            let prData = null; // เก็บข้อมูล PR เพื่อใช้ใน Popup ประวัติ

            // === 2. INIT ===
            initToolbar();
            loadData();
            loadWorkflowRoute(); // โหลด Route แบบตาราง

            // === 3. RENDER FUNCTIONS ===

            function initToolbar() {
                toolbarInstance = $("#actionButtons").dxToolbar({
                    items: [
                        {
                            location: 'after',
                            widget: 'dxButton',
                            options: {
                                text: 'ประวัติการอนุมัติ (History)',
                                icon: 'clock',
                                stylingMode: 'text',
                                onClick: showHistoryPopup
                            }
                        },
                        {
                            location: 'after',
                            widget: 'dxButton',
                            options: {
                                text: 'ย้อนกลับ',
                                stylingMode: 'outlined',
                                icon: 'arrowleft',
                                onClick: () => window.location.href = '@Url.Action("Index", "PurchaseRequest")'
                            }
                        },
                        // Action Buttons (เริ่มต้นซ่อนไว้ - Visible: False)
                        // จะแสดงก็ต่อเมื่อ Check Permission ผ่าน
                        {
                            location: 'after',
                            visible: false,
                            widget: 'dxButton',
                            options: {
                                elementAttr: { id: "btnReject" },
                                text: 'ไม่อนุมัติ (Reject)',
                                stylingMode: 'contained',
                                type: 'danger',
                                onClick: handleReject
                            }
                        },
                        {
                            location: 'after',
                            visible: false,
                            widget: 'dxButton',
                            options: {
                                elementAttr: { id: "btnApprove" },
                                text: 'อนุมัติ (Approve)',
                                stylingMode: 'contained',
                                type: 'success',
                                onClick: handleApprove
                            }
                        }
                    ]
                }).dxToolbar("instance");
            }

            async function loadData() {
                loadingIndicator.show();
                try {
                    const response = await fetch(CONFIG.API_BASE_URL + CONFIG.API_GET_DETAIL, {
                        credentials: 'include'
                    });

                    if (!response.ok) throw new Error("ไม่พบข้อมูลเอกสาร");

                    const data = await response.json();
                    prData = data;

                    renderPageContent(data);
                    checkApprovalPermission(data); // ตรวจสิทธิ์เพื่อแสดงปุ่ม

                } catch (err) {
                    console.error(err);
                    DevExpress.ui.notify(err.message, "error", 3000);
                } finally {
                    loadingIndicator.hide();
                }
            }

            // --- Function: โหลดและแสดง Approval Route (Table Grid) ---
            function loadWorkflowRoute() {
                const routeGrid = $("#workflowRouteGrid").dxDataGrid({
                    dataSource: [],
                    showBorders: true,
                    showRowLines: true,
                    columnAutoWidth: true,
                    paging: { enabled: false },
                    noDataText: "กำลังโหลดข้อมูลเส้นทาง...",
                    columns: [
                        {
                            dataField: "sequenceNo",
                            caption: "ลำดับ (Seq)",
                            width: 80,
                            alignment: "center",
                            sortOrder: "asc"
                        },
                        {
                            dataField: "stepName",
                            caption: "ขั้นตอน (Step Name)",
                            width: 250
                        },
                        {
                            dataField: "assignees",
                            caption: "รายชื่อผู้อนุมัติ (Approvers)",
                            cellTemplate: function(container, options) {
                                const assignments = options.data.rawAssignments || [];

                                if(assignments.length === 0) {
                                    $("<span>").text("Any").appendTo(container);
                                    return;
                                }

                                assignments.forEach(a => {
                                    const name = a.employeeName || a.nId;
                                    const $div = $("<div>");

                                    // Highlight Current User (เหมือนหน้า Create)
                                    if (a.isCurrentUser) {
                                        $div.addClass("current-user-row")
                                            .html(`<i class="fas fa-user-circle me-1"></i>${name} (You)`);
                                    } else {
                                        $div.html(`<i class="fas fa-user text-muted me-1"></i>${name}`);
                                    }

                                    $div.appendTo(container);
                                });
                            }
                        }
                    ]
                }).dxDataGrid("instance");

                // Call API to get Workflow Route structure and highlight current user
                $.ajax({
                    url: CONFIG.API_BASE_URL + CONFIG.API_WORKFLOW_ROUTE,
                    type: 'GET',
                    xhrFields: { withCredentials: true },
                    success: function (data) {
                        if(data && data.steps) {
                            const gridData = data.steps.map(step => {
                                return {
                                    sequenceNo: step.sequenceNo,
                                    stepName: step.stepName,
                                    rawAssignments: step.assignments
                                };
                            });
                            routeGrid.option("dataSource", gridData);
                        }
                    },
                    error: function (err) {
                        console.error("Workflow Load Error", err);
                        routeGrid.option("noDataText", "ไม่สามารถโหลดข้อมูลเส้นทางได้");
                    }
                });
            }

            // --- Function: แสดง Popup ประวัติ ---
            function showHistoryPopup() {
                const historyData = prData ? (prData.approvalSteps || []) : [];

                const popup = $("#historyPopup").dxPopup({
                    title: "ประวัติการอนุมัติ (Approval History)",
                    width: 800,
                    height: 500,
                    visible: true,
                    dragEnabled: true,
                    hideOnOutsideClick: true,
                    showCloseButton: true,
                    contentTemplate: function(contentElement) {
                        $("<div>").dxDataGrid({
                            dataSource: historyData,
                            showBorders: true,
                            showRowLines: true,
                            columnAutoWidth: true,
                            paging: { enabled: false },
                            columns: [
                                {
                                    caption: "#",
                                    cellTemplate: (container, options) => container.text(options.rowIndex + 1),
                                    width: 50, alignment: "center"
                                },
                                { dataField: "role", caption: "ขั้นตอน (Role)" },
                                {
                                    dataField: "approverName", caption: "ผู้ดำเนินการ",
                                    cellTemplate: (container, options) => {
                                        const txt = options.data.approverName || options.data.approverNId || "-";
                                        $("<span>").text(txt).appendTo(container);
                                    }
                                },
                                {
                                    dataField: "actionDate", caption: "วันที่",
                                    alignment: "center", width: 140,
                                    customizeText: (cell) => formatDate(cell.value)
                                },
                                {
                                    dataField: "status", caption: "ผลการพิจารณา",
                                    alignment: "center", width: 120,
                                    cellTemplate: (container, options) => {
                                        const s = mapStatus(options.value);
                                        $("<span>").addClass("status-badge " + s.cls).text(s.text).appendTo(container);
                                    }
                                },
                                { dataField: "comment", caption: "เหตุผล/ความเห็น" }
                            ]
                        }).appendTo(contentElement);
                    }
                }).dxPopup("instance");

                popup.show();
            }

            function renderPageContent(data) {
                // Header
                $("#lblDocNo").text(data.docNo || data.code || "-");
                renderStatusBadge(data.status);

                // Form
                $("#quotationForm").dxForm({
                    formData: data,
                    readOnly: true,
                    colCount: 2,
                    labelLocation: "top",
                    items: [
                        {
                            itemType: "group",
                            caption: "1. ข้อมูลทั่วไป (General Information)",
                            colSpan: 2,
                            colCount: 2,
                            items: [
                                { dataField: "title", label: { text: "หัวข้อ" }, colSpan: 2 },
                                { dataField: "vendorName", label: { text: "ผู้ขาย" }, colSpan: 2 },
                                {
                                    dataField: "validFrom", label: { text: "ยืนราคาตั้งแต่วันที่" },
                                    editorType: "dxDateBox", editorOptions: { displayFormat: "dd/MM/yyyy" }
                                },
                                {
                                    dataField: "validUntil", label: { text: "ถึงวันที่" },
                                    editorType: "dxDateBox", editorOptions: { displayFormat: "dd/MM/yyyy" }
                                },
                                {
                                    dataField: "comment", label: { text: "หมายเหตุ" },
                                    editorType: "dxTextArea", editorOptions: { height: 60, autoResizeEnabled: true }, colSpan: 2
                                }
                            ]
                        },
                        {
                            itemType: "group",
                            caption: "2. เอกสารแนบ (Attachments)",
                            colSpan: 2,
                            items: [{
                                template: (itemData, itemElement) => {
                                    renderAttachmentsGrid(data.quotations || [], itemElement);
                                }
                            }]
                        }
                    ]
                });
            }

            function renderAttachmentsGrid(files, itemElement) {
                const $container = $("<div>").addClass("attachments-container");
                $("<div>").dxDataGrid({
                    dataSource: files,
                    showBorders: true,
                    columnAutoWidth: true,
                    paging: { pageSize: 5 },
                    columns: [
                        {
                            dataField: "fileName", caption: "ชื่อไฟล์",
                            cellTemplate: function (container, options) {
                                $("<div>").addClass("file-info")
                                    .append($("<i>").addClass("fas fa-file-pdf"))
                                    .append($("<span>").text(options.value))
                                    .appendTo(container);
                            }
                        },
                        {
                            dataField: "documentTypeId", caption: "ประเภท", width: 200,
                            lookup: { dataSource: documentTypes, valueExpr: "id", displayExpr: "name" }
                        },
                        {
                            caption: "ดาวน์โหลด", width: 100, alignment: "center",
                            cellTemplate: function(container, options) {
                                $("<button>").addClass("btn btn-sm btn-outline-primary")
                                    .html('<i class="fas fa-download"></i>')
                                    .on("click", () => {
                                        if(options.data.filePath) {
                                            // ปรับ Path ให้ถูกต้อง
                                            let cleanPath = options.data.filePath.replace(/\\/g, "/");
                                            const url = `https://localhost:7127/${cleanPath}`; // หรือดึงจาก CONFIG.API_BASE_URL แต่ตัด /api ออก
                                            window.open(url, '_blank');
                                        }
                                    })
                                    .appendTo(container);
                            }
                        }
                    ]
                }).appendTo($container);
                $container.appendTo(itemElement);
            }

            // === Logic: ตรวจสอบสิทธิ์การอนุมัติ ===
            function checkApprovalPermission(data) {
                // 1. ถ้าเอกสารจบ Process แล้ว (สถานะ Approved/Rejected) ไม่ต้องทำอะไร
                if (data.status === 2 || data.status === 9) return;

                // 2. หา Step ที่สถานะเป็น Pending (1)
                const pendingStep = (data.approvalSteps || []).find(step => step.status === 1);

                // 3. ถ้าพบ Step ที่รออนุมัติ และ 'isCurrentUser' เป็นจริง (Backend ตรวจสอบมาให้แล้ว)
                if (pendingStep && pendingStep.isCurrentUser === true) {

                    const items = toolbarInstance.option("items");

                    const btnReject = items.find(i => i.options && i.options.elementAttr && i.options.elementAttr.id === "btnReject");
                    const btnApprove = items.find(i => i.options && i.options.elementAttr && i.options.elementAttr.id === "btnApprove");

                    // 4. แสดงปุ่ม (Visible: True)
                    if(btnReject) btnReject.visible = true;
                    if(btnApprove) btnApprove.visible = true;

                    toolbarInstance.option("items", items);
                    DevExpress.ui.notify("คุณมีสิทธิ์อนุมัติเอกสารนี้ (Authorized)", "info", 4000);
                }
                // หากไม่ตรงเงื่อนไข ปุ่มจะยังคงซ่อนอยู่ตาม Default
            }

            // === Action Handlers ===
            function handleApprove() {
                DevExpress.ui.dialog.confirm("ยืนยันการอนุมัติ?", "ยืนยัน (Confirm)").done((res) => {
                    if (res) sendApprovalAction("Approve", "");
                });
            }

            function handleReject() {
                const result = DevExpress.ui.dialog.custom({
                    title: "ระบุเหตุผลที่ไม่อนุมัติ",
                    messageHtml: "<div id='rejectReasonBox'></div>",
                    buttons: [
                        { text: "ยืนยัน", type: "danger", onClick: () => "confirm" },
                        { text: "ยกเลิก", onClick: () => "cancel" }
                    ],
                    onShowing: () => {
                        setTimeout(() => {
                             $("#rejectReasonBox").dxTextArea({ height: 100, placeholder: "กรุณาระบุเหตุผล..." });
                        }, 100);
                    }
                });

                result.show().done((dialogResult) => {
                    if (dialogResult === "confirm") {
                        const reason = $("#rejectReasonBox .dx-textarea").dxTextArea("instance").option("value");
                        if(!reason) { DevExpress.ui.notify("กรุณาระบุเหตุผล", "warning", 2000); return; }
                        sendApprovalAction("Reject", reason);
                    }
                });
            }

            async function sendApprovalAction(action, comment) {
                loadingIndicator.show();
                try {
                    const endpoint = (action === 'Approve') ? CONFIG.API_APPROVE : CONFIG.API_REJECT;
                    const payload = { purchaseRequestId: PR_ID, comment: comment };

                    const res = await fetch(CONFIG.API_BASE_URL + endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        credentials: 'include'
                    });

                    if (!res.ok) throw new Error(await res.text());

                    DevExpress.ui.notify(`ดำเนินการสำเร็จ`, "success", 2000);
                    setTimeout(() => location.reload(), 1500);

                } catch (err) {
                    DevExpress.ui.notify("เกิดข้อผิดพลาด: " + err.message, "error", 3000);
                } finally {
                    loadingIndicator.hide();
                }
            }

            // Helpers
            function formatDate(dateStr) {
                if (!dateStr) return "-";
                const d = new Date(dateStr);
                return isNaN(d.getTime()) ? "-" : d.toLocaleDateString('th-TH', {
                    day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute:'2-digit'
                });
            }

            function mapStatus(status) {
                if (status == 0) return { text: 'Draft', cls: 'status-draft' };
                if (status == 1) return { text: 'Pending', cls: 'status-pending' };
                if (status == 2) return { text: 'Approved', cls: 'status-approved' };
                if (status == 9) return { text: 'Rejected', cls: 'status-rejected' };
                return { text: '-', cls: 'status-draft' };
            }

            function renderStatusBadge(status) {
                const s = mapStatus(status);
                $("#statusBadge").removeClass().addClass(`status-badge ${s.cls}`).text(s.text);
            }
        });
    </script>
}